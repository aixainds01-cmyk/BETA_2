<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Sales Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f9fafb;
        }

        /* Form styles remain unchanged */
        .form-container {
            max-width: 960px;
            margin: 2rem auto;
        }

        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: white;
        }

        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
            width: 100%;
            font-size: 0.875rem;
        }

        .input-field:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }

        .btn {
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-link {
            color: #4f46e5;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .item-table-header {
            background-color: #4338ca;
            color: white;
        }

        .item-row {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .hidden-section {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* --- PREVIEW STYLES (ALIGNMENT FIXED) --- */
        #preview-sales-order-page {
            background-color: #f5f5f5;
            padding: 2rem;
        }

        #preview-content {
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 210mm;
            min-height: 267mm;
            /* A4 height minus padding */
            padding: 15mm;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            border-bottom: 4px solid #4338ca;
            padding-bottom: 1rem;
        }

        .invoice-body {
            flex-grow: 1;
            /* This is crucial to push the footer down */
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 2rem;
            margin-bottom: 1.5rem;
        }

        .address-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Items table: fixed layout for predictable column widths */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            /* enforce widths */
            margin-bottom: 2rem;
        }

        .items-table thead {
            background-color: #4338ca;
            color: #ffffff;
        }

        .items-table th,
        .items-table td {
            padding: 0.9rem 1rem;
            font-size: 0.9rem;
            vertical-align: top;
            word-wrap: break-word;
        }

        /* column widths and alignment */
        .items-table th:nth-child(1),
        .items-table td:nth-child(1) {
            width: 52%;
            text-align: left;
        }

        .items-table th:nth-child(2),
        .items-table td:nth-child(2),
        .items-table th:nth-child(3),
        .items-table td:nth-child(3),
        .items-table th:nth-child(4),
        .items-table td:nth-child(4) {
            width: 16%;
            text-align: right;
            /* right-align quantity, rate, amount */
        }

        .items-table tbody tr:nth-child(even) {
            background-color: #f9fafc;
        }

        /* SUMMARY ALIGNMENT FIX */
        .summary-section {
            display: flex;
            justify-content: flex-end;
            /* Align to the right */
            margin-top: 1.5rem;
        }

        .summary-section .summary-box {
            width: 320px;
            max-width: 45%;
        }

        .summary-section table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-section td {
            padding: 6px 6px;
        }

        .summary-section td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .total-row td {
            font-size: 1.25rem;
            font-weight: 700;
            padding-top: 0.75rem;
            border-top: 2px solid #333;
        }

        /* FOOTER */
        .invoice-footer {
            margin-top: 2rem;
            padding-top: 1rem;
            display: flex;
            justify-content: space-between;
            /* This separates left and right content */
            align-items: flex-end;
            border-top: 1px solid #e2e8f0;
        }

        .footer-left {
            width: 65%;
            text-align: left;
        }

        .footer-right {
            width: 30%;
            text-align: center;
        }

        /* Signature: name first, then line, then title; centered */
        .preview-signature {
            text-align: center;
            margin-top: 12px;
        }

        /* Name displayed above the line */
        .signature-name {
            display: block;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 8px;
            /* space before the line */
            font-size: 1rem;
        }

        /* Thin line under the name */
        .signature-hr {
            width: 60%;
            /* adjust length of the line */
            max-width: 240px;
            height: 0;
            border-top: 1px solid #333;
            margin: 0 auto;
            /* center the line */
        }

        /* Title under the line */
        .signature-title {
            display: block;
            margin-top: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #111;
        }



        .logo-preview-container img,
        .logo-preview-container #businessLogoPreview {
            max-width: 160px;
            max-height: 80px;
            object-fit: contain;
        }

        .action-buttons {
            text-align: right;
            width: 210mm;
            margin: 1.5rem auto 0;
        }
@media (max-width: 768px) {
  #main-content {
    margin-top: 64px; /* height of the fixed header */
  }
}

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
            }

            #preview-sales-order-page {
                padding: 0;
            }

            #preview-content {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .action-buttons {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="flex">
        <!-- ✅ MOBILE NAV + SIDEBAR -->
<!-- Mobile Header -->
<!-- ✅ MOBILE HEADER (Fixed on top for mobile) -->
<!-- ✅ MOBILE HEADER (Menu icon on the left) -->
<header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
  <div class="flex items-center space-x-3">
    <button id="menu-toggle" class="text-white focus:outline-none">
      <i class="fas fa-bars text-2xl"></i>
    </button>
    <span class="text-xl font-bold">QSI</span>
  </div>
</header>


<!-- ✅ BACKDROP for mobile -->
<div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

<!-- ✅ SIDEBAR -->
<aside id="sidebar"
  class="w-64 bg-gray-800 text-white h-screen fixed md:h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
  <div class="p-6 text-2xl font-bold border-b border-gray-700">
    <i class="mr-2 text-indigo-400"></i> QSI
  </div>
  <nav class="flex-1 p-4 space-y-2">
    <a href="dashboard_without_login.html"
      class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-indigo-500">
      <i class="fas fa-home mr-3 icon"></i><span class="text">Dashboard</span>
    </a>
    <div>
      <button id="documents-dropdown-btn"
        class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 bg-gray-900 text-left">
        <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
        <i id="dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
      </button>
      <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
        <a href="quotation_without_login.html"
          class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
        <a href="salesorder_withoutlogin.html"
          class="block py-2 px-4 rounded transition duration-200 bg-gray-700 font-semibold text-sm">Sales Order</a>
        <a href="invoice_without_login.html"
          class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
      </div>
    </div>
  </nav>
</aside>


        <div id="main-content" class="content-area flex-1 flex justify-center">
            <div class="w-full max-w-5xl">
                <main id="create-sales-order-page" class="form-container">
                    <form id="sales-order-form">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">
                                Create Sales Order
                            </h1>
                            <div class="flex items-center space-x-2">
                                <button type="submit" id="save-btn" class="btn btn-primary flex items-center">
                                    Preview Order
                                </button>
                            </div>
                        </div>

                        <div class="form-section space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label for="sales-order-no" class="text-gray-600 text-sm">Sales Order No.</label>
<input type="text" id="sales-order-no" class="input-field col-span-2" value="SO0001" required />

                                    </div>
                                    <script>
                                        function updateTime() {
                                            const now = new Date();
                                            const timeString = now.toLocaleTimeString();
                                            document.getElementById("sales-order-time").value =
                                                timeString;
                                        }
                                        updateTime();
                                        setInterval(updateTime, 1000);
                                    </script>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label for="sales-order-date" class="text-gray-600 text-sm">Sales Order
                                            Date</label>
                                        <input type="date" id="sales-order-date" class="input-field col-span-2"
                                            required />
                                    </div>
                                </div>
                                <div id="logo-uploader"
                                    class="border-2 border-dashed rounded-lg flex flex-col items-center justify-center p-4 text-center cursor-pointer hover:bg-gray-50 relative">
                                    <div id="logo-preview-container" class="hidden absolute inset-0 p-2">
                                        <img id="logo-preview" src="" alt="Business Logo Preview"
                                            class="object-contain w-full h-full" />
                                    </div>
                                    <div id="logo-placeholder">
                                        <i class="fas fa-image text-gray-400 text-2xl mb-2"></i>
                                        <span class="text-indigo-600 font-semibold">Add Business Logo</span>
                                    </div>
                                    <input type="file" id="logo-input"
                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                        accept="image/png, image/jpeg" />
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border rounded-lg p-4 space-y-2">
                                    <h3 class="font-semibold text-gray-700">
                                        From
                                        <span class="text-gray-400 text-sm">(Your Details)</span>
                                    </h3>
                                    <div>
                                        <label for="businessName" class="text-sm font-medium text-gray-600">
                                            Business Name
                                        </label>
                                        <input type="text" id="businessName" class="input-field"
                                            placeholder="Your Business Name" required />
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label for="business_city" class="text-sm font-medium text-gray-600">
                                                City
                                            </label>
                                            <input type="text" id="business_city" class="input-field"
                                                placeholder="Your City" required />
                                        </div>
                                        <div>
                                            <label for="business_country" class="text-sm font-medium text-gray-600">
                                                Country
                                            </label>
                                            <input type="text" id="business_country" class="input-field"
                                                placeholder="Your Country" required />
                                        </div>
                                    </div>
                                </div>

                                <div class="border rounded-lg p-4 space-y-2">
                                    <h3 class="font-semibold text-gray-700">
                                        Billed To <span class="text-gray-400 text-sm">(Client's Details)</span>
                                    </h3>
                                    <div>
                                        <label for="clientName" class="text-sm font-medium text-gray-600">
                                            Client Name
                                        </label>
                                        <input type="text" id="clientName" class="input-field"
                                            placeholder="Client's Business Name" required />
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label for="client_city" class="text-sm font-medium text-gray-600">
                                                City
                                            </label>
                                            <input type="text" id="client_city" class="input-field"
                                                placeholder="Client's City" required />
                                        </div>
                                        <div>
                                            <label for="client_country" class="text-sm font-medium text-gray-600">
                                                Country
                                            </label>
                                            <input type="text" id="client_country" class="input-field"
                                                placeholder="Client's Country" required />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-span-2 p-4 rounded-lg border shadow-sm">
                                <div
                                    class="item-table-header grid grid-cols-12 gap-2 p-3 rounded-t-lg text-sm border-b">
                                    <h4 class="col-span-4 font-semibold">Item</h4>
                                    <h4 class="col-span-2 font-semibold text-right">Quantity</h4>
                                    <h4 class="col-span-2 font-semibold text-right">Rate</h4>
                                    <h4 class="col-span-3 font-semibold text-right">Amount</h4>
                                    <h4 class="col-span-1 text-center">--</h4>
                                </div>
                                <div id="items-container" class="space-y-2 py-2"></div>
                                <div class="pt-2">
                                    <button type="button" id="add-item-btn" class="btn-link">
                                        <i class="fas fa-plus mr-1"></i> Add New Line
                                    </button>
                                </div>
                            </div>

                            <div class="w-full mt-4 flex justify-end">
                                <div class="w-80 p-4 rounded-lg border bg-white shadow-sm space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="font-semibold text-gray-800" id="sub_total">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 flex items-center">
                                            Tax (
                                            <input type="number" id="tax-percentage" min="0" max="100"
                                                class="w-16 mx-1 border rounded text-right text-sm px-2 py-1" value=""
                                                placeholder="0" required />%)
                                        </span>
                                        <span class="font-semibold text-gray-800" id="tax">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t-2 border-black pt-2 mt-2">
                                        <span class="font-bold text-lg text-gray-800">Total (INR)</span>
                                        <span class="font-bold text-lg text-gray-800" id="total">₹0.00</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-6 mt-6">
                                <div class="flex-1 space-y-4">
                                    <div class="w-full overflow-x-auto">
                                        <div class="flex flex-nowrap gap-2 mb-4 whitespace-nowrap">
                                            <button type="button"
                                                class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                data-target="terms">
                                                + Terms & Conditions
                                            </button>
                                            <button type="button"
                                                class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                data-target="notes">
                                                + Notes
                                            </button>
                                            <button type="button"
                                                class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                data-target="signature">
                                                + Signature
                                            </button>
                                        </div>
                                    </div>
                                    <div id="terms" class="hidden mt-2">
                                        <label class="block text-sm font-medium text-gray-700">Terms &
                                            Conditions</label>
                                        <textarea class="w-full border rounded p-2 mt-1" rows="3">Payment due within 30 days.
All sales are final.</textarea>
                                    </div>
                                    <div id="notes" class="hidden mt-2">
                                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea class="w-full border rounded p-2 mt-1"
                                            rows="3">Thanks for your business!</textarea>
                                    </div>
                                    <div id="signature" class="hidden mt-2">
                                        <label class="block text-sm font-medium text-gray-700">Signature</label>
                                        <input type="text" id="signature-input" class="w-full border rounded p-2 mt-1"
                                            placeholder="Enter Your Name for Signature" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </main>

                <div id="preview-sales-order-page" class="hidden-section">
                    <div id="preview-content">
                        <header class="invoice-header">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Sales Order</h1>
                                <span class="status"></span>
                            </div>
                            <div class="logo-preview-container">
                                <img id="businessLogoPreview" src="" alt="Business Logo" />
                            </div>
                        </header>

                        <div class="invoice-body">
                            <section class="details-grid">
                                <p><strong>Sales Order #:</strong> <span id="preview-so-no"></span></p>
                                <p><strong>Order Date:</strong> <span id="preview-so-date"></span></p>
                            </section>

                            <section class="address-section">
                                <div>
                                    <h4 class="font-semibold text-gray-500 text-sm mb-1">Billed From</h4>
                                    <p id="preview-from-details" class="text-gray-700"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-500 text-sm mb-1">Billed To</h4>
                                    <p id="preview-to-details" class="text-gray-700"></p>
                                </div>
                            </section>

                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-items-tbody"></tbody>
                            </table>

                            <section class="summary-section">
                                <div class="summary-box">
                                    <table>
                                        <tbody>
                                            <tr>
                                                <td class="text-gray-600 pr-4">Subtotal</td>
                                                <td id="preview-subtotal" class="text-right font-semibold"></td>
                                            </tr>
                                            <tr id="preview-tax-row">
                                                <td class="text-gray-600 pr-4">Tax (<span
                                                        id="preview-tax-rate"></span>%)</td>
                                                <td id="preview-tax" class="text-right font-semibold"></td>
                                            </tr>
                                            <tr class="total-row">
                                                <td><strong>Total (INR)</strong></td>
                                                <td id="preview-total" class="text-right"><strong></strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        </div>

                        <footer class="invoice-footer">
                            <div class="footer-left">
                                <div id="preview-terms-block" class="hidden">
                                    <h3 class="font-semibold mb-1">Terms & Conditions</h3>
                                    <p id="preview-terms" class="text-gray-700 text-sm whitespace-pre-wrap"></p>
                                </div>
                                <div id="preview-notes-block" class="hidden mt-4">
                                    <h3 class="font-semibold mb-1">Notes</h3>
                                    <p id="preview-notes" class="text-gray-700 text-sm whitespace-pre-wrap"></p>
                                </div>
                            </div>
                            <div class="footer-right hidden" id="preview-signature-block">
                                <div class="preview-signature">
                                    <span id="preview-signature-name" class="signature-name"></span>
                                    <div class="signature-hr" aria-hidden="true"></div>
                                    <span class="signature-title">Authorised Signatory</span>
                                </div>
                            </div>


                        </footer>
                    </div>

                    <div class="action-buttons flex justify-end space-x-3 mt-4">
                        <button id="edit-btn" class="btn btn-secondary">Edit</button>
                        <button id="download-pdf-btn" class="btn btn-primary">Download as PDF</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const salesOrderForm = document.getElementById("sales-order-form");
            const itemsContainer = document.getElementById("items-container");
            const addItemBtn = document.getElementById("add-item-btn");
            const taxPercentageInput = document.getElementById("tax-percentage");
            const logoInput = document.getElementById("logo-input");
            const logoPreview = document.getElementById("logo-preview");
            const logoPreviewContainer = document.getElementById("logo-preview-container");
            const logoPlaceholder = document.getElementById("logo-placeholder");
            const businessLogoPreview = document.getElementById("businessLogoPreview");

            logoInput.addEventListener("change", function () {
                const file = logoInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        logoPreview.src = imageUrl;
                        businessLogoPreview.src = imageUrl;
                        logoPreviewContainer.classList.remove("hidden");
                        logoPlaceholder.classList.add("hidden");
                    };
                    reader.readAsDataURL(file);
                }
            });
// ✅ Mobile menu toggle and backdrop
const menuToggle = document.getElementById("menu-toggle");
const sidebar = document.getElementById("sidebar");
const menuBackdrop = document.getElementById("menu-backdrop");

if (menuToggle && sidebar && menuBackdrop) {
  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("-translate-x-full");
    menuBackdrop.classList.toggle("hidden");
  });

  menuBackdrop.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    menuBackdrop.classList.add("hidden");
  });
}


            function createItemRow() {
                const row = document.createElement("div");
                row.className = "item-row space-y-2 p-2 border rounded";
                row.innerHTML = `
                <div class="grid grid-cols-12 gap-2 items-center">
                    <input class="col-span-4 item-name input-field" placeholder="Item Name" required>
                    <input type="number" class="col-span-2 quantity input-field text-right" placeholder="0" min="1" required>
                    <input type="number" class="col-span-2 rate input-field text-right" placeholder="0" min="0" required>
                    <span class="col-span-3 amount text-right font-semibold">₹0.00</span>
                    <button type="button" class="col-span-1 text-red-500 hover:text-red-700 delete-item-btn"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="description input-field col-span-12" rows="1" placeholder="Item description"></textarea>
            `;
                row.querySelector(".quantity").addEventListener("input", () => updateRowAmount(row));
                row.querySelector(".rate").addEventListener("input", () => updateRowAmount(row));
                row.querySelector(".delete-item-btn").addEventListener("click", () => {
                    row.remove();
                    updateTotals();
                });
                itemsContainer.appendChild(row);
            }

            function updateRowAmount(row) {
                const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                const rate = parseFloat(row.querySelector(".rate").value) || 0;
                const amt = qty * rate;
                row.querySelector(".amount").textContent = `₹${amt.toFixed(2)}`;
                updateTotals();
            }

            function updateTotals() {
                let subtotal = 0;
                document.querySelectorAll(".item-row").forEach((row) => {
                    const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                    const rate = parseFloat(row.querySelector(".rate").value) || 0;
                    subtotal += qty * rate;
                });
                const taxP = parseFloat(taxPercentageInput.value) || 0;
                const tax = subtotal * (taxP / 100);
                const total = subtotal + tax;
                document.getElementById("sub_total").textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById("tax").textContent = `₹${tax.toFixed(2)}`;
                document.getElementById("total").textContent = `₹${total.toFixed(2)}`;
            }

            addItemBtn.addEventListener("click", createItemRow);
            taxPercentageInput.addEventListener("input", updateTotals);

            salesOrderForm.addEventListener("submit", (e) => {
                e.preventDefault();

                // Validation for client name
                const clientName = document.getElementById("clientName").value.trim();
                if (!clientName) {
                    alert("Please enter the client's name.");
                    return;
                }

                const items = [...document.querySelectorAll(".item-row")].map(row => {
                    const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                    const rate = parseFloat(row.querySelector(".rate").value) || 0;
                    return {
                        item_name: row.querySelector(".item-name").value,
                        description: row.querySelector(".description").value || "",
                        quantity: qty,
                        rate: rate,
                        amount: qty * rate,
                    };
                });

                if (items.length === 0 || !items.some(i => i.item_name && i.quantity > 0)) {
                    alert("Please add at least one valid item.");
                    return;
                }

                const subTotal = items.reduce((sum, i) => sum + i.amount, 0);
                const taxP = parseFloat(taxPercentageInput.value) || 0;
                const tax = subTotal * (taxP / 100);
                const total = subTotal + tax;

                const formData = {
                    sales_date: document.getElementById("sales-order-date").value,
                    items,
                    sub_total: subTotal,
                    tax,
                    total,
                    tax_percentage: taxP,
                };

                // Populate Preview
                document.getElementById("preview-so-no").textContent = "SO-" + Date.now().toString().slice(-6);
                document.getElementById("preview-so-date").textContent = formData.sales_date;
                document.getElementById("preview-from-details").innerHTML = `${document.getElementById("businessName").value}<br>${document.getElementById("business_city").value}, ${document.getElementById("business_country").value}`;

                // Get client details from manual inputs
                const clientCity = document.getElementById("client_city").value;
                const clientCountry = document.getElementById("client_country").value;
                document.getElementById("preview-to-details").innerHTML = `${clientName}<br>${clientCity}, ${clientCountry}`;

                const tbody = document.getElementById("preview-items-tbody");
                tbody.innerHTML = "";
                formData.items.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                    <td><strong>${item.item_name}</strong><br><small class="text-gray-600">${item.description}</small></td>
                    <td>${item.quantity}</td>
                    <td>₹${item.rate.toFixed(2)}</td>
                    <td>₹${item.amount.toFixed(2)}</td>
                `;
                    tbody.appendChild(tr);
                });

                document.getElementById("preview-subtotal").textContent = `₹${formData.sub_total.toFixed(2)}`;
                document.getElementById("preview-tax-rate").textContent = formData.tax_percentage;
                document.getElementById("preview-tax").textContent = `₹${formData.tax.toFixed(2)}`;
                document.getElementById("preview-total").innerHTML = `<strong>₹${formData.total.toFixed(2)}</strong>`;

                const terms = document.querySelector("#terms textarea").value.trim();
                const notes = document.querySelector("#notes textarea").value.trim();

                if (terms) {
                    document.getElementById("preview-terms-block").classList.remove("hidden");
                    document.getElementById("preview-terms").textContent = terms;
                } else {
                    document.getElementById("preview-terms-block").classList.add("hidden");
                }
                if (notes) {
                    document.getElementById("preview-notes-block").classList.remove("hidden");
                    document.getElementById("preview-notes").textContent = notes;
                } else {
                    document.getElementById("preview-notes-block").classList.add("hidden");
                }

                const signatureFormSection = document.getElementById("signature");
                const signaturePreviewBlock = document.getElementById("preview-signature-block");
                // wherever you set the preview name
                const signatureInputValue = document.getElementById("signature-input").value.trim();
                document.getElementById("preview-signature-name").textContent = signatureInputValue.toUpperCase();

                const previewSignatureName = document.getElementById("preview-signature-name");

                // Show signature in preview if user toggled the signature section open AND there's a value
                if (!signatureFormSection.classList.contains("hidden") && signatureInputValue) {
                    previewSignatureName.textContent = signatureInputValue;
                    signaturePreviewBlock.classList.remove("hidden");
                } else {
                    previewSignatureName.textContent = "";
                    signaturePreviewBlock.classList.add("hidden");
                }

                document.getElementById("create-sales-order-page").classList.add("hidden-section");
                document.getElementById("preview-sales-order-page").classList.remove("hidden-section");
            });

            document.getElementById("edit-btn").addEventListener("click", () => {
                document.getElementById("preview-sales-order-page").classList.add("hidden-section");
                document.getElementById("create-sales-order-page").classList.remove("hidden-section");
            });

            // NEW: PDF downloader that handles multi-page content (doesn't clip footer)
            document.getElementById("download-pdf-btn").addEventListener("click", async () => {
                const element = document.getElementById("preview-content");
                if (!element) return;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF("p", "mm", "a4");

                // Render at moderate scale to balance quality & size
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                const imgWidthMm = pdf.internal.pageSize.getWidth();
                const pageHeightMm = pdf.internal.pageSize.getHeight();

                // Canvas sizes in px
                const canvasW = canvas.width;
                const canvasH = canvas.height;

                // conversion px -> mm based on canvas width vs pdf width in mm
                const pxPerMm = canvasW / imgWidthMm;
                const pageHeightPx = Math.floor(pageHeightMm * pxPerMm);

                let position = 0;
                while (position < canvasH) {
                    const canvasPage = document.createElement("canvas");
                    canvasPage.width = canvasW;
                    const remaining = canvasH - position;
                    canvasPage.height = remaining > pageHeightPx ? pageHeightPx : remaining;
                    const ctx = canvasPage.getContext("2d");

                    // draw the slice from the main canvas
                    ctx.drawImage(canvas, 0, position, canvasW, canvasPage.height, 0, 0, canvasW, canvasPage.height);

                    const imgData = canvasPage.toDataURL("image/png");
                    const imgHeightMm = canvasPage.height / pxPerMm;

                    pdf.addImage(imgData, "PNG", 0, 0, imgWidthMm, imgHeightMm);

                    position += canvasPage.height;
                    if (position < canvasH) pdf.addPage();
                }

                pdf.save(`SalesOrder-${document.getElementById("preview-so-no").textContent}.pdf`);
            });

            // Toggle buttons for terms, notes, etc.
            document.querySelectorAll(".toggle-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const targetEl = document.getElementById(btn.dataset.target);
                    if (targetEl) targetEl.classList.toggle("hidden");
                });
            });

            // Sidebar dropdown
            const dropdownBtn = document.getElementById("documents-dropdown-btn");
            dropdownBtn.addEventListener("click", () => {
                document.getElementById("documents-dropdown-content").classList.toggle("hidden");
                document.getElementById("dropdown-icon").classList.toggle("rotate-180");
            });

            // Initializations
            document.getElementById("sales-order-date").value = new Date().toISOString().slice(0, 10);
            createItemRow();
        });
    </script>

</body>

</html>
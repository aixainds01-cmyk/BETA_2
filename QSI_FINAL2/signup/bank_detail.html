<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Banking & Payment Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f3f4f6;
    }

    .form-container {
      max-width: 600px;
      width: 100%;
    }

    .form-section {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 2.5rem;
      background-color: white;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05),
        0 2px 4px -2px rgb(0 0 0 / 0.05);
    }

    .input-field,
    .select-field {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.625rem 0.875rem;
      transition: all 0.2s ease;
      width: 100%;
      font-size: 0.875rem;
    }

    .input-field:focus,
    .select-field:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.2);
      outline: none;
    }

    .btn {
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      font-size: 0.875rem;
      align-items: center;
      justify-content: center;
      text-align: center;
      display: flex;
      cursor: pointer;
    }

    .btn:disabled {
      background-color: #a5b4fc;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: #4f46e5;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #4338ca;
    }

    .btn-secondary {
      background-color: #f3f4f6;
      color: #374151;
      border-color: #d1d5db;
    }
    .btn-secondary:hover {
      background-color: #e5e7eb;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
  <div class="form-container mt-8">
    <div class="form-section">
      <div class="text-left mb-8">
        <h2 class="text-2xl font-bold text-gray-900">
          Banking & Payment Details
        </h2>
        <p class="text-sm text-gray-500 mt-1">
          Add bank accounts or UPI IDs for your invoices.
        </p>
      </div>

      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Your Saved Accounts</h3>
        <div id="existing-banks-list" class="space-y-3">
          <p class="text-sm text-gray-500">Loading saved accounts...</p>
        </div>
      </div>

      <form id="bank-form" class="space-y-6 pt-6 border-t" novalidate>
        <h3 class="text-lg font-semibold text-gray-800">Add New Payment Method</h3>
        
        <div class="flex items-center gap-6">
          <label class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
            <input type="radio" id="type-bank" name="payment_type" value="bank" class="h-4 w-4 text-indigo-600 border-gray-300" checked>
            <span class="ml-2">Bank Account</span>
          </label>
          <label class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
            <input type="radio" id="type-upi" name="payment_type" value="upi" class="h-4 w-4 text-indigo-600 border-gray-300">
            <span class="ml-2">UPI ID</span>
          </label>
        </div>

        <div id="bank-fields" class="space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="bank_name" class="block text-sm font-semibold text-gray-700 mb-1">Bank Name*</label>
              <input type="text" id="bank_name" name="bank_name" class="input-field" placeholder="e.g., State Bank of India">
            </div>
            <div>
              <label for="account_holder" class="block text-sm font-semibold text-gray-700 mb-1">Account Holder Name*</label>
              <input type="text" id="account_holder" name="account_holder" class="input-field" placeholder="e.g., John Doe">
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="account_number" class="block text-sm font-semibold text-gray-700 mb-1">Account Number*</label>
              <input type="text" id="account_number" name="account_number" class="input-field" placeholder="e.g., 1234567890">
            </div>
            <div>
              <label for="ifsc_code" class="block text-sm font-semibold text-gray-700 mb-1">IFSC Code*</label>
              <input type="text" id="ifsc_code" name="ifsc_code" class="input-field" placeholder="e.g., SBIN0001234">
            </div>
          </div>
        </div>

        <div id="upi-fields" class="space-y-4 hidden">
          <div>
            <label for="upi_id" class="block text-sm font-semibold text-gray-700 mb-1">UPI ID*</label>
            <input type="text" id="upi_id" name="upi_id" class="input-field" placeholder="e.g., yourname@okbank">
          </div>
        </div>

        <div>
          <label for="notes" class="block text-sm font-semibold text-gray-700 mb-1">Notes (Optional)</label>
          <input type="text" id="notes" name="notes" class="input-field" placeholder="e.g., For salary payments">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" id="is_default" name="is_default" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
          <label for="is_default" class="ml-2 block text-sm font-medium text-gray-700">Make this the default payment method</label>
        </div>

        <div class="flex justify-end items-center pt-6 border-t mt-8">
            <button type="submit" id="submit-bank-btn" class="btn btn-primary" style="min-width: 160px">
              Save & Continue
            </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // --- 1. CONFIG & AUTH ---
      const API_BASE_URL = 'http://Aixains-Mac-mini.local:8000/api';
      const BANKS_API_URL = `${API_BASE_URL}/banks`;
      const DASHBOARD_URL = "../with_login/dashboard_with_login.html"; // <-- Destination after skip/save

      function getAuthHeaders() {
        const token = localStorage.getItem("token");
        if (token) return { 'Authorization': `Bearer ${token}` };
        return null;
      }

      async function safeFetch(url, opts = {}) {
        opts = opts || {};
        opts.headers = Object.assign({}, opts.headers || {});
        const authHeaders = getAuthHeaders();

        if (!authHeaders) {
          alert("Authentication token not found. Please log in.");
          window.location.href = '/login.html'; // Adjust login path
          throw new Error("Authentication token not found.");
        }
        opts.headers = { ...opts.headers, ...authHeaders };

        if (opts.body && typeof opts.body === 'string' && !opts.headers["Content-Type"]) {
          opts.headers["Content-Type"] = "application/json";
        }
        if (!opts.mode) opts.mode = 'cors';

        try {
          const res = await fetch(url, opts);
          const text = await res.text();
          let data;
          try { data = text ? JSON.parse(text) : null; } catch (e) { data = text; }

          if (!res.ok) {
            if (res.status === 401) {
              alert("Session expired or invalid. Please log in again.");
              localStorage.removeItem('token');
              localStorage.removeItem('userId');
              window.location.href = '/login.html';
              throw new Error("Session expired");
            }
            const errMsg = (data && data.message) || (typeof data === "string" ? data : res.statusText) || "Request failed";
            const error = new Error(errMsg);
            error.status = res.status;
            error.data = data;
            throw error;
          }
          return data;
        } catch (err) {
          if (err.message !== 'Authentication token not found' && err.message !== 'Session expired') {
            throw err;
          }
          throw new Error("Authentication required");
        }
      }

      // --- 2. ELEMENT REFS ---
      const bankForm = document.getElementById("bank-form");
      const submitBankBtn = document.getElementById("submit-bank-btn");
      const existingBanksList = document.getElementById("existing-banks-list");
      const typeBankRadio = document.getElementById("type-bank");
      const typeUpiRadio = document.getElementById("type-upi");
      const bankFieldsDiv = document.getElementById("bank-fields");
      const upiFieldsDiv = document.getElementById("upi-fields");

      // --- 3. RENDER/LOAD FUNCTIONS ---
      function renderBankList(banks) {
        if (!existingBanksList) return;
        existingBanksList.innerHTML = '';
        
        if (!banks || banks.length === 0) {
          existingBanksList.innerHTML = '<p class="text-sm text-gray-500">No payment details saved yet.</p>';
          return;
        }

        banks.forEach(bank => {
          const div = document.createElement('div');
          div.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center';
          
          let content = '';
          if (bank.type === 'Bank' && bank.bank_name) {
            content = `
              <div>
                <div class="font-semibold text-sm text-gray-800">${bank.bank_name}</div>
                <div class="text-xs text-gray-500">A/C: ...${(bank.account_number || '').slice(-4)} (${bank.account_holder})</div>
              </div>`;
          } else if (bank.type === 'UPI' && bank.upi_id) {
            content = `
              <div>
                <div class="font-semibold text-sm text-gray-800">UPI ID</div>
                <div class="text-xs text-gray-500">${bank.upi_id}</div>
              </div>`;
          }
          
          div.innerHTML = content;

          if (bank.is_default) {
            const badge = document.createElement('span');
            badge.className = 'text-xs font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded-full';
            badge.textContent = 'Default';
            div.appendChild(badge);
          }
          existingBanksList.appendChild(div);
        });
      }

      async function loadExistingBanks() {
        if (!existingBanksList) return;
        existingBanksList.innerHTML = '<p class="text-sm text-gray-500">Loading saved accounts...</p>';
        try {
          const banks = await safeFetch(BANKS_API_URL, { method: 'GET' });
          renderBankList(banks);
        } catch (err) {
          console.error('Failed to load banks:', err);
          if (err.message !== "Authentication required") {
            existingBanksList.innerHTML = `<p class="text-sm text-red-500">Failed to load accounts: ${err.message}</p>`;
          }
        }
      }

      // --- 4. EVENT LISTENERS ---
      function toggleFields(type) {
        if (type === 'bank') {
          bankFieldsDiv.classList.remove('hidden');
          upiFieldsDiv.classList.add('hidden');
        } else if (type === 'upi') {
          bankFieldsDiv.classList.add('hidden');
          upiFieldsDiv.classList.remove('hidden');
        }
      }

      typeBankRadio.addEventListener('change', () => toggleFields('bank'));
      typeUpiRadio.addEventListener('change', () => toggleFields('upi'));

      // Bank Form Submit Logic
      bankForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        submitBankBtn.innerHTML = "Saving...";
        submitBankBtn.disabled = true;

        const formData = new FormData(bankForm);
        const data = Object.fromEntries(formData.entries());
        const paymentType = data.payment_type;

        const payload = {
          notes: data.notes || null,
          is_default: data.is_default === 'on'
        };

        if (paymentType === 'bank') {
          payload.bank_name = data.bank_name;
          payload.account_holder = data.account_holder;
          payload.account_number = data.account_number;
          payload.ifsc_code = data.ifsc_code;

          if (!payload.bank_name || !payload.account_holder || !payload.account_number || !payload.ifsc_code) {
            alert("Please fill in all four bank fields.");
            submitBankBtn.innerHTML = "Save & Continue";
            submitBankBtn.disabled = false;
            return;
          }
        } else if (paymentType === 'upi') {
          payload.upi_id = data.upi_id;
          if (!payload.upi_id) {
            alert("Please enter a UPI ID.");
            submitBankBtn.innerHTML = "Save & Continue";
            submitBankBtn.disabled = false;
            return;
          }
        }

        try {
          const result = await safeFetch(BANKS_API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          
          alert(result.message || 'Details saved!');
          window.location.replace(DASHBOARD_URL); // Go to dashboard on success

        } catch (err) {
          console.error('Save bank error:', err);
          alert(`Error: ${err.message}`);
        } finally {
          submitBankBtn.innerHTML = "Save & Continue";
          submitBankBtn.disabled = false;
        }
      });

      // --- 5. INITIAL LOAD ---
      loadExistingBanks();
    });
  </script>

</body>

</html>
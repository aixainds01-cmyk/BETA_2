<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Credit Notes - QSI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f9fafb;
    }

    .table-header-cell {
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      background-color: #f9fafb;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .table-body-cell {
      padding: 1rem 1rem;
      font-size: 0.875rem;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @media (max-width: 768px) {
      #main-content {
        margin-top: 64px;
      }
    }
  </style>
</head>

<body>
  <div class="flex">
    <!-- Mobile Top Bar -->
    <header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
      <div class="flex items-center space-x-3">
        <button id="menu-toggle" class="text-white focus:outline-none">
          <i class="fas fa-bars text-2xl"></i>
        </button>
        <span class="text-xl font-bold">QSI</span>
      </div>
    </header>

    <!-- Backdrop -->
    <div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
      class="w-64 bg-gray-800 text-white h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
      <div class="p-6 text-2xl font-bold border-b border-gray-700">
        <i class="mr-2 text-indigo-400"></i> QSI
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="./dashboard_with_login.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-chart-pie mr-3"></i>Dashboard
        </a>
        <div>
          <button id="documents-dropdown-btn" class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
            <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
            <i id="dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
          </button>
          <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
            <a href="./quotation/home_quotation.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
            <a href="./saleorder/home_sales_order.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales Order</a>
            <a href="./invoice/home_invoice.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
            <a href="credit_note.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit note</a>
          </div>
          <div>
            <button id="purchases-dropdown-btn" class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
              <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
              <i id="purchases-dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
            </button>
            <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
              <a href="parchase/vendor/vendors_leads.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors Leads</a>
              <a href="parchase/parchase_order/home_purchase_orders.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase Orders</a>
              <a href="parchase/debit notes/debit_notes.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Debit Notes</a>
            </div>
          </div>
        </div>
        <a href="manage-clients.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-users mr-3"></i>Manage Clients
        </a>
        <a href="settings.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-cog mr-3"></i>Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div id="main-content" class="flex-1 overflow-y-auto p-8">
      <header class="mb-6">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-receipt text-indigo-600 mr-3"></i>
              Credit Notes
            </h1>
            <p class="text-sm text-gray-500 mt-1">Outstanding invoices requiring payment or partial payment</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">Total Outstanding</div>
            <div id="total-outstanding" class="text-2xl font-bold text-red-600">₹0.00</div>
          </div>
        </div>
      </header>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Unpaid Invoices</p>
              <p id="unpaid-count" class="text-2xl font-bold text-orange-600">0</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-full">
              <i class="fas fa-exclamation-circle text-orange-600 text-xl"></i>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Partially Paid</p>
              <p id="partial-count" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-chart-pie text-blue-600 text-xl"></i>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 mb-1">Total Pending</p>
              <p id="total-pending" class="text-2xl font-bold text-red-600">₹0.00</p>
            </div>
            <div class="bg-red-100 p-3 rounded-full">
              <i class="fas fa-wallet text-red-600 text-xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-800">Outstanding Invoices</h2>
            <span id="invoice-count-badge" class="px-3 py-1 bg-indigo-100 text-indigo-800 text-sm font-semibold rounded-full">
              0 Invoices
            </span>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="table-header-cell text-left">Invoice No.</th>
                <th class="table-header-cell text-left">Client Name</th>
                <th class="table-header-cell text-left">Invoice Date</th>
                <th class="table-header-cell text-left">Status</th>
                <th class="table-header-cell text-right">Total Amount</th>
                <th class="table-header-cell text-right">Paid Amount</th>
                <th class="table-header-cell text-right">Pending Amount</th>
              </tr>
            </thead>
            <tbody id="credit-notes-table-body" class="divide-y divide-gray-200 bg-white">
              <!-- Data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Mobile menu
      const menuToggle = document.getElementById("menu-toggle");
      const sidebar = document.getElementById("sidebar");
      const menuBackdrop = document.getElementById("menu-backdrop");

      if (menuToggle && sidebar && menuBackdrop) {
        menuToggle.addEventListener("click", () => {
          sidebar.classList.toggle("-translate-x-full");
          menuBackdrop.classList.toggle("hidden");
        });

        menuBackdrop.addEventListener("click", () => {
          sidebar.classList.add("-translate-x-full");
          menuBackdrop.classList.add("hidden");
        });
      }

      // Dropdowns
      const dropdownBtn = document.getElementById('documents-dropdown-btn');
      const dropdownContent = document.getElementById('documents-dropdown-content');
      const dropdownIcon = document.getElementById('dropdown-icon');
      if (dropdownBtn) {
        dropdownBtn.addEventListener('click', () => {
          dropdownContent.classList.toggle('hidden');
          dropdownIcon.classList.toggle('rotate-180');
        });
      }

      const purchasesDropdownBtn = document.getElementById('purchases-dropdown-btn');
      const purchasesDropdownContent = document.getElementById('purchases-dropdown-content');
      const purchasesDropdownIcon = document.getElementById('purchases-dropdown-icon');
      if (purchasesDropdownBtn) {
        purchasesDropdownBtn.addEventListener('click', () => {
          purchasesDropdownContent.classList.toggle('hidden');
          purchasesDropdownIcon.classList.toggle('rotate-180');
        });
      }

      // API setup
      const API_BASE_URL = "http://Aixains-Mac-mini.local:8000/api";

      function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return token ? { 'Authorization': `Bearer ${token}` } : null;
      }

      async function fetchJsonAndParse(url, opts = {}) {
        opts.headers = opts.headers || {};
        const authHeaders = getAuthHeaders();
        if (!authHeaders) {
          alert("Authentication token not found. Please log in.");
          window.location.href = '../index.html';
          throw new Error("Authentication token not found.");
        }
        opts.headers = { ...opts.headers, ...authHeaders };

        const response = await fetch(url, opts);
        if (!response.ok) {
          if (response.status === 401) {
            alert("Session expired. Please log in again.");
            localStorage.removeItem('token');
            window.location.href = '../index.html';
            throw new Error("Session expired");
          }
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      }

      // Formatting
      const formatCurrency = (amount) => {
        return `₹${Number(amount || 0).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '—';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch {
          return dateStr;
        }
      };

      const getStatusBadge = (status) => {
        const s = (status || 'unpaid').toLowerCase().trim();
        
        if (s === 'unpaid') {
          return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">Unpaid</span>';
        }
        
        if (s.includes('partial')) {
          return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Partially Paid</span>';
        }
        
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>';
      };

      // Rendering
      const tableBody = document.getElementById('credit-notes-table-body');

      function renderInvoices(invoices) {
        tableBody.innerHTML = '';
        
        // Filter only unpaid and partially paid
        const filteredInvoices = invoices.filter(inv => {
          const status = (inv.status || 'unpaid').toLowerCase().trim();
          return status === 'unpaid' || status.includes('partial');
        });

        if (filteredInvoices.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="table-body-cell text-center py-10">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                <p class="text-gray-500">No outstanding invoices found. All invoices are paid!</p>
              </td>
            </tr>`;
          updateSummary([], []);
          return;
        }

        let unpaidInvoices = [];
        let partialInvoices = [];

        filteredInvoices.forEach((inv) => {
          const status = (inv.status || 'unpaid').toLowerCase().trim();
          const invoiceNo = inv.invoice_no || '—';
          const clientName = inv.to?.client_name || '—';
          const date = formatDate(inv.date);
          const total = inv.total || 0;
          const paid = inv.paid_amount || 0;
          const pending = Math.max(total - paid, 0);

          if (status === 'unpaid') {
            unpaidInvoices.push({ total, paid, pending });
          } else if (status.includes('partial')) {
            partialInvoices.push({ total, paid, pending });
          }

          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 transition';
          row.innerHTML = `
            <td class="table-body-cell">
              <span class="font-semibold text-gray-800">${invoiceNo}</span>
            </td>
            <td class="table-body-cell">
              <span class="text-gray-700">${clientName}</span>
            </td>
            <td class="table-body-cell">
              <span class="text-gray-600">${date}</span>
            </td>
            <td class="table-body-cell">
              ${getStatusBadge(status)}
            </td>
            <td class="table-body-cell text-right">
              <span class="font-semibold text-gray-800">${formatCurrency(total)}</span>
            </td>
            <td class="table-body-cell text-right">
              <span class="text-green-600 font-medium">${formatCurrency(paid)}</span>
            </td>
            <td class="table-body-cell text-right">
              <span class="font-bold text-red-600">${formatCurrency(pending)}</span>
            </td>
          `;
          tableBody.appendChild(row);
        });

        updateSummary(unpaidInvoices, partialInvoices);
        document.getElementById('invoice-count-badge').textContent = `${filteredInvoices.length} Invoice${filteredInvoices.length !== 1 ? 's' : ''}`;
      }

      function updateSummary(unpaidInvoices, partialInvoices) {
        const unpaidTotal = unpaidInvoices.reduce((sum, inv) => sum + inv.pending, 0);
        const partialTotal = partialInvoices.reduce((sum, inv) => sum + inv.pending, 0);
        const totalPending = unpaidTotal + partialTotal;

        document.getElementById('unpaid-count').textContent = unpaidInvoices.length;
        document.getElementById('partial-count').textContent = partialInvoices.length;
        document.getElementById('total-pending').textContent = formatCurrency(totalPending);
        document.getElementById('total-outstanding').textContent = formatCurrency(totalPending);
      }

      async function loadInvoices() {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="table-body-cell text-center py-10">
              <div class="inline-block w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
              <p class="text-gray-500 mt-2">Loading invoices...</p>
            </td>
          </tr>`;
        
        try {
          const data = await fetchJsonAndParse(`${API_BASE_URL}/invoic`);
          renderInvoices(Array.isArray(data) ? data : []);
        } catch (err) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="table-body-cell text-center py-10">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-2"></i>
                <p class="text-red-600 font-medium">Failed to load credit notes</p>
                <p class="text-gray-500 text-sm">${err.message}</p>
              </td>
            </tr>`;
        }
      }

      loadInvoices();
    });
  </script>
</body>

</html>
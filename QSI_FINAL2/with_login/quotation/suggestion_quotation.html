<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suggested Quotations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        /* Styles from your provided file */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        /* Popover styles (kept from your reference file) */
        .popover-menu {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            max-width: 220px;
            background: #ffffff;
            border: 1px solid #e6e7eb;
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.08);
            border-radius: 8px;
            padding: 6px 8px;
            z-index: 9999;
            overflow: visible;
            white-space: nowrap;
            font-size: 13px;
        }

        .popover-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-align: left;
            padding: 6px 8px;
            font-size: 13px;
            color: #111827;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 120ms ease;
        }

        .popover-item i {
            font-size: 14px;
            color: #6b7280;
            width: 16px;
            text-align: center;
        }

        .popover-item:hover {
            background: #f3f4f6;
            color: #111827;
        }
        @media (max-width: 768px) {
  #main-content {
    margin-top: 64px; /* height of the fixed header */
  }
}
    </style>
</head>

<body>
    <div class="flex">
        <header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
  <div class="flex items-center space-x-3">
    <button id="menu-toggle" class="text-white focus:outline-none">
      <i class="fas fa-bars text-2xl"></i>
    </button>
    <span class="text-xl font-bold">QSI</span>
  </div>
</header>


<!-- ‚úÖ BACKDROP for mobile -->
<div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

<!-- ‚úÖ SIDEBAR -->
<aside id="sidebar"
  class="w-64 bg-gray-800 text-white h-screen fixed md:h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
            <div class="p-6 text-2xl font-bold border-b border-gray-700">
                <i class=" mr-2 text-indigo-400"></i> QSI
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="../dashboard_with_login.html"
                    class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-chart-pie mr-3"></i>Dashboard
                </a>
                <div>
                    <button id="documents-dropdown-btn"
                        class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                        <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
                        <i id="dropdown-icon"
                            class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1">
                        <a href="home_quotation.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
                        <a href="../saleorder/home_sales_order.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales
                            Order</a>
                        <a href="../invoice/home_invoice.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
                            <a href="../credit_note.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit note</a>
                    </div>
                    <div>
                        <button id="purchases-dropdown-btn"
                            class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                            <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
                            <i id="purchases-dropdown-icon"
                                class="fas fa-chevron-down transform transition-transform duration-200"></i>
                        </button>
                        <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
                            <a href="../parchase/vendor/vendors_leads.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors Leads</a>
                            <a href="../parchase/parchase_order/home_purchase_orders.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase Orders</a>
                            <a href="../parchase/debit notes/debit_notes.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Debit Notes</a>
                        </div>
                    </div>
                </div>
                <a href="../manage-clients.html"
                    class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-users mr-3"></i>Manage Clients
                </a>
                <a href="../settings.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-cog mr-3"></i>Settings
                </a>
            </nav>
        </aside>

        <div id="main-content" class="flex-1 overflow-y-auto p-8">
            <div id="session-banner" style="display:none; position:sticky; top:0; z-index:40; margin-bottom:12px;">
                <div style="background:#fff7ed; border:1px solid #ffedd5; color:#92400e; padding:10px 14px; border-radius:8px; max-width:760px;">
                    <strong id="session-banner-text">Session expired. Please log in again.</strong>
                    <a id="session-banner-login" href="../../index.html" style="margin-left:12px; color:#4f46e5; font-weight:600;">Go to login</a>
                </div>
            </div>

            <header class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">Quotation Action Center</h1>
                    <a href="create_quotation.html"
                        class="bg-purple-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-700 transition duration-200">
                        <i class="fas fa-plus mr-2"></i> Create New Quotation
                    </a>
                </div>
                <nav class="flex items-center space-x-6 border-b">
                    <a href="home_quotation.html" class="py-2 text-sm font-medium text-gray-600 hover:text-gray-900">Overview</a>
                    <a href="#" class="py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">Suggested
                        Quotation</a>
                    
                </nav>
            </header>

            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Actionable Suggestions</h2>
                    <div class="flex items-center space-x-2">
                        <button class="px-3 py-1.5 text-sm font-semibold text-indigo-700 bg-indigo-100 rounded-md">All</button>
                        <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Expiring Soon</button>
                        <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Needs Conversion</button>
                        <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Drafts</button>
                    </div>
                </div>

                <div id="suggestion-container" class="space-y-4">
                    <p class="text-gray-500">Loading suggestions...</p>

                    </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Sidebar dropdown logic (Copied from your code) ---
        const dropdownBtn = document.getElementById('documents-dropdown-btn');
        const dropdownContent = document.getElementById('documents-dropdown-content');
        const dropdownIcon = document.getElementById('dropdown-icon');
        // Auto-open the sales docs dropdown since we are on a child page
        dropdownContent.classList.remove('hidden');
        dropdownIcon.classList.add('rotate-180');
        
        dropdownBtn.addEventListener('click', () => {
            dropdownContent.classList.toggle('hidden');
            dropdownIcon.classList.toggle('rotate-180');
        });

        document.getElementById('purchases-dropdown-btn').addEventListener('click', () => {
            document.getElementById('purchases-dropdown-content').classList.toggle('hidden');
            document.getElementById('purchases-dropdown-icon').classList.toggle('rotate-180');
        });

        // --- Elements & API Config ---
        const container = document.getElementById('suggestion-container');
        const API_BASE_URL = 'http://Aixains-Mac-mini.local:8000/api';
        const QUOTATION_API_URL = `${API_BASE_URL}/quotation`; // GET: /api/quotation

        // -----------------------------------------------------------------
        // --- 1. AUTHENTICATION & API FUNCTIONS (Copied from your code) ---
        // -----------------------------------------------------------------
        const menuToggle = document.getElementById("menu-toggle");
const sidebar = document.getElementById("sidebar");
const menuBackdrop = document.getElementById("menu-backdrop");

if (menuToggle && sidebar && menuBackdrop) {
  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("-translate-x-full");
    menuBackdrop.classList.toggle("hidden");
  });

  menuBackdrop.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    menuBackdrop.classList.add("hidden");
  });
}
        function getAuthHeaders() {
            const token = localStorage.getItem("token");
            if (!token) {
                return null;
            }
            return { 'Authorization': `Bearer ${token}` };
        }

        async function fetchJsonAndParse(url, opts = {}) {
            opts.headers = opts.headers || {};
            const authHeaders = getAuthHeaders();
            
            if (!authHeaders) {
                const banner = document.getElementById('session-banner');
                const bannerText = document.getElementById('session-banner-text');
                if (banner && bannerText) {
                    bannerText.textContent = 'Session expired. Please log in again.';
                    banner.style.display = 'block';
                }
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                setTimeout(() => { window.location.href = '../../index.html'; }, 1200);
                throw new Error('No auth token');
            }
            opts.headers = { ...opts.headers, ...authHeaders };

            if (opts.body && typeof opts.body === 'string' && !opts.headers['Content-Type']) {
                opts.headers = { ...opts.headers, 'Content-Type': 'application/json' };
            }

            const response = await fetch(url, opts);

            if (!response.ok) {
                if (response.status === 401) {
                    const banner = document.getElementById('session-banner');
                    const bannerText = document.getElementById('session-banner-text');
                    if (banner && bannerText) {
                        bannerText.textContent = 'Session expired. Please log in again.';
                        banner.style.display = 'block';
                    }
                    localStorage.removeItem('token');
                    localStorage.removeItem('userId');
                    setTimeout(() => { window.location.href = '../../index.html'; }, 1800);
                }
                const errorText = await response.text().catch(() => response.statusText);
                const error = new Error(`HTTP ${response.status}: ${errorText}`);
                error.status = response.status;
                throw error;
            }

            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return response.json();
            }
            const text = await response.text();
            try { return JSON.parse(text); } catch (e) { return text; }
        }

        // --- 2. SUGGESTION LOGIC (from previous answer, adapted) ---

        /**
         * Calculates the difference in days between two dates.
         */
        function daysDifference(date1, date2) {
            const diffTime = date2.getTime() - date1.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        /**
         * Formats a number as INR currency.
         */
        function formatCurrency(value) {
            const num = Number(value) || 0;
            try {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num);
            } catch (e) { return '‚Çπ' + num.toFixed(2); }
        }

        /**
         * Processes the raw quote data and generates actionable suggestions.
         * NOTE: Assumes your API response includes `status` and `expiry_date`.
         */
        function generateSuggestions(quotes) {
            const today = new Date();
            const suggestions = [];

            for (const quote of quotes) {
                // Skip if key data is missing
                if (!quote.status || !quote.expiry_date || !quote.quotation_date) {
                    console.warn("Skipping quote, missing data for suggestion:", quote.quotation_no);
                    continue;
                }
                
                const expiryDate = new Date(quote.expiry_date);
                const createdDate = new Date(quote.quotation_date);

                // Suggestion 1: Accepted quotes
                if (quote.status === 'accepted') {
                    suggestions.push({
                        type: 'accepted',
                        icon: '‚ú®',
                        title: 'Convert Accepted Quote',
                        suggestion: 'The customer has <strong>accepted</strong> this quote.',
                        primaryAction: 'Convert to Sales Order',
                        quote: quote
                    });
                }
                // Suggestion 2: Expiring soon
                else if (quote.status === 'sent') {
                    const daysLeft = daysDifference(today, expiryDate);
                    if (daysLeft <= 3 && daysLeft > 0) {
                        suggestions.push({
                            type: 'expiring',
                            icon: '‚è∞',
                            title: 'Follow up on Expiring Quote',
                            suggestion: `This quote expires in <strong>${daysLeft} day(s)</strong>. Follow up to secure the sale.`,
                            primaryAction: 'Send Follow-up',
                            quote: quote
                        });
                    }
                }
                // Suggestion 3: Old drafts
                else if (quote.status === 'draft') {
                    const daysOld = daysDifference(createdDate, today);
                    if (daysOld >= 5) {
                         suggestions.push({
                            type: 'draft',
                            icon: 'üìù',
                            title: 'Finalize Draft Quote',
                            suggestion: `This draft was created <strong>${daysOld} days ago</strong> and hasn't been sent.`,
                            primaryAction: 'Edit & Send',
                            quote: quote
                        });
                    }
                }
            }
            return suggestions;
        }

        /**
         * Renders the suggestion cards to the DOM using Tailwind classes.
         */
        function renderSuggestions(suggestions) {
            container.innerHTML = ''; // Clear loading message

            if (suggestions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No suggestions right now. You\'re all caught up!</p>';
                return;
            }

            // Define card styles based on type
            const cardStyles = {
                accepted: { border: 'border-green-500', icon: '‚ú®', iconColor: 'text-green-600' },
                expiring: { border: 'border-yellow-500', icon: '‚è∞', iconColor: 'text-yellow-600' },
                draft:    { border: 'border-blue-500',   icon: 'üìù', iconColor: 'text-blue-600' }
            };

            // Loop through suggestions and build HTML
            suggestions.forEach(s => {
                const style = cardStyles[s.type] || { border: 'border-gray-300', icon: '?', iconColor: 'text-gray-600' };
                const q = s.quote;
                
                const cardHTML = `
                    <div class="flex bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden border-l-4 ${style.border}">
                        <div class="text-2xl p-6 flex items-center justify-center bg-gray-50 ${style.iconColor}">${style.icon}</div>
                        <div class="flex-grow p-5">
                            <h3 class="text-lg font-semibold text-gray-800">${s.title}</h3>
                            <div class="text-sm text-gray-600 leading-relaxed mt-1">
                                <strong>Quote:</strong> ${q.quotation_no}<br>
                                <strong>Customer:</strong> ${q.to?.client_name || 'N/A'}<br>
                                <strong>Value:</strong> ${formatCurrency(q.total)}
                            </div>
                            <div class="text-sm text-gray-900 mt-3">${s.suggestion}</div>
                        </div>
                        <div class="flex flex-col justify-center p-5 space-y-2">
                            <button class="px-4 py-2 text-sm font-medium rounded-md text-center bg-purple-600 text-white hover:bg-purple-700">${s.primaryAction}</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-md text-center bg-white border border-gray-300 text-gray-700 hover:bg-gray-50">View Quote</button>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }

        /**
         * Main function to fetch data and run the process.
         */
        async function loadSuggestions() {
            try {
                // Use the authenticated fetch wrapper
                const json = await fetchJsonAndParse(QUOTATION_API_URL);
                if (!json) {
                    container.innerHTML = '<p class="text-red-600">Error: Could not authenticate.</p>';
                    return;
                }
                
                // Unpack data from common API response envelopes
                let quotes = Array.isArray(json) ? json
                         : Array.isArray(json.data) ? json.data
                         : Array.isArray(json.quotations) ? json.quotations
                         : [];

                // 1. Process data to find suggestions
                const suggestions = generateSuggestions(quotes);
                
                // 2. Render the suggestions to the page
                renderSuggestions(suggestions);

            } catch (error) {
                console.error('Failed to load suggestions:', error);
                container.innerHTML = Example
                    `<p class="text-red-600">Error: Could not load suggestions. ${error.message}</p>`;
            }
        }

        // --- 3. Run the app ---
        loadSuggestions();

    });
    </script>
</body>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quotation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8f9fa;
      /* Lighter background */
    }

    .sidebar-link.active {
      background-color: #4f46e5;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .table-header-cell {
      @apply px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
    }

    .table-body-cell {
      @apply px-4 py-4 whitespace-nowrap text-sm;
    }

    tr.row-active {
      position: relative;
      z-index: 10;
    }
@media (max-width: 768px) {
  #main-content {
    margin-top: 64px; /* height of the fixed header */
  }
}
    #table-container.overflow-visible {
      overflow: visible;
    }
  </style>
</head>

<body>
  <div class="flex">
   <header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
  <div class="flex items-center space-x-3">
    <button id="menu-toggle" class="text-white focus:outline-none">
      <i class="fas fa-bars text-2xl"></i>
    </button>
    <span class="text-xl font-bold">QSI</span>
  </div>
</header>


<div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

<aside id="sidebar"
  class="w-64 bg-gray-800 text-white h-screen fixed md:h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
    <div class="p-6 text-2xl font-bold border-b border-gray-700">
        <i class=" mr-2 text-indigo-400"></i> QSI
    </div>
    <nav class="flex-1 p-4 space-y-2">
        <a href="../dashboard_with_login.html"
            class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
            <i class="fas fa-chart-pie mr-3"></i>Dashboard
        </a>
        <div>
            <button id="documents-dropdown-btn"
                class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
                <i id="dropdown-icon"
                    class="fas fa-chevron-down transform transition-transform duration-200"></i>
            </button>
            <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
                <a href="home_quotation.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
                <a href="../saleorder/home_sales_order.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales
                    Order</a>
                <a href="../invoice/home_invoice.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
                    <a href="../credit_note.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit note</a>
            </div>
            <div>
                <button id="purchases-dropdown-btn"
                    class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                    <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
                    <i id="purchases-dropdown-icon"
                        class="fas fa-chevron-down transform transition-transform duration-200"></i>
                </button>
                <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
                    <a href="../parchase/vendor/vendors_leads.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors Leads</a>
                        <a href="../parchase/parchase_order/home_purchase_orders.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase Orders</a>
                    <a href="../parchase/debit notes/debit_notes.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Debit Notes</a>
                    </div>
            </div>
        </div>
        <a href="../manage-clients.html"
            class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
            <i class="fas fa-users mr-3"></i>Manage Clients
        </a>
        <a href="../settings.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
            <i class="fas fa-cog mr-3"></i>Settings
        </a>
    </nav>
</aside>
<div id="main-content" class="flex-1 overflow-y-auto p-8">
    <header class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">Quotation</h1>
                    <a href="create_quotation.html"
                        class="bg-purple-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-700 transition duration-200">
                        <i class="fas fa-plus mr-2"></i> Create New Quotation
                    </a>
                </div>
                <nav class="flex items-center space-x-6 border-b">
                    <a href="#"
                        class="py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">Overview</a>
                    <a href="suggestion_quotation.html" class="py-2 text-sm font-medium text-gray-600 hover:text-gray-900">Suggested
                        Quotation</a>
                </nav>
            </header>

      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="flex items-center space-x-4 border-b pb-4 mb-4">
          
            <button id="active-quotation-btn" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md shadow-sm">Active
              Quotation</button>
            
            <button id="deleted-quotation-btn" class="px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Deleted Quotation</button>
          
          
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
          <div>
            <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Select Status</label>
            <select id="filter-status"
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
              <option value="all">All</option>
<option value="Pending">Pending</option>
<option value="Approved">Approved</option>

            </select>
          </div>
          <div>
            <label for="filter-client" class="block text-sm font-medium text-gray-700 ">Select Client</label>
            <select id="filter-client"
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
              <option>All Clients</option>
            </select>
          </div>
          <div>
            <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1">Select date</label>
            <input type="date" id="filter-date" placeholder="mm/dd/yyyy"
              class="mt-1 block w-full border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
          </div>
        </div>
<div id="selection-bar"
  class="hidden flex items-center justify-between bg-indigo-50 border border-indigo-200 text-indigo-700 px-4 py-2 rounded-md mb-3 transition-all duration-300">
  <div class="flex items-center gap-3">
    <button id="close-selection-bar" class="text-gray-500 hover:text-gray-700 text-lg">
      <i class="fas fa-times"></i>
    </button>
    <span id="selected-count" class="font-medium">0 selected</span>
  </div>
  
  <div class="flex gap-2">
    <button id="delete-selected"
      class="hidden bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-md">
      <i class="fas fa-trash mr-2"></i> Delete Selected
    </button>
    <div id="deleted-view-buttons" class="hidden flex gap-2">
      <button id="restore-selected"
        class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-4 py-2 rounded-md">
        <i class="fas fa-undo mr-2"></i> Restore
      </button>
      <button id="permanent-delete-selected"
        class="bg-red-800 hover:bg-red-900 text-white text-sm font-medium px-4 py-2 rounded-md">
        <i class="fas fa-exclamation-triangle mr-2"></i> Delete Permanently
      </button>
    </div>
  </div>
  </div>

        <div id="table-container" class="min-w-full bg-white">
          <table class="min-w-full bg-white">
            <thead class="bg-gray-50">
              <tr>
                <th class="table-header-cell w-12 text-center">
  <input type="checkbox" id="select-all-checkbox" />
</th>
<th class="table-header-cell">Order Details</th>
                <th class="table-header-cell text-center">Status</th>
                <th class="table-header-cell text-right">Amount</th> 
                <th class="table-header-cell text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="quotation-table-body" class="divide-y divide-gray-200">
            </tbody>
          </table>
        
      </div>
    </div>
  </div>

 
 <script>
document.addEventListener("DOMContentLoaded", function () {

  const dropdownBtn = document.getElementById('documents-dropdown-btn');
  const dropdownContent = document.getElementById('documents-dropdown-content');
  const dropdownIcon = document.getElementById('dropdown-icon');
  if (dropdownBtn) {
    dropdownBtn.addEventListener('click', () => {
        dropdownContent.classList.toggle('hidden');
        dropdownIcon.classList.toggle('rotate-180');
    });
  document.getElementById('purchases-dropdown-btn').addEventListener('click', () => {
      document.getElementById('purchases-dropdown-content').classList.toggle('hidden');
      document.getElementById('purchases-dropdown-icon').classList.toggle('rotate-180');
  });
  }

  const menuToggle = document.getElementById("menu-toggle");
  const sidebar = document.getElementById("sidebar");
  const menuBackdrop = document.getElementById("menu-backdrop");

  if (menuToggle && sidebar && menuBackdrop) {
    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("-translate-x-full");
      menuBackdrop.classList.toggle("hidden");
    });

    menuBackdrop.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      menuBackdrop.classList.add("hidden");
    });
  }

  const API_BASE_URL = "http://Aixains-Mac-mini.local:8000/api";
  const tableBody = document.getElementById("quotation-table-body");
  const filterClient = document.getElementById("filter-client");
  const filterDate = document.getElementById("filter-date");
  

  const tableContainer = document.getElementById("table-container");
  let clientsMap = new Map();
  let allQuotations = [];
  let currentView = 'active'; // Default view

  function getId(order) {
    if (currentView === 'deleted') return order.original_id || order._id;
    return order._id;
  }

  function getAuthHeaders() {
    const token = localStorage.getItem('token');
    if (token) return { 'Authorization': `Bearer ${token}` };
    return null;
  }

  async function fetchJsonAndParse(url, opts = {}) {
    opts.headers = opts.headers || {};
    const authHeaders = getAuthHeaders();
    if (!authHeaders) {
      alert("Authentication token not found. Please log in.");
      window.location.href = '../../index.html';
      throw new Error("Authentication token not found.");
    }
    opts.headers = { ...opts.headers, ...authHeaders };
    if (opts.body && typeof opts.body === 'string' && !opts.headers['Content-Type']) {
      opts.headers = { ...opts.headers, 'Content-Type': 'application/json' };
    }
    const response = await fetch(url, opts);
    if (!response.ok) {
      if (response.status === 401) {
        alert("Session expired. Please log in again.");
        localStorage.removeItem('token');
        window.location.href = '../../index.html';
        throw new Error("Session expired");
      }
      const errorText = await response.text().catch(() => response.statusText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    const contentType = response.headers.get('content-type') || '';
    if (contentType.includes('application/json')) return response.json();
    const text = await response.text();
    try { return JSON.parse(text); } catch (e) { return text; }
  }

  const formatCurrency = (amount) => `₹${Number(amount || 0).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const getStatusBadge = (status) => {
    const statuses = { "Pending": "bg-yellow-100 text-yellow-800", "Shipped": "bg-blue-100 text-blue-800", "Delivered": "bg-green-100 text-green-800", "Cancelled": "bg-red-100 text-red-800" };
    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statuses[status] || 'bg-gray-100'}">${status}</span>`;
  };

  // ✅ RENDER ACTIVE QUOTATIONS
function renderOrders(orders) {
  tableBody.innerHTML = "";
  if (orders.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">No quotation found.</td></tr>`;
    return;
  }

  orders.forEach((order) => {
    const clientName = order.to?.client_name || "Unknown Client";
    const quoNumber = `${order.quotation_no || ""}`;
    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="table-body-cell text-center">
        <input type="checkbox" class="row-checkbox" data-id="${order._id}" />
      </td>
      <td class="table-body-cell">
        <div class="font-semibold text-gray-800">${quoNumber}</div>
        <div class="text-xs text-gray-500">To: ${clientName}</div>
      </td>
      <td class="table-body-cell text-center">
        ${getStatusBadge(order.status || "Pending")}
      </td>
      <td class="table-body-cell text-right font-semibold text-gray-800 tabular-nums">
        ${formatCurrency(order.total)}
      </td>
      <td class="table-body-cell text-center">
        <div class="flex justify-center items-center gap-4 text-gray-500 text-lg relative">
          <a href="view_data_quotation.html?id=${order._id}" class="hover:text-indigo-600" title="View">
            <i class="fas fa-external-link-alt"></i>
          </a>
          <a href="edit_data_quotation.html?id=${order._id}" class="hover:text-indigo-600" title="Edit">
            <i class="fas fa-pencil-alt"></i>
          </a>

          <div class="relative more-actions-container">
            <button class="hover:text-indigo-600 more-actions-btn" title="More">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="js-dropdown-menu absolute right-0 w-52 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20">
              <div class="py-1">
                <button class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 delete-quotation-btn" data-id="${order._id}">
                  <i class="fas fa-trash fa-fw w-5"></i><span>Delete Quotation</span>
                </button>
                ${order.status === "Approved" ? "" : `
  <button class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-blue-700 hover:bg-blue-50 convert-to-sales-order-btn" data-id="${order._id}">
    <i class="fas fa-random fa-fw w-5"></i><span>Convert to Sales Order</span>
  </button>
`}

              </div>
            </div>
          </div>
        </div>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

// ✅ Top checkbox logic (improved)
const selectAllCheckbox = document.getElementById("select-all-checkbox");
selectAllCheckbox.addEventListener("change", () => {
  const allRowCheckboxes = document.querySelectorAll(".row-checkbox");
  allRowCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
  updateSelectionBar(); // ✅ refresh selection bar state
});

// ✅ Sync top checkbox + notification bar dynamically
tableBody.addEventListener("change", (e) => {
  if (e.target.classList.contains("row-checkbox")) {
    const allRowCheckboxes = document.querySelectorAll(".row-checkbox");
    const allChecked = Array.from(allRowCheckboxes).every(cb => cb.checked);
    const anyChecked = Array.from(allRowCheckboxes).some(cb => cb.checked);

    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = !allChecked && anyChecked;

    updateSelectionBar(); // ✅ always update bar visibility
  }
});


  async function populateClientFilter() {
    try {
      const clients = await fetchJsonAndParse(`${API_BASE_URL}/clients`);
      clients.forEach(client => clientsMap.set(client._id, client.client_name || client.name));
      filterClient.innerHTML = '<option value="all">All Clients</option>';
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client._id;
        option.textContent = client.client_name || client.name;
        filterClient.appendChild(option);
      });
    } catch (err) {
      console.error("Could not populate clients:", err.message);
    }
  }

  async function loadQuotations() {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10"><div class="loader mx-auto"></div></td></tr>`;
    try {
      const orders = await fetchJsonAndParse(`${API_BASE_URL}/quotation`);
      allQuotations = orders;
      applyFilters(); // ✅ Apply filters when data loads
    } catch (err) {
      console.error("Error loading quotation:", err);
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-10">Failed to load quotation: ${err.message}</td></tr>`;
    }
  }

  // ✅ FILTER LOGIC
  function applyFilters() {
  let filtered = [...allQuotations];
  const selectedClient = filterClient.value;
  const selectedDate = filterDate.value;
  

  if (selectedClient && selectedClient !== "all") {
    filtered = filtered.filter(q => q.to?._id === selectedClient || q.to_client_id === selectedClient);
  }

  if (selectedDate) {
    filtered = filtered.filter(q => q.quotation_date === selectedDate);
  }

  // ✅ NEW: Filter by status
  // STATUS FILTER
const selectedStatus = document.getElementById("filter-status").value;
console.log("Quotation statuses:", allQuotations.map(q => q.status));

if (selectedStatus !== "all") {
  filtered = filtered.filter(q => {
    const status = (q.status || "Pending").trim().toLowerCase();
    const selected = selectedStatus.trim().toLowerCase();

    // Handle synonyms
    if (selected === "pending") {
      return status === "pending" || status === "pending approval" || status === "";
    }
    if (selected === "approved") {
      return status === "approved";
    }
    return true;
  });
}



  renderOrders(filtered);
}


  // ✅ Event listeners for filters
  filterClient.addEventListener("change", applyFilters);
  filterDate.addEventListener("change", applyFilters);

  (async () => {
    await populateClientFilter();
    await loadQuotations(); // Load active quotations by default
    updateButtonStates(); // Ensure correct buttons are shown on initial load
  })();

// === Bulk Selection Notification Bar ===
const selectionBar = document.getElementById("selection-bar");
const selectedCountText = document.getElementById("selected-count");
const deleteSelectedBtn = document.getElementById("delete-selected");
const closeSelectionBarBtn = document.getElementById("close-selection-bar");
// ✅ NEW: Get new bulk buttons
const restoreSelectedBtn = document.getElementById("restore-selected");
const permanentDeleteSelectedBtn = document.getElementById("permanent-delete-selected");

// ✅ NEW: Helper function to reset all checkboxes
function resetCheckboxes() {
  const selectAllCheckbox = document.getElementById("select-all-checkbox");
  if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
  }
  document.querySelectorAll(".row-checkbox").forEach(cb => (cb.checked = false));
  updateSelectionBar(); // This will hide the bar
}

// Update bar visibility and count
function updateSelectionBar() {
  const selectedBoxes = document.querySelectorAll(".row-checkbox:checked");
  const count = selectedBoxes.length;

  if (count > 0) {
    selectionBar.classList.remove("hidden");
    selectedCountText.textContent = `${count} selected`;
  } else {
    selectionBar.classList.add("hidden");
  }
}

// When close button clicked → clear all selections
closeSelectionBarBtn.addEventListener("click", () => {
  resetCheckboxes(); // Use the new reset function
});

// ✅ MODIFIED: Delete selected quotations (Archive)
deleteSelectedBtn.addEventListener("click", async () => {
  const selectedBoxes = document.querySelectorAll(".row-checkbox:checked");
  if (selectedBoxes.length === 0) return alert("No quotations selected.");

  if (!confirm(`Delete ${selectedBoxes.length} selected quotation(s)? This will move them to deleted items.`)) return;

  try {
    for (const box of selectedBoxes) {
      const id = box.dataset.id;
      await fetchJsonAndParse(`${API_BASE_URL}/archive/quotation/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });
    }

    alert("Selected quotations moved to deleted items.");
    resetCheckboxes(); // ✅ Reset checkboxes
    await loadQuotations(); // Reload active list

  } catch (error) {
    console.error(error);
    alert("Failed to delete some quotations: " + error.message);
  }
});

// ✅ NEW: Restore selected items
restoreSelectedBtn.addEventListener("click", async () => {
  const selectedBoxes = document.querySelectorAll(".row-checkbox:checked");
  if (selectedBoxes.length === 0) return alert("No items selected.");
  
  if (!confirm(`Restore ${selectedBoxes.length} selected item(s)?`)) return;

  try {
    for (const box of selectedBoxes) {
      const id = box.dataset.id;
      // Use the correct API endpoint: POST /api/deleted/{doc_type}/{original_doc_id}
      await fetchJsonAndParse(`${API_BASE_URL}/deleted/quotation/${id}`, { method: 'POST' });
    }
    alert("Selected items restored successfully.");
    resetCheckboxes(); // ✅ Reset checkboxes
    await loadDeletedQuotations(); // ✅ Reload the deleted list
  } catch (error) {
    alert('Could not restore some items: ' + error.message);
  }
});

// ✅ NEW: Permanently delete selected items
permanentDeleteSelectedBtn.addEventListener("click", async () => {
  const selectedBoxes = document.querySelectorAll(".row-checkbox:checked");
  if (selectedBoxes.length === 0) return alert("No items selected.");
  
  if (!confirm(`PERMANENTLY DELETE ${selectedBoxes.length} selected item(s)? This action cannot be undone.`)) return;

  try {
    for (const box of selectedBoxes) {
      const id = box.dataset.id;
      // Use the correct API endpoint: DELETE /api/deleted/{doc_type}/{original_doc_id}
      await fetchJsonAndParse(`${API_BASE_URL}/deleted/quotation/${id}`, { method: 'DELETE' });
    }
    alert("Selected items permanently deleted.");
    resetCheckboxes(); // ✅ Reset checkboxes
    await loadDeletedQuotations(); // ✅ Reload the deleted list
  } catch (error) {
    alert('Could not permanently delete some items: ' + error.message);
  }
});


// Observe selection changes to update bar dynamically
tableBody.addEventListener("change", (e) => {
  if (e.target.classList.contains("row-checkbox")) {
    updateSelectionBar();
  }
});

// This function seems redundant as `loadQuotations` exists, but keeping as per your file structure
async function loadQuotation() {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10"><div class="loader mx-auto"></div></td></tr>`;
        try {
          const orders = await fetchJsonAndParse(`${API_BASE_URL}/quotation`);
          allQuotations = orders;
          renderOrders(orders);
        } catch (err) {
          console.error("Error loading quotation:", err);
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-10">Failed to load quotation: ${err.message}</td></tr>`;
        }
      }

      async function loadDeletedQuotations() {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10"><div class="loader mx-auto"></div></td></tr>`;
        try {
          const deletedOrders = await fetchJsonAndParse(`${API_BASE_URL}/deleted/quotation`);
          renderDeletedOrders(deletedOrders);
        } catch (err) {
          console.error("Error loading deleted quotation:", err);
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-10">Failed to load deleted quotation: ${err.message}</td></tr>`;
        }
      }

      function renderDeletedOrders(orders) {
  tableBody.innerHTML = "";
  if (orders.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">No deleted quotation found.</td></tr>`;
    return;
  }

  orders.forEach((order) => {
    const clientName = clientsMap.get(order.to_client_id) || "Unknown Client";
    const quoNumber = `${order.quotation_no || order.quotation_no || ''}`;
    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="table-body-cell text-center">
  <input type="checkbox" class="row-checkbox" data-id="${order.original_id}" />
</td>

      <td class="table-body-cell">
        <div class="font-semibold text-gray-800">${quoNumber}</div>
        <div class="text-xs text-gray-500">To: ${clientName}</div>
        <div class="text-xs text-red-500">Deleted</div>
      </td>
      <td class="table-body-cell text-center">${getStatusBadge(order.status || 'Pending')}</td>
      <td class="table-body-cell text-right font-semibold text-gray-800 tabular-nums">${formatCurrency(order.total)}</td>
      <td class="table-body-cell text-center">
        <div class="flex justify-center items-center gap-4 text-gray-500 text-lg">
          <button class="hover:text-indigo-600 open-quotation-btn" data-id="${order.original_id}" title="View"><i class="fas fa-external-link-alt"></i></button>
          <div class="relative more-actions-container">
            <button class="hover:text-indigo-600 more-actions-btn" title="More"><i class="fas fa-ellipsis-h"></i></button>
            <div class="js-dropdown-menu absolute right-0 w-52 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20">
              <div class="py-1">
                <button class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50 restore-quotation-btn" data-id="${order.original_id}">
                  <i class="fas fa-undo fa-fw w-5"></i><span>Restore</span>
                </button>
                <button class="flex items-center gap-3 w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 permanent-delete-quotation-btn" data-id="${order.original_id}">
                  <i class="fas fa-trash fa-fw w-5"></i><span>Permanent Delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </td>`;
    tableBody.appendChild(row);
  });
}

      // ✅ MODIFIED: This function now also controls the bulk action buttons
      function updateButtonStates() {
        const activeBtn = document.getElementById('active-quotation-btn');
        // const completedBtn = document.getElementById('completed-quotation-btn'); // This ID doesn't exist in your HTML
        const deletedBtn = document.getElementById('deleted-quotation-btn');
        
        // Get bulk action buttons
        const bulkDeleteBtn = document.getElementById('delete-selected');
        const deletedViewButtons = document.getElementById('deleted-view-buttons');

        // Reset all buttons
        [activeBtn, deletedBtn].forEach(btn => {
          if (btn) {
            btn.classList.remove('text-white', 'bg-indigo-600');
            btn.classList.add('text-gray-600', 'hover:bg-gray-100');
          }
        });
        
        // Set active button and bulk action buttons
        if (currentView === 'active' && activeBtn) {
          activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
          activeBtn.classList.add('text-white', 'bg-indigo-600');
          
          bulkDeleteBtn.classList.remove('hidden'); // Show active delete
          deletedViewButtons.classList.add('hidden'); // Hide deleted restore/perm-delete

        } else if (currentView === 'deleted' && deletedBtn) {
          deletedBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
          deletedBtn.classList.add('text-white', 'bg-indigo-600');

          bulkDeleteBtn.classList.add('hidden'); // Hide active delete
          deletedViewButtons.classList.remove('hidden'); // Show deleted restore/perm-delete
        }
        
        // ✅ NEW: Always reset checkboxes when switching views
        resetCheckboxes();
      }

      document.addEventListener('click', async (e) => {
        const moreBtn = e.target.closest('.more-actions-btn');
        const openBtn = e.target.closest('.open-quotation-btn');
        const deleteBtn = e.target.closest('.delete-quotation-btn');
        const convertBtn = e.target.closest('.convert-to-sales-order-btn');
        const restoreBtn = e.target.closest('.restore-quotation-btn');
        const permanentDeleteBtn = e.target.closest('.permanent-delete-quotation-btn');
        
        // Button navigation handlers
        if (e.target.id === 'active-quotation-btn' || e.target.closest('#active-quotation-btn')) {
          currentView = 'active';
          updateButtonStates();
          await loadQuotations();
        } else if (e.target.id === 'deleted-quotation-btn' || e.target.closest('#deleted-quotation-btn')) {
          currentView = 'deleted';
          updateButtonStates();
          await loadDeletedQuotations();
        }
        // Note: No 'completed-quotation-btn' logic as the button is not in the HTML

        if (openBtn) window.location.href = `view_data_quotation.html?id=${openBtn.dataset.id}&view=true`;

          if (convertBtn) {
  const orderId = convertBtn.dataset.id;
  const orderToConvert = allQuotations.find(order => order._id === orderId);
  if (orderToConvert) {
    // Update the quotation status to 'Approved' before converting
    try {
      await fetchJsonAndParse(`${API_BASE_URL}/quotation/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Approved' })
      });
      
      // Store the quotation data for conversion
      sessionStorage.setItem('quotationToConvert', JSON.stringify(orderToConvert));
      window.location.href = '../saleorder/create_salesorder.html?from_quotation=true';
    } catch (error) {
      alert('Could not update quotation status: ' + error.message);
    }
  } else {
    alert('Could not find the quotation data to convert.');
  }
}


      if (deleteBtn) {
        const orderId = deleteBtn.dataset.id;
        const rowToDelete = deleteBtn.closest('tr');
        if (confirm("Are you sure you want to delete this quotation? It will be moved to deleted items.")) {
          try {
            // Correctly call the backend's archive endpoint
            await fetchJsonAndParse(`${API_BASE_URL}/archive/quotation/${orderId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({}) // Body is often required for POST, even if empty
            });
            rowToDelete.remove();
            alert('Quotation moved to deleted items successfully.');
          } catch (error) {
            alert('Could not move the quotation to deleted items: ' + error.message);
          }
        }
      }
        if (restoreBtn) {
          const orderId = restoreBtn.dataset.id;
          const rowToRestore = restoreBtn.closest('tr');
          if (confirm("Are you sure you want to restore this quotation?")) {
            try {
              // Use the correct API endpoint: POST /api/deleted/{doc_type}/{original_doc_id}
              await fetchJsonAndParse(`${API_BASE_URL}/deleted/quotation/${orderId}`, { method: 'POST' });
              rowToRestore.remove();
              alert('Quotation restored successfully.');
            } catch (error) {
              alert('Could not restore the quotation: ' + error.message);
            }
          }
        }

        if (permanentDeleteBtn) {
          const orderId = permanentDeleteBtn.dataset.id;
          const rowToDelete = permanentDeleteBtn.closest('tr');
          if (confirm("Are you sure you want to permanently delete this Quotation? This action cannot be undone.")) {
            try {
              // Use the correct API endpoint: DELETE /api/deleted/{doc_type}/{original_doc_id}
              await fetchJsonAndParse(`${API_BASE_URL}/deleted/quotation/${orderId}`, { method: 'DELETE' });
              rowToDelete.remove();
              alert('Quotation permanently deleted.');
            } catch (error) {
              alert('Could not permanently delete the quotation: ' + error.message);
            }
          }
        }

        if (moreBtn) {
  const dropdown = moreBtn.nextElementSibling;
  const isVisible = !dropdown.classList.contains('hidden');
  document.querySelectorAll('.js-dropdown-menu').forEach(d => d.classList.add('hidden'));
  if (!isVisible) {
    dropdown.classList.remove('hidden');
    document.getElementById('table-container').classList.add('overflow-visible');
  } else {
    document.getElementById('table-container').classList.remove('overflow-visible');
  }
}
else if (!e.target.closest('.more-actions-container')) {
          document.querySelectorAll('.js-dropdown-menu').forEach(d => d.classList.add('hidden'));
        }
      });

    // Removed the rogue async function that was at the end of your original file,
    // as the main init logic is already handled inside the DOMContentLoaded listener.

});
// ✅ Handle Select All checkbox



</script>






</body>

</html>
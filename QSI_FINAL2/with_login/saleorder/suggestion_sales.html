<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suggested Sales Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f8f9fa;
    }

    .sidebar-link.active {
      background-color: #4f46e5;
    }
    @media (max-width: 768px) {
  #main-content {
    margin-top: 64px; /* height of the fixed header */
  }
}
  </style>
</head>

<body>
  <div class="flex">
    <header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
  <div class="flex items-center space-x-3">
    <button id="menu-toggle" class="text-white focus:outline-none">
      <i class="fas fa-bars text-2xl"></i>
    </button>
    <span class="text-xl font-bold">QSI</span>
  </div>
</header>


<!-- ‚úÖ BACKDROP for mobile -->
<div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

<!-- ‚úÖ SIDEBAR -->
<aside id="sidebar"
  class="w-64 bg-gray-800 text-white h-screen fixed md:h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
      <div class="p-6 text-2xl font-bold border-b border-gray-700">
        <i class=" mr-2 text-indigo-400"></i> QSI
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="../dashboard_with_login.html"
          class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-chart-pie mr-3"></i>Dashboard
        </a>
        <div>
          <button id="documents-dropdown-btn"
            class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
            <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
            <i id="dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
          </button>
          <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
            <a href="../quotation/home_quotation.html"
              class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
            <a href="home_sales_order.html"
              class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales
              Order</a>
            <a href="../invoice/home_invoice.html"
              class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
              <a href="../credit_note.html"
                    class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit note</a>
          </div>
          <div>
            <button id="purchases-dropdown-btn"
              class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
              <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
              <i id="purchases-dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
            </button>
            <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
              <a href="../parchase/vendor/vendors_leads.html"
                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors Leads</a>
              <a href="../parchase/parchase_order/home_purchase_orders.html"
                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase Orders</a>
              <a href="../parchase/debit notes/debit_notes.html"
                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Debit Notes</a>
            </div>
          </div>
        </div>
        <a href="../manage-clients.html"
          class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-users mr-3"></i>Manage Clients
        </a>
        <a href="../settings.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-cog mr-3"></i>Settings
        </a>
      </nav>
    </aside>

    <div id="main-content" class="flex-1 overflow-y-auto p-8">
      <header class="mb-6">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-3xl font-bold text-gray-800 flex items-center">Sales Order Action Center</h1>
          <a href="create_salesorder.html"
            class="bg-purple-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-700 transition duration-200">
            <i class="fas fa-plus mr-2"></i> Create New SalesOrder
          </a>
        </div>
        <nav class="flex items-center space-x-6 border-b">
          <a href="home_sales_order.html" class="py-2 text-sm font-medium text-gray-600 hover:text-gray-900">Overview</a>
          <a href="#" class="py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">Suggested
            Sales Order</a>
          
        </nav>
      </header>

      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <h2 class="text-xl font-semibold text-gray-700">Actionable Suggestions</h2>
          <div class="flex items-center space-x-2">
            <button class="px-3 py-1.5 text-sm font-semibold text-indigo-700 bg-indigo-100 rounded-md">All</button>
            <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Ready to
              Fulfill</button>
            <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">Ready to
              Invoice</button>
            <button class="px-3 py-1.5 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-md">On
              Hold</button>
          </div>
        </div>

        <div id="suggestion-container" class="space-y-4">
          <p class="text-gray-500">Loading suggestions...</p>

          </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // --- Sidebar dropdown logic (Copied from your code) ---
      const dropdownBtn = document.getElementById('documents-dropdown-btn');
      const dropdownContent = document.getElementById('documents-dropdown-content');
      const dropdownIcon = document.getElementById('dropdown-icon');
      
      // Auto-open the sales docs dropdown since we are on a child page
      if (dropdownContent) dropdownContent.classList.remove('hidden');
      if (dropdownIcon) dropdownIcon.classList.add('rotate-180');

      if (dropdownBtn) {
        dropdownBtn.addEventListener('click', () => {
          dropdownContent.classList.toggle('hidden');
          dropdownIcon.classList.toggle('rotate-180');
        });
      }
      const purchasesBtn = document.getElementById('purchases-dropdown-btn');
      if (purchasesBtn) {
          purchasesBtn.addEventListener('click', () => {
          document.getElementById('purchases-dropdown-content').classList.toggle('hidden');
          document.getElementById('purchases-dropdown-icon').classList.toggle('rotate-180');
        });
      }

      // --- Elements & API Config ---
      const container = document.getElementById('suggestion-container');
      const API_BASE_URL = "http://Aixains-Mac-mini.local:8000/api";
      const SALES_ORDER_API_URL = `${API_BASE_URL}/sales-order`; // GET: /api/sales-order

      // -----------------------------------------------------------------
      // --- 1. AUTHENTICATION & API FUNCTIONS (Copied from your code) ---
      // -----------------------------------------------------------------
const menuToggle = document.getElementById("menu-toggle");
const sidebar = document.getElementById("sidebar");
const menuBackdrop = document.getElementById("menu-backdrop");

if (menuToggle && sidebar && menuBackdrop) {
  menuToggle.addEventListener("click", () => {
    sidebar.classList.toggle("-translate-x-full");
    menuBackdrop.classList.toggle("hidden");
  });

  menuBackdrop.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    menuBackdrop.classList.add("hidden");
  });
}
      function getAuthHeaders() {
        const token = localStorage.getItem('token');
        if (token) {
          return { 'Authorization': `Bearer ${token}` };
        }
        return null;
      }

      async function fetchJsonAndParse(url, opts = {}) {
        opts.headers = opts.headers || {};
        const authHeaders = getAuthHeaders();
        if (!authHeaders) {
          alert("Authentication token not found. Please log in.");
          window.location.href = '../../index.html'; // Adjust login path if needed
          throw new Error("Authentication token not found.");
        }
        opts.headers = { ...opts.headers, ...authHeaders };

        if (opts.body && typeof opts.body === 'string' && !opts.headers['Content-Type']) {
          opts.headers = { ...opts.headers, 'Content-Type': 'application/json' };
        }

        const response = await fetch(url, opts);

        if (!response.ok) {
          if (response.status === 401) {
            alert("Authentication error or session expired. Please log in again.");
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = '../../index.html';
            throw new Error("Session expired");
          }
          const errorText = await response.text().catch(() => response.statusText);
          const error = new Error(`HTTP ${response.status}: ${errorText}`);
          error.status = response.status;
          throw error;
        }

        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          return response.json();
        }
        const text = await response.text();
        try { return JSON.parse(text); } catch (e) { return text; }
      }

      // --- 2. SUGGESTION LOGIC (Adapted for Sales Orders) ---

      /**
       * Formats a number as INR currency.
       */
      const formatCurrency = (amount) => `‚Çπ${Number(amount || 0).toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      /**
       * Processes the raw sales order data and generates actionable suggestions.
       * NOTE: This assumes your API objects have a `status` field.
       */
      function generateSuggestions(salesOrders) {
        const suggestions = [];

        for (const order of salesOrders) {
          const status = order.status || 'Pending'; // Default to Pending if no status

          // Suggestion 1: Ready to Invoice
          // Assumes 'Shipped' or 'Delivered' orders are ready to invoice.
          // You might need more complex logic (e.g., checking an `invoiced` flag)
          if (status === 'Shipped' || status === 'Delivered') {
            suggestions.push({
              type: 'invoice',
              icon: 'üßæ',
              title: 'Create Invoice for Shipped Order',
              suggestion: `This order was <strong>${status}</strong>. It's ready to be invoiced.`,
              primaryAction: 'Generate Invoice',
              order: order
            });
          }
          // Suggestion 2: Ready to Fulfill
          else if (status === 'Pending') {
            suggestions.push({
              type: 'fulfill',
              icon: 'üì¶',
              title: 'Fulfill Pending Order',
              suggestion: `This order is <strong>Pending</strong>. Review and prepare for fulfillment.`,
              primaryAction: 'Go to Fulfillment',
              order: order
            });
          }
          // Suggestion 3: On Hold
          else if (status === 'On Hold') {
            suggestions.push({
              type: 'hold',
              icon: '‚ùóÔ∏è',
              title: 'Review Order on Hold',
              suggestion: `This order is <strong>On Hold</strong>. Review account or stock issues.`,
              primaryAction: 'Review Hold',
              order: order
            });
          }
        }
        return suggestions;
      }

      /**
       * Renders the suggestion cards to the DOM using Tailwind classes.
       */
      function renderSuggestions(suggestions) {
        container.innerHTML = ''; // Clear loading message

        if (suggestions.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No suggestions right now. You\'re all caught up!</p>';
          return;
        }

        // Define card styles based on type
        const cardStyles = {
          invoice: { border: 'border-green-500', icon: 'üßæ', iconColor: 'text-green-600' },
          fulfill: { border: 'border-blue-500', icon: 'üì¶', iconColor: 'text-blue-600' },
          hold: { border: 'border-red-500', icon: '‚ùóÔ∏è', iconColor: 'text-red-600' }
        };

        // Loop through suggestions and build HTML
        suggestions.forEach(s => {
          const style = cardStyles[s.type] || { border: 'border-gray-300', icon: '?', iconColor: 'text-gray-600' };
          const order = s.order;
          const orderNumber = `SO-${order.sales_no || ''}`;

          const cardHTML = `
            <div class="flex bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden border-l-4 ${style.border}">
              <div class="text-2xl p-6 flex items-center justify-center bg-gray-50 ${style.iconColor}">${style.icon}</div>
              <div class="flex-grow p-5">
                <h3 class="text-lg font-semibold text-gray-800">${s.title}</h3>
                <div class="text-sm text-gray-600 leading-relaxed mt-1">
                  <strong>Order:</strong> ${orderNumber}<br>
                  <strong>Customer:</strong> ${order.to?.client_name || 'N/A'}<br>
                  <strong>Value:</strong> ${formatCurrency(order.total)}
                </div>
                <div class="text-sm text-gray-900 mt-3">${s.suggestion}</div>
              </div>
              <div class="flex flex-col justify-center p-5 space-y-2">
                <button class="px-4 py-2 text-sm font-medium rounded-md text-center bg-purple-600 text-white hover:bg-purple-700 action-btn" data-id="${order._id}" data-type="${s.type}">${s.primaryAction}</button>
                <button class="px-4 py-2 text-sm font-medium rounded-md text-center bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 view-btn" data-id="${order._id}">View Order</button>
              </div>
            </div>
          `;
          container.innerHTML += cardHTML;
        });

        // Add event listeners for the new buttons
        container.querySelectorAll('.action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;
            if (type === 'invoice') {
              // Redirect to create invoice page, passing the SO id
              window.location.href = `../invoice/create_invoice.html?fromSalesOrder=${id}`;
            } else if (type === 'fulfill') {
              // Redirect to a fulfillment page (or just the order edit page)
              window.location.href = `edit_data_salesorder.html?id=${id}`;
            } else {
              // Default action: view the order
              window.location.href = `edit_data_salesorder.html?id=${id}&view=true`;
            }
          });
        });

        container.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                window.location.href = `edit_data_salesorder.html?id=${id}&view=true`;
            });
        });
      }

      /**
       * Main function to fetch data and run the process.
       */
      async function loadSuggestions() {
        try {
          // Use the authenticated fetch wrapper
          const salesOrders = await fetchJsonAndParse(SALES_ORDER_API_URL);
          if (!salesOrders) {
            container.innerHTML = '<p class="text-red-600">Error: Could not authenticate.</p>';
            return;
          }

          // 1. Process data to find suggestions
          const suggestions = generateSuggestions(Array.isArray(salesOrders) ? salesOrders : []);

          // 2. Render the suggestions to the page
          renderSuggestions(suggestions);

        } catch (error) {
          console.error('Failed to load suggestions:', error);
          container.innerHTML =
            `<p class="text-red-600">Error: Could not load suggestions. ${error.message}</p>`;
        }
      }

      // --- 3. Run the app ---
      loadSuggestions();

    });
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Purchase Order - QSI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .form-container {
            max-width: 960px;
            margin: 2rem auto;
        }

        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: white;
        }

        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
            width: 100%;
            font-size: 0.875rem;
        }

        .input-field:focus {
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
            outline: none;
        }

        .btn {
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn-small {
            padding: .25rem .5rem;
            font-size: .75rem;
        }

        .btn-primary {
            background-color: #7c3aed;
            color: white;
        }

        .btn-primary:hover {
            background-color: #6d28d9;
        }

        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-link {
            color: #7c3aed;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .item-table-header {
            background-color: #6d28d9;
            color: white;
        }

        .item-row {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            #main-content {
                margin-top: 64px;
            }
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Mobile Header -->
        <header class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
            <div class="flex items-center space-x-3">
                <button id="menu-toggle" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <span class="text-xl font-bold">QSI</span>
            </div>
        </header>

        <!-- Backdrop -->
        <div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
      class="w-64 bg-gray-800 text-white h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">
      <div class="p-6 text-2xl font-bold border-b border-gray-700">
        <i class="mr-2 text-indigo-400"></i> QSI
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="../../dashboard_with_login.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-chart-pie mr-3"></i>Dashboard
        </a>
        <div>
          <button id="documents-dropdown-btn" class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
            <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
            <i id="dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200"></i>
          </button>
          <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
            <a href="../../quotation/home_quotation.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
            <a href="../../saleorder/home_sales_order.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales Order</a>
            <a href="../../invoice/home_invoice.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
            <a href="../../credit_note.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit note</a>
          </div>
        </div>
        <div>
          <button id="purchases-dropdown-btn" class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 bg-gray-900 text-left">
            <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
            <i id="purchases-dropdown-icon" class="fas fa-chevron-down transform transition-transform duration-200 rotate-180"></i>
          </button>
          <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1">
            <a href="../vendor/vendors_leads.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors Leads</a>
            <a href="home_purchase_orders.html" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase Orders</a>
            <a href="../debit notes/debit_notes.html" class="block py-2 px-4 rounded transition duration-200 bg-gray-700 text-sm">Debit Notes</a>
          </div>
        </div>
        <a href="../../manage-clients.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-users mr-3"></i>Manage Clients
        </a>
        <a href="../../settings.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
          <i class="fas fa-cog mr-3"></i>Settings
        </a>
      </nav>
    </aside>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 overflow-y-auto">
            <div class="w-full max-w-5xl mx-auto p-6">
                <main class="form-container">
                    <form id="po-form">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Create Purchase Order</h1>
                            <button type="submit" class="btn btn-primary flex items-center">
                                <i class="fas fa-save mr-2"></i> Save Purchase Order
                                <span id="save-btn-loading" class="loading hidden ml-2"></span>
                            </button>
                        </div>

                        <div id="alert-container"></div>

                        <div class="form-section space-y-6">
                            <!-- PO Number and Dates -->
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label for="po-prefix" class="text-gray-600 text-sm">Prefix in PO no.</label>
                                        <input type="text" id="po-prefix" class="input-field col-span-2" value="PO" maxlength="10" />
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label for="po-date" class="text-gray-600 text-sm">PO Date</label>
                                        <input type="date" id="po-date" class="input-field col-span-2" required />
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 items-center">
                                        <label for="expected-delivery" class="text-gray-600 text-sm">Expected Delivery</label>
                                        <input type="date" id="expected-delivery" class="input-field col-span-2" />
                                    </div>
                                </div>
                                <div id="logo-uploader" class="border-2 border-dashed rounded-lg flex flex-col items-center justify-center p-4 text-center cursor-pointer hover:bg-gray-50 relative">
                                    <div id="logo-preview-container" class="hidden absolute inset-0 p-2">
                                        <img id="logo-preview" src="" alt="Business Logo Preview" class="object-contain w-full h-full" />
                                    </div>
                                    <div id="logo-placeholder">
                                        <i class="fas fa-image text-gray-400 text-2xl mb-2"></i>
                                        <span class="text-purple-600 font-semibold">Add Business Logo</span>
                                    </div>
                                    <input type="file" id="logo-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/png, image/jpeg" />
                                </div>
                            </div>

                            <!-- Business and Vendor Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border rounded-lg p-4 space-y-2">
                                    <h3 class="font-semibold text-gray-700">
                                        From <span class="text-gray-400 text-sm">(Your Business)</span>
                                    </h3>
                                    <div>
                                        <label for="businessName" class="text-sm font-medium text-gray-600">Business Name</label>
                                        <input type="text" id="businessName" class="input-field" required readonly />
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label for="business_city" class="text-sm font-medium text-gray-600">City</label>
                                            <input type="text" id="business_city" class="input-field" required readonly />
                                        </div>
                                        <div>
                                            <label for="business_country" class="text-sm font-medium text-gray-600">Country</label>
                                            <input type="text" id="business_country" class="input-field" required readonly />
                                        </div>
                                    </div>
                                </div>

                                <div class="border rounded-lg p-4">
                                    <h3 class="font-semibold text-gray-700 mb-2">
                                        Vendor <span class="text-gray-400 text-sm">(Supplier Details)</span>
                                    </h3>
                                    <select id="vendor-select" class="input-field w-full mb-2" required>
                                        <option value="">Select Vendor</option>
                                    </select>
                                    <button type="button" id="add-new-vendor-btn" class="w-full text-center text-purple-600 font-semibold py-2 border-2 border-dashed rounded-lg hover:bg-purple-50 text-sm">
                                        + Add New Vendor
                                    </button>
                                </div>
                            </div>

                            <!-- Items Section -->
                            <div class="col-span-2 p-4 rounded-lg border shadow-sm">
                                <div class="item-table-header grid grid-cols-12 gap-2 p-3 rounded-t-lg text-sm border-b">
                                    <h4 class="col-span-4 font-semibold">Item</h4>
                                    <h4 class="col-span-2 font-semibold text-center">Quantity</h4>
                                    <h4 class="col-span-2 font-semibold text-center">Rate</h4>
                                    <h4 class="col-span-3 font-semibold text-right">Amount</h4>
                                    <h4 class="col-span-1 text-center">--</h4>
                                </div>
                                <div id="items-container" class="space-y-2 py-2"></div>
                                <div class="pt-2">
                                    <button type="button" id="add-item-btn" class="btn-link">
                                        <i class="fas fa-plus mr-1"></i> Add New Line
                                    </button>
                                </div>
                            </div>

                            <!-- Totals -->
                            <div class="w-full flex justify-end mt-4">
                                <div class="w-80 p-4 rounded-lg border bg-white shadow-sm space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="font-semibold text-gray-800" id="subtotal-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 flex items-center">
                                            Tax (<input type="number" id="tax-percentage" min="0" max="100" class="w-16 mx-1 border rounded text-right text-sm px-2 py-1" value="0" />%)
                                        </span>
                                        <span class="font-semibold text-gray-800" id="tax-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Round Off</span>
                                        <span class="font-semibold text-gray-800" id="round-off-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t-2 border-black pt-2 mt-2">
                                        <span class="font-bold text-lg text-gray-800">Total (INR)</span>
                                        <span class="font-bold text-lg text-purple-600" id="total-display">₹0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms and Notes -->
                            <div class="flex flex-col gap-4">
                                <div class="w-full overflow-x-auto">
                                    <div class="flex flex-nowrap gap-2 mb-4 whitespace-nowrap">
                                        <button type="button" class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" data-target="terms">+ Terms & Conditions</button>
                                        <button type="button" class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" data-target="notes">+ Notes</button>
                                    </div>
                                </div>
                                <div id="terms" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Terms & Conditions</label>
                                    <textarea id="terms-input" class="w-full border rounded p-2" rows="3">Payment due within 30 days</textarea>
                                </div>
                                <div id="notes" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea id="notes-input" class="w-full border rounded p-2" rows="3">Thank you for your business</textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </main>
            </div>
        </div>
    </div>

    <!-- Prefix Modal -->
    <div id="prefix-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800 mb-2">
                <i class="fas fa-question-circle text-purple-600 mr-2"></i>
                Change Prefix?
            </h3>
            <p class="text-gray-600 mb-4">
                You're changing the prefix from <strong id="old-prefix-text"></strong> to <strong id="new-prefix-text"></strong>.
            </p>
            <div class="flex justify-end space-x-3">
                <button id="prefix-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="prefix-once-btn" class="btn btn-primary">Once</button>
                <button id="prefix-always-btn" class="btn btn-primary">Always</button>
            </div>
        </div>
    </div>

    <!-- Vendor Modal -->
    <div id="vendor-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Vendor</h2>
            <form id="vendor-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600">Vendor Name*</label>
                        <input name="supplier_name" type="text" required class="input-field mt-1" placeholder="Vendor Name">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">Country*</label>
                        <select name="country" required class="input-field mt-1">
                            <option>India</option>
                            <option>United States</option>
                            <option>United Kingdom</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">State</label>
                        <input name="state" type="text" class="input-field mt-1" placeholder="State">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">City</label>
                        <input name="city" type="text" class="input-field mt-1" placeholder="City">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="vendor-modal-cancel" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Vendor</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://Aixains-Mac-mini.local:8000/api';
const PREFIX_STORAGE_KEY = 'qsi_po_prefix';
const PREFIX_COUNTERS_KEY = 'qsi_po_prefix_counters';

let originalPrefix = 'PO';
let currentPrefix = 'PO';
let prefixChangeMode = null;
let itemCounter = 0;
let COMPANY_ID = null;

// ========== AUTH HELPERS ==========
// ========== AUTH HELPERS ==========
function getAuthHeaders() {
    const token = localStorage.getItem('token');
    return token ? { 'Authorization': `Bearer ${token}` } : null;
}

async function fetchAPI(url, options = {}) {
    const authHeaders = getAuthHeaders();
    if (!authHeaders) {
        alert("Authentication token not found. Please log in.");
        window.location.href = '../../index.html';
        throw new Error("Authentication required");
    }
    
    // Initialize headers object
    options.headers = { ...options.headers, ...authHeaders };
    
    // Add Content-Type for JSON requests
    if (options.body && typeof options.body === 'string') {
        options.headers['Content-Type'] = 'application/json';
    }
    
    const response = await fetch(url, options);
    
    if (response.status === 401) {
        alert("Session expired. Please log in again.");
        localStorage.removeItem('token');
        window.location.href = '../../index.html';
        throw new Error("Session expired");
    }
    
    if (!response.ok) {
        const text = await response.text();
        throw new Error(text || `HTTP ${response.status}`);
    }
    
    return response.json();
}

// ========== UI HELPERS ==========
function showAlert(message, type = 'success', duration = 5000) {
    const alertContainer = document.getElementById('alert-container');
    if (!alertContainer) return;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), duration);
}

function setLoading(isLoading) {
    const saveBtn = document.querySelector('#po-form button[type="submit"]');
    const loadingSpinner = document.getElementById('save-btn-loading');
    if (saveBtn) saveBtn.disabled = isLoading;
    if (loadingSpinner) loadingSpinner.classList.toggle('hidden', !isLoading);
}

// ========== PREFIX MANAGEMENT ==========
function loadSavedPrefix() {
    const savedPrefix = localStorage.getItem(PREFIX_STORAGE_KEY);
    if (savedPrefix) {
        originalPrefix = savedPrefix;
        currentPrefix = savedPrefix;
        document.getElementById('po-prefix').value = savedPrefix;
    }
}

function getPrefixCounters() {
    const stored = localStorage.getItem(PREFIX_COUNTERS_KEY);
    return stored ? JSON.parse(stored) : {};
}

function setPrefixCounter(prefix, count) {
    const counters = getPrefixCounters();
    counters[prefix] = count;
    localStorage.setItem(PREFIX_COUNTERS_KEY, JSON.stringify(counters));
}

function getNextPONumber(prefix) {
    const counters = getPrefixCounters();
    const currentCount = counters[prefix] || 0;
    const nextCount = currentCount + 1;
    setPrefixCounter(prefix, nextCount);
    return `${prefix}${String(nextCount).padStart(4, '0')}`;
}

function openPrefixModal(oldPrefix, newPrefix) {
    document.getElementById('old-prefix-text').textContent = oldPrefix;
    document.getElementById('new-prefix-text').textContent = newPrefix;
    document.getElementById('prefix-modal').classList.add('active');
}

function closePrefixModal() {
    document.getElementById('prefix-modal').classList.remove('active');
}

function handlePrefixChange(mode) {
    const newPrefix = document.getElementById('po-prefix').value.trim().toUpperCase();
    
    if (mode === 'always') {
        localStorage.setItem(PREFIX_STORAGE_KEY, newPrefix);
        originalPrefix = newPrefix;
        showAlert(`Prefix changed to "${newPrefix}" for all future purchase orders.`, 'success', 3000);
    } else if (mode === 'once') {
        showAlert(`Using prefix "${newPrefix}" for this purchase order only.`, 'success', 3000);
    }
    
    currentPrefix = newPrefix;
    prefixChangeMode = mode;
    closePrefixModal();
}

// ========== COMPANY MANAGEMENT ==========
async function loadCompany() {
    try {
        const companies = await fetchAPI(`${API_BASE_URL}/companies`);
        if (Array.isArray(companies) && companies.length > 0) {
            const company = companies[0];
            COMPANY_ID = company._id || company.id || null;
            
            const bn = document.getElementById('businessName');
            const bc = document.getElementById('business_city');
            const bco = document.getElementById('business_country');
            
            if (bn) bn.value = company.company_name || '';
            if (bc) bc.value = company.address?.city || '';
            if (bco) bco.value = company.address?.country || '';

            // Load logo if exists
            if (company.logo) {
                const logoPreview = document.getElementById('logo-preview');
                const logoPreviewContainer = document.getElementById('logo-preview-container');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                
                if (logoPreview) logoPreview.src = company.logo;
                if (logoPreviewContainer) logoPreviewContainer.classList.remove('hidden');
                if (logoPlaceholder) logoPlaceholder.classList.add('hidden');
            }
        }
    } catch (err) {
        console.error('Error loading company:', err);
        showAlert('Could not load company details', 'error');
    }
}
// ========== LOGO MANAGEMENT ==========
function setupLogoUpload() {
    const logoInput = document.getElementById('logo-input');
    const logoPreview = document.getElementById('logo-preview');
    const logoPreviewContainer = document.getElementById('logo-preview-container');
    const logoPlaceholder = document.getElementById('logo-placeholder');

    if (!logoInput) return;

    logoInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            showAlert('Please upload only PNG or JPEG images', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = async (event) => {
            const dataUrl = event.target.result;
            
            // Display preview
            if (logoPreview) logoPreview.src = dataUrl;
            if (logoPreviewContainer) logoPreviewContainer.classList.remove('hidden');
            if (logoPlaceholder) logoPlaceholder.classList.add('hidden');

            // Upload to server if company exists
            if (COMPANY_ID) {
                try {
                    await fetchAPI(`${API_BASE_URL}/companies/${COMPANY_ID}`, {
                        method: 'PUT',
                        body: JSON.stringify({ logo: dataUrl })
                    });
                    showAlert('Logo uploaded successfully', 'success', 2000);
                } catch (err) {
                    console.error('Error uploading logo:', err);
                    showAlert('Logo preview set, but upload failed', 'error');
                }
            }
        };
        reader.readAsDataURL(file);
    });
}
// ========== VENDOR MANAGEMENT ==========
async function loadVendors() {
    try {
        const vendors = await fetchAPI(`${API_BASE_URL}/vend`);
        const vendorSelect = document.getElementById('vendor-select');
        if (!vendorSelect) return;
        
        vendorSelect.innerHTML = '<option value="">Select Vendor</option>';
        (vendors || []).forEach(vendor => {
            const opt = document.createElement('option');
            opt.value = vendor._id || vendor.id || '';
            opt.textContent = vendor.supplier_name || vendor.name || opt.value;
            vendorSelect.appendChild(opt);
        });
    } catch (err) {
        console.error('Error loading vendors:', err);
        showAlert('Could not load vendors', 'error');
    }
}

function openVendorModal() {
    document.getElementById('vendor-modal').classList.add('active');
}

function closeVendorModal() {
    document.getElementById('vendor-modal').classList.remove('active');
    document.getElementById('vendor-form').reset();
}

// ========== ITEM MANAGEMENT ==========
function addItemRow() {
    itemCounter++;
    const container = document.getElementById('items-container');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'item-row space-y-2 p-2 border rounded';
    itemDiv.dataset.itemId = itemCounter;
    itemDiv.innerHTML = `
        <div class="grid grid-cols-12 gap-2 items-center">
            <input type="text" placeholder="Item Name" class="col-span-4 item-name input-field" required>
            <input type="number" placeholder="0" class="col-span-2 item-quantity input-field text-right" min="1" value="1" required>
            <input type="number" placeholder="0" class="col-span-2 item-rate input-field text-right" min="0" step="0.01" required>
            <span class="col-span-3 item-amount text-right">₹0.00</span>
            <button type="button" class="col-span-1 text-red-500 hover:text-red-700 delete-item-btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="item-description input-field col-span-12" rows="2" placeholder="Item description"></textarea>
    `;
    container.appendChild(itemDiv);

    const qtyInput = itemDiv.querySelector('.item-quantity');
    const rateInput = itemDiv.querySelector('.item-rate');
    const deleteBtn = itemDiv.querySelector('.delete-item-btn');

    qtyInput.addEventListener('input', () => calculateItemAmount(itemDiv));
    rateInput.addEventListener('input', () => calculateItemAmount(itemDiv));
    deleteBtn.addEventListener('click', () => {
        itemDiv.remove();
        calculateTotals();
    });
}

function calculateItemAmount(itemDiv) {
    const qty = parseFloat(itemDiv.querySelector('.item-quantity').value) || 0;
    const rate = parseFloat(itemDiv.querySelector('.item-rate').value) || 0;
    const amount = qty * rate;
    itemDiv.querySelector('.item-amount').textContent = `₹${amount.toFixed(2)}`;
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    document.querySelectorAll('.item-row').forEach(item => {
        const qty = parseFloat(item.querySelector('.item-quantity').value) || 0;
        const rate = parseFloat(item.querySelector('.item-rate').value) || 0;
        subtotal += qty * rate;
    });

    const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
    const tax = (subtotal * taxPercentage) / 100;
    const totalBeforeRound = subtotal + tax;
    const totalRounded = Math.round(totalBeforeRound);
    const roundOff = totalRounded - totalBeforeRound;

    document.getElementById('subtotal-display').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('tax-display').textContent = `₹${tax.toFixed(2)}`;
    document.getElementById('round-off-display').textContent = `₹${roundOff.toFixed(2)}`;
    document.getElementById('total-display').textContent = `₹${totalRounded}`;
}

// ========== FORM SUBMISSION ==========
// ========== FORM SUBMISSION ==========
async function handleFormSubmit(e) {
    e.preventDefault();

    const vendorSelect = document.getElementById('vendor-select');
    if (!vendorSelect.value) {
        showAlert('Please select a vendor', 'error');
        return;
    }

    const items = [];
    document.querySelectorAll('.item-row').forEach(itemDiv => {
        const qty = parseFloat(itemDiv.querySelector('.item-quantity').value) || 0;
        const rate = parseFloat(itemDiv.querySelector('.item-rate').value) || 0;
        items.push({
            item_name: itemDiv.querySelector('.item-name').value,
            description: itemDiv.querySelector('.item-description').value,
            quantity: qty,
            rate: rate,
            amount: qty * rate
        });
    });

    if (items.length === 0) {
        showAlert('Please add at least one item', 'error');
        return;
    }

    const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
    const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
    const tax = (subtotal * taxPercentage) / 100;
    const totalBeforeRound = subtotal + tax;
    const totalRounded = Math.round(totalBeforeRound);
    const roundOff = totalRounded - totalBeforeRound;

    const poNumber = getNextPONumber(currentPrefix);

    const poData = {
        po_no: poNumber,
        prefix: currentPrefix,
        po_date: document.getElementById('po-date').value,
        expected_delivery: document.getElementById('expected-delivery').value,
        supplier_id: vendorSelect.value,
        supplier_name: vendorSelect.options[vendorSelect.selectedIndex].text,
        items: items,
        sub_total: subtotal,
        tax_percentage: taxPercentage,
        tax: tax,
        round_off: roundOff,
        total: totalRounded,
        terms_and_condition: document.getElementById('terms-input')?.value || '',
        notes: document.getElementById('notes-input')?.value || ''
    };

    try {
        setLoading(true);
        
        // Make sure to stringify the body
        await fetchAPI(`${API_BASE_URL}/purchase-orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'  // Explicitly set here
            },
            body: JSON.stringify(poData)  // Make sure it's stringified
        });

        showAlert('Purchase Order created successfully!', 'success');
        
        if (prefixChangeMode === 'once') {
            currentPrefix = originalPrefix;
            document.getElementById('po-prefix').value = originalPrefix;
            prefixChangeMode = null;
        }

        setTimeout(() => {
            window.location.href = 'home_purchase_orders.html';
        }, 2000);
    } catch (err) {
        console.error('Error creating PO:', err);
        showAlert('Failed to create Purchase Order: ' + err.message, 'error');
    } finally {
        setLoading(false);
    }
}
// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', () => {
    // Set today's date
    document.getElementById('po-date').valueAsDate = new Date();
    
    // Load initial data
    loadSavedPrefix();
    loadCompany();
    loadVendors();
    addItemRow();
    setupLogoUpload();
    
    // Mobile menu
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const menuBackdrop = document.getElementById('menu-backdrop');
    
    if (menuToggle && sidebar && menuBackdrop) {
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            menuBackdrop.classList.toggle('hidden');
        });
        menuBackdrop.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            menuBackdrop.classList.add('hidden');
        });
    }
    
    // Sidebar dropdowns
    document.getElementById('documents-dropdown-btn')?.addEventListener('click', () => {
        document.getElementById('documents-dropdown-content')?.classList.toggle('hidden');
        document.getElementById('dropdown-icon')?.classList.toggle('rotate-180');
    });
    
    document.getElementById('purchases-dropdown-btn')?.addEventListener('click', () => {
        document.getElementById('purchases-dropdown-content')?.classList.toggle('hidden');
        document.getElementById('purchases-dropdown-icon')?.classList.toggle('rotate-180');
    });
    
    // Prefix input
    const prefixInput = document.getElementById('po-prefix');
    prefixInput.addEventListener('blur', function() {
        const newValue = this.value.trim().toUpperCase();
        this.value = newValue;
        
        if (newValue && newValue !== originalPrefix && newValue !== currentPrefix) {
            openPrefixModal(originalPrefix, newValue);
        }
    });
    
    // Prefix modal buttons
    document.getElementById('prefix-cancel-btn').addEventListener('click', () => {
        document.getElementById('po-prefix').value = currentPrefix;
        closePrefixModal();
    });
    
    document.getElementById('prefix-once-btn').addEventListener('click', () => {
        handlePrefixChange('once');
    });
    
    document.getElementById('prefix-always-btn').addEventListener('click', () => {
        handlePrefixChange('always');
    });
    
    // Vendor modal
    document.getElementById('add-new-vendor-btn').addEventListener('click', openVendorModal);
    document.getElementById('vendor-modal-cancel').addEventListener('click', closeVendorModal);
    
    document.getElementById('vendor-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const vendorData = {
            supplier_name: form.querySelector('[name="supplier_name"]').value.trim(),
            address: {
                country: form.querySelector('[name="country"]').value,
                state: form.querySelector('[name="state"]').value.trim(),
                city: form.querySelector('[name="city"]').value.trim()
            }
        };
        
        try {
            const result = await fetchAPI(`${API_BASE_URL}/vendors`, {
                method: 'POST',
                body: JSON.stringify(vendorData)
            });
            
            await loadVendors();
            document.getElementById('vendor-select').value = result._id || result.id;
            closeVendorModal();
            showAlert('Vendor added successfully', 'success');
        } catch (err) {
            console.error('Error adding vendor:', err);
            showAlert('Failed to add vendor', 'error');
        }
    });
    
    // Item management
    document.getElementById('add-item-btn').addEventListener('click', addItemRow);
    document.getElementById('tax-percentage').addEventListener('input', calculateTotals);
    
    // Toggle buttons
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;
            const isHidden = targetEl.classList.toggle('hidden');
            btn.innerHTML = btn.innerHTML.replace(isHidden ? '-' : '+', isHidden ? '+' : '-');
        });
    });
    
    // Form submission
    document.getElementById('po-form').addEventListener('submit', handleFormSubmit);
});
    </script>
</body>
</html>
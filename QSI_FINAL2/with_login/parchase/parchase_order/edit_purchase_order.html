<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Purchase Order - QSI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .form-container { max-width: 960px; margin: 2rem auto; }
        .form-section { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; background-color: white; }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.875rem; }
        .input-field:focus { border-color: #7c3aed; box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2); outline: none; }
        .btn { padding: 0.625rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #7c3aed; color: white; }
        .btn-primary:hover { background-color: #6d28d9; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-link { color: #7c3aed; background: none; border: none; cursor: pointer; }
        .item-table-header { background-color: #6d28d9; color: white; }
        .item-row { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #7c3aed; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .alert-success { background-color: #d4edda; color: #155724; }
        .alert-error { background-color: #f8d7da; color: #721c24; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <aside id="sidebar" class="w-64 bg-gray-800 text-white h-screen fixed md:sticky top-0 left-0 z-50 flex flex-col shadow-lg">
            <div class="p-6 text-2xl font-bold border-b border-gray-700">
                <i class="mr-2 text-indigo-400"></i> QSI
            </div>
            <nav class="flex-1 p-4 space-y-2">
                 <a href="../../dashboard_with_login.html" class="flex items-center py-2.5 px-4 rounded hover:bg-gray-700"><i class="fas fa-chart-pie mr-3"></i>Dashboard</a>
                 <a href="home_purchase_orders.html" class="flex items-center py-2.5 px-4 rounded bg-gray-700 text-white"><i class="fas fa-shopping-cart mr-3"></i>Purchase Orders</a>
            </nav>
        </aside>

        <div id="main-content" class="flex-1 overflow-y-auto">
            <div class="w-full max-w-5xl mx-auto p-6">
                <main class="form-container">
                    <form id="po-form">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <a href="home_purchase_orders.html" class="text-sm text-gray-500 hover:text-purple-600 mb-1 inline-block"><i class="fas fa-arrow-left"></i> Back to List</a>
                                <h1 class="text-3xl font-bold text-gray-800">Edit Purchase Order</h1>
                            </div>
                            <button type="submit" class="btn btn-primary flex items-center">
                                <i class="fas fa-save mr-2"></i> Update Order
                                <span id="save-btn-loading" class="loading hidden ml-2"></span>
                            </button>
                        </div>

                        <div id="alert-container"></div>

                        <div class="form-section space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label class="text-gray-600 text-sm">PO Number</label>
                                        <input type="text" id="po-number-display" class="input-field col-span-2 bg-gray-100 cursor-not-allowed" readonly />
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                        <label for="po-date" class="text-gray-600 text-sm">PO Date</label>
                                        <input type="date" id="po-date" class="input-field col-span-2" required />
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 items-center">
                                        <label for="expected-delivery" class="text-gray-600 text-sm">Expected Delivery</label>
                                        <input type="date" id="expected-delivery" class="input-field col-span-2" />
                                    </div>
                                </div>
                                <div class="flex flex-col items-center justify-center p-4 text-center">
                                    <img id="company-logo-img" src="" alt="Company Logo" class="h-20 object-contain hidden">
                                    <p class="text-sm text-gray-400 mt-2" id="company-name-display">Loading Company...</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                                <div class="bg-gray-50 p-4 rounded-lg border">
                                    <h3 class="font-semibold text-gray-700 mb-2">Bill To</h3>
                                    <p id="bill-to-address" class="text-sm text-gray-600 whitespace-pre-line">Loading...</p>
                                </div>

                                <div> 
                                    <label class="block font-semibold text-gray-700 mb-2">Vendor</label>
                                    <select id="vendor-select" class="input-field w-full mb-3" required>
                                        <option value="">Select Vendor</option>
                                    </select>
                                    <button type="button" id="add-new-vendor-btn" class="w-full text-center text-purple-600 font-semibold py-2.5 border-2 border-dashed border-purple-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 text-sm transition-colors">
                                        + Add New Vendor
                                    </button>
                                </div>
                            </div>

                            <div class="col-span-2 p-4 rounded-lg border shadow-sm">
                                <div class="item-table-header grid grid-cols-12 gap-2 p-3 rounded-t-lg text-sm border-b">
                                    <h4 class="col-span-4 font-semibold">Item</h4>
                                    <h4 class="col-span-2 font-semibold text-center">Quantity</h4>
                                    <h4 class="col-span-2 font-semibold text-center">Rate</h4>
                                    <h4 class="col-span-3 font-semibold text-right">Amount</h4>
                                    <h4 class="col-span-1 text-center">--</h4>
                                </div>
                                <div id="items-container" class="space-y-2 py-2"></div>
                                <div class="pt-2">
                                    <button type="button" id="add-item-btn" class="btn-link"><i class="fas fa-plus mr-1"></i> Add New Line</button>
                                </div>
                            </div>

                            <div class="w-full flex justify-end mt-4">
                                <div class="w-80 p-4 rounded-lg border bg-white shadow-sm space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="font-semibold text-gray-800" id="subtotal-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 flex items-center">
                                            Tax (<input type="number" id="tax-percentage" min="0" max="100" class="w-16 mx-1 border rounded text-right text-sm px-2 py-1" value="0" />%)
                                        </span>
                                        <span class="font-semibold text-gray-800" id="tax-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Round Off</span>
                                        <span class="font-semibold text-gray-800" id="round-off-display">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t-2 border-black pt-2 mt-2">
                                        <span class="font-bold text-lg text-gray-800">Total (INR)</span>
                                        <span class="font-bold text-lg text-purple-600" id="total-display">₹0.00</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-4">
                                <div class="flex gap-2">
                                    <button type="button" class="toggle-btn px-3 py-1 bg-gray-100 rounded" data-target="terms">+ Terms & Conditions</button>
                                    <button type="button" class="toggle-btn px-3 py-1 bg-gray-100 rounded" data-target="notes">+ Notes</button>
                                </div>
                                <div id="terms" class="hidden"><label class="text-sm font-medium">Terms</label><textarea id="terms-input" class="w-full border rounded p-2" rows="3"></textarea></div>
                                <div id="notes" class="hidden"><label class="text-sm font-medium">Notes</label><textarea id="notes-input" class="w-full border rounded p-2" rows="3"></textarea></div>
                            </div>
                        </div>
                    </form>
                </main>
            </div>
        </div>
    </div>

    <div id="vendor-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">Create New Vendor</h2>
            <form id="vendor-form" class="space-y-4">
                <input name="vendor_name" id="new-vendor-name" type="text" required class="input-field" placeholder="Vendor Name">
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="vendor-modal-cancel" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Vendor</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://Aixains-Mac-mini.local:8000/api';
        let itemCounter = 0;
        let PO_ID = null; // Stores the ID from the URL

        // --- AUTH HELPERS ---
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : null;
        }

        async function fetchAPI(url, options = {}) {
            const headers = getAuthHeaders();
            if (!headers) { window.location.href = '../../index.html'; return; }
            options.headers = { ...options.headers, ...headers };
            if (options.body && typeof options.body === 'string') options.headers['Content-Type'] = 'application/json';
            
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        function showAlert(msg, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // --- LOAD INITIAL DATA ---
        async function initEditPage() {
            // 1. Extract ID from URL
            const params = new URLSearchParams(window.location.search);
            PO_ID = params.get('id');

            if (!PO_ID) {
                alert("Error: No Purchase Order ID provided!");
                window.location.href = 'home_purchase_orders.html';
                return;
            }

            try {
                // 2. Load Dropdowns first
                await Promise.all([loadCompany(), loadVendors()]);

                // 3. Load PO Data
                await loadPOData(PO_ID);

            } catch (err) {
                console.error(err);
                showAlert('Failed to load Purchase Order details.', 'error');
            }
        }

        async function loadCompany() {
            try {
                const companies = await fetchAPI(`${API_BASE_URL}/companies`);
                if (companies.length > 0) {
                    const c = companies[0];
                    document.getElementById('company-name-display').textContent = c.company_name;
                    document.getElementById('bill-to-address').textContent = `${c.company_name}\n${c.address?.city || ''}, ${c.address?.country || ''}`;
                    if(c.logo) {
                        const img = document.getElementById('company-logo-img');
                        img.src = c.logo; img.classList.remove('hidden');
                    }
                }
            } catch(e) { console.error('Company load error', e); }
        }

        async function loadVendors() {
            try {
                const vendors = await fetchAPI(`${API_BASE_URL}/vend`);
                const select = document.getElementById('vendor-select');
                select.innerHTML = '<option value="">Select Vendor</option>';
                (vendors || []).forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v._id || v.id;
                    // Updated to handle both supplier_name and vendor_name
                    opt.textContent = v.vendor_name || v.supplier_name;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading vendors", error);
            }
        }

        // --- POPULATE FORM WITH EXISTING DATA ---
        async function loadPOData(id) {
            const po = await fetchAPI(`${API_BASE_URL}/purchase-orders/${id}`);
            
            // Set Header Fields
            document.getElementById('po-number-display').value = po.po_no || po.purchase_order_no;
            
            // Date Handling
            if(po.po_date) document.getElementById('po-date').value = new Date(po.po_date).toISOString().split('T')[0];
            if(po.expected_delivery) document.getElementById('expected-delivery').value = new Date(po.expected_delivery).toISOString().split('T')[0];
            
            // Set Vendor
            document.getElementById('vendor-select').value = po.supplier_id || '';

            // Set Tax
            document.getElementById('tax-percentage').value = po.tax_percentage || 0;

            // Set Notes & Terms
            if(po.terms_and_condition) {
                document.getElementById('terms-input').value = po.terms_and_condition;
                document.querySelector('button[data-target="terms"]').click();
            }
            if(po.notes) {
                document.getElementById('notes-input').value = po.notes;
                document.querySelector('button[data-target="notes"]').click();
            }

            // Populate Items
            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = ''; 
            
            if(po.items && po.items.length > 0) {
                po.items.forEach(item => addItemRow(item));
            } else {
                addItemRow();
            }

            calculateTotals();
        }

        // --- ITEM ROW LOGIC ---
        function addItemRow(data = null) {
            itemCounter++;
            const container = document.getElementById('items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row space-y-2 p-2 border rounded';
            
            const name = data ? data.item_name : '';
            const desc = data ? data.description : '';
            const qty = data ? data.quantity : 1;
            const rate = data ? data.rate : '';
            const amt = data ? data.amount : 0;

            itemDiv.innerHTML = `
                <div class="grid grid-cols-12 gap-2 items-center">
                    <input type="text" placeholder="Item Name" class="col-span-4 item-name input-field" value="${name}" required>
                    <input type="number" placeholder="0" class="col-span-2 item-quantity input-field text-right" min="1" value="${qty}" required>
                    <input type="number" placeholder="0" class="col-span-2 item-rate input-field text-right" min="0" step="0.01" value="${rate}" required>
                    <span class="col-span-3 item-amount text-right">₹${parseFloat(amt).toFixed(2)}</span>
                    <button type="button" class="col-span-1 text-red-500 hover:text-red-700 delete-item-btn"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="item-description input-field col-span-12" rows="2" placeholder="Item description">${desc}</textarea>
            `;
            container.appendChild(itemDiv);

            const qtyInput = itemDiv.querySelector('.item-quantity');
            const rateInput = itemDiv.querySelector('.item-rate');
            const deleteBtn = itemDiv.querySelector('.delete-item-btn');

            const calc = () => {
                const q = parseFloat(qtyInput.value) || 0;
                const r = parseFloat(rateInput.value) || 0;
                itemDiv.querySelector('.item-amount').textContent = `₹${(q * r).toFixed(2)}`;
                calculateTotals();
            };

            qtyInput.addEventListener('input', calc);
            rateInput.addEventListener('input', calc);
            deleteBtn.addEventListener('click', () => { itemDiv.remove(); calculateTotals(); });
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(item => {
                const qty = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const rate = parseFloat(item.querySelector('.item-rate').value) || 0;
                subtotal += qty * rate;
            });

            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
            const tax = (subtotal * taxPercentage) / 100;
            const totalBeforeRound = subtotal + tax;
            const totalRounded = Math.round(totalBeforeRound);
            const roundOff = totalRounded - totalBeforeRound;

            document.getElementById('subtotal-display').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('tax-display').textContent = `₹${tax.toFixed(2)}`;
            document.getElementById('round-off-display').textContent = `₹${roundOff.toFixed(2)}`;
            document.getElementById('total-display').textContent = `₹${totalRounded}`;
        }

        // --- FORM SUBMISSION (UPDATE) ---
        document.getElementById('po-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const vendorSelect = document.getElementById('vendor-select');
            if(!vendorSelect.value) { showAlert('Select a vendor', 'error'); return; }

            const items = [];
            document.querySelectorAll('.item-row').forEach(div => {
                const qty = parseFloat(div.querySelector('.item-quantity').value) || 0;
                const rate = parseFloat(div.querySelector('.item-rate').value) || 0;
                items.push({
                    item_name: div.querySelector('.item-name').value,
                    description: div.querySelector('.item-description').value,
                    quantity: qty, rate: rate, amount: qty * rate
                });
            });

            if(items.length === 0) { showAlert('Add at least one item', 'error'); return; }

            const subtotal = items.reduce((sum, i) => sum + i.amount, 0);
            const taxPerc = parseFloat(document.getElementById('tax-percentage').value) || 0;
            const tax = (subtotal * taxPerc) / 100;
            const total = Math.round(subtotal + tax);

            const updateData = {
                po_date: document.getElementById('po-date').value,
                expected_delivery: document.getElementById('expected-delivery').value,
                supplier_id: vendorSelect.value,
                supplier_name: vendorSelect.options[vendorSelect.selectedIndex].text,
                items: items,
                sub_total: subtotal,
                tax_percentage: taxPerc,
                tax: tax,
                round_off: (total - (subtotal + tax)),
                total: total,
                terms_and_condition: document.getElementById('terms-input').value,
                notes: document.getElementById('notes-input').value
            };

            try {
                document.getElementById('save-btn-loading').classList.remove('hidden');
                
                await fetchAPI(`${API_BASE_URL}/purchase-orders/${PO_ID}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                showAlert('Purchase Order updated successfully!', 'success');
                setTimeout(() => window.location.href = 'home_purchase_orders.html', 1500);

            } catch (err) {
                console.error(err);
                showAlert('Update failed: ' + err.message, 'error');
            } finally {
                document.getElementById('save-btn-loading').classList.add('hidden');
            }
        });

        // --- VENDOR MODAL LOGIC (FIXED) ---
        const vModal = document.getElementById('vendor-modal');
        document.getElementById('add-new-vendor-btn').addEventListener('click', () => vModal.classList.add('active'));
        document.getElementById('vendor-modal-cancel').addEventListener('click', () => vModal.classList.remove('active'));
        
        // Handle New Vendor Submission
        document.getElementById('vendor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nameInput = document.getElementById('new-vendor-name');
            const name = nameInput.value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if(!name) { alert("Vendor Name is required"); return; }

            // UI Feedback
            const originalText = submitBtn.innerText;
            submitBtn.innerText = "Saving...";
            submitBtn.disabled = true;

            try {
                // FIXED: Using "vendor_name" as required by your server error
                const response = await fetchAPI(`${API_BASE_URL}/vend`, {
                    method: 'POST',
                    body: JSON.stringify({ vendor_name: name }) 
                });

                await loadVendors(); // Refresh the dropdown
                
                vModal.classList.remove('active'); // Close modal
                nameInput.value = ''; // Clear input
                showAlert('Vendor added successfully!', 'success');

            } catch(err) {
                console.error("Vendor Add Error:", err);
                alert('Failed to add vendor: ' + err.message); 
            } finally {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', () => {
            initEditPage(); // Handles ?id=123 logic

            // Toggle logic for Terms/Notes
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const el = document.getElementById(btn.dataset.target);
                    el.classList.toggle('hidden');
                });
            });
            document.getElementById('add-item-btn').addEventListener('click', () => addItemRow());
            document.getElementById('tax-percentage').addEventListener('input', calculateTotals);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Purchase Order - QSI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        /* Sidebar & Layout Styles (Same as Create Page) */
        .form-container {
            max-width: 960px;
            margin: 2rem auto;
        }

        .view-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: white;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #7c3aed;
            color: white;
        }
        .btn-primary:hover { background-color: #6d28d9; }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover { background-color: #d1d5db; }

        .btn-outline {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-outline:hover { background-color: #f3f4f6; }

        .item-table-header {
            background-color: #6d28d9;
            color: white;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #6b7280;
        }

        .label-text {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: block;
        }

        .value-text {
            font-size: 0.95rem;
            color: #111827;
            font-weight: 500;
        }

        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-approved { background-color: #d1fae5; color: #065f46; }
        .badge-pending { background-color: #fef3c7; color: #92400e; }
        .badge-cancelled { background-color: #fee2e2; color: #991b1b; }
        .badge-draft { background-color: #f3f4f6; color: #374151; }

        /* Print Styles */
        @media print {
            aside, header, #view-actions, .no-print { display: none !important; }
            #main-content { margin: 0; padding: 0; overflow: visible; }
            body { background-color: white; }
            .view-section { border: none; padding: 0; margin-bottom: 2rem; }
            .form-container { max-width: 100%; margin: 0; }
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <aside id="sidebar" class="w-64 bg-gray-800 text-white h-screen sticky top-0 flex flex-col shadow-lg no-print">
            <div class="p-6 text-2xl font-bold border-b border-gray-700">
                <i class="mr-2 text-indigo-400"></i> QSI
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="../../dashboard_with_login.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-chart-pie mr-3"></i>Dashboard
                </a>
                <a href="home_purchase_orders.html" class="flex items-center py-2.5 px-4 rounded transition duration-200 bg-gray-700 text-white">
                    <i class="fas fa-shopping-cart mr-3"></i>Purchase Orders
                </a>
                </nav>
        </aside>

        <div id="main-content" class="flex-1 overflow-y-auto">
            <div class="w-full max-w-5xl mx-auto p-6">
                
                <div class="flex justify-between items-center mb-6 no-print">
                    <div class="flex items-center gap-3">
                        <a href="home_purchase_orders.html" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <h1 class="text-2xl font-bold text-gray-800">Purchase Order Details</h1>
                    </div>
                    <div class="flex gap-3" id="view-actions">
                        <button onclick="window.print()" class="btn btn-outline">
                            <i class="fas fa-print mr-2"></i> Print
                        </button>
                        <button id="edit-btn" class="btn btn-secondary">
                            <i class="fas fa-pencil-alt mr-2"></i> Edit
                        </button>
                        <button id="download-btn" class="btn btn-primary">
                            <i class="fas fa-download mr-2"></i> Download PDF
                        </button>
                    </div>
                </div>

                <div id="loading-indicator" class="loading">Loading Purchase Order...</div>

                <main id="po-view-container" class="form-container hidden">
                    
                    <div class="view-section flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-3xl font-bold text-gray-900" id="view-po-no">PO-0000</h2>
                                <span id="view-status-badge" class="badge badge-draft">Draft</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-2 mt-4">
                                <div>
                                    <span class="label-text">PO Date</span>
                                    <p class="value-text" id="view-po-date">--</p>
                                </div>
                                <div>
                                    <span class="label-text">Expected Delivery</span>
                                    <p class="value-text" id="view-delivery-date">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <img id="view-logo" src="" alt="Company Logo" class="h-20 object-contain mb-2 hidden ml-auto">
                            <h3 class="font-bold text-xl text-gray-800" id="view-company-name">Your Company</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="view-section">
                            <h3 class="text-purple-700 font-bold mb-3 border-b pb-2">Bill To (Our Details)</h3>
                            <p class="value-text font-bold text-lg mb-1" id="addr-company-name"></p>
                            <p class="text-gray-600 text-sm" id="addr-company-city"></p>
                            <p class="text-gray-600 text-sm" id="addr-company-country"></p>
                        </div>

                        <div class="view-section">
                            <h3 class="text-purple-700 font-bold mb-3 border-b pb-2">Vendor (Supplier)</h3>
                            <p class="value-text font-bold text-lg mb-1" id="addr-vendor-name"></p>
                            <p class="text-gray-600 text-sm" id="addr-vendor-state-city"></p>
                            <p class="text-gray-600 text-sm" id="addr-vendor-country"></p>
                        </div>
                    </div>

                    <div class="view-section p-0 overflow-hidden">
                        <div class="item-table-header grid grid-cols-12 gap-4 p-3 text-sm font-semibold">
                            <div class="col-span-5">Item & Description</div>
                            <div class="col-span-2 text-center">Quantity</div>
                            <div class="col-span-2 text-right">Rate</div>
                            <div class="col-span-3 text-right">Amount</div>
                        </div>
                        <div id="view-items-container" class="divide-y divide-gray-100">
                            </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                        <div class="space-y-6">
                            <div id="view-terms-box" class="hidden">
                                <h4 class="font-semibold text-gray-700 text-sm mb-1">Terms & Conditions</h4>
                                <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded border" id="view-terms">--</p>
                            </div>
                            <div id="view-notes-box" class="hidden">
                                <h4 class="font-semibold text-gray-700 text-sm mb-1">Notes</h4>
                                <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded border" id="view-notes">--</p>
                            </div>
                        </div>

                        <div class="view-section bg-gray-50 border-gray-200">
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium text-gray-900" id="view-subtotal">₹0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Tax (<span id="view-tax-percent">0</span>%)</span>
                                    <span class="font-medium text-gray-900" id="view-tax">₹0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Round Off</span>
                                    <span class="font-medium text-gray-900" id="view-roundoff">₹0.00</span>
                                </div>
                                <div class="flex justify-between items-center border-t border-gray-300 pt-3 mt-2">
                                    <span class="font-bold text-lg text-gray-800">Total</span>
                                    <span class="font-bold text-xl text-purple-700" id="view-total">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://Aixains-Mac-mini.local:8000/api';

        // --- Auth Helper ---
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : null;
        }

        async function fetchAPI(url) {
            const headers = getAuthHeaders();
            if (!headers) {
                window.location.href = '../../index.html';
                throw new Error("No token");
            }
            const res = await fetch(url, { headers });
            if (!res.ok) throw new Error("API Error");
            return res.json();
        }

        // --- Formatting Helpers ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        };

        const getStatusBadge = (status) => {
            const s = (status || 'draft').toLowerCase();
            let cls = 'badge-draft';
            if (s === 'approved') cls = 'badge-approved';
            if (s === 'pending') cls = 'badge-pending';
            if (s === 'cancelled') cls = 'badge-cancelled';
            return `<span class="badge ${cls}">${status || 'Draft'}</span>`;
        };

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const poId = params.get('id');

            if (!poId) {
                alert('No Purchase Order ID found');
                window.location.href = 'home_purchase_orders.html';
                return;
            }

            // Setup Edit Button Link
            document.getElementById('edit-btn').onclick = () => {
                window.location.href = `create_purchase_order.html?edit_id=${poId}`; // Assuming create page handles edit mode
            };

            try {
                // 1. Fetch PO Details
                const poData = await fetchAPI(`${API_BASE_URL}/purchase-orders/${poId}`);
                
                // 2. Fetch Company Details (for 'From' section)
                let companyData = {};
                try {
                    const companies = await fetchAPI(`${API_BASE_URL}/companies`);
                    if (companies && companies.length > 0) companyData = companies[0];
                } catch (e) { console.error("Company fetch error", e); }

                renderPO(poData, companyData);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('po-view-container').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                document.getElementById('loading-indicator').innerHTML = `<span class="text-red-500">Error loading data.</span>`;
            }
        });

        function renderPO(po, company) {
            // Header Info
            document.getElementById('view-po-no').textContent = po.po_no || po.purchase_order_no || 'N/A';
            document.getElementById('view-status-badge').outerHTML = getStatusBadge(po.status);
            document.getElementById('view-po-date').textContent = formatDate(po.po_date || po.order_date);
            document.getElementById('view-delivery-date').textContent = formatDate(po.expected_delivery);

            // Company Info (From)
            document.getElementById('view-company-name').textContent = company.company_name || 'My Company';
            document.getElementById('addr-company-name').textContent = company.company_name || 'My Company';
            document.getElementById('addr-company-city').textContent = company.address?.city || '';
            document.getElementById('addr-company-country').textContent = company.address?.country || '';
            
            if (company.logo) {
                const img = document.getElementById('view-logo');
                img.src = company.logo;
                img.classList.remove('hidden');
            }

            // Vendor Info (To)
            const vendorName = po.supplier_name || (po.supplier ? po.supplier.vendor_name : 'Unknown Vendor');
            document.getElementById('addr-vendor-name').textContent = vendorName;
            
            // Check if vendor address exists in PO object, else leave blank or fetch vendor details separately
            // For now, assume simple display
            document.getElementById('addr-vendor-country').textContent = 'Vendor Details'; 

            // Items List
            const itemsContainer = document.getElementById('view-items-container');
            const items = po.items || [];
            
            if (items.length === 0) {
                itemsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">No items found</div>';
            } else {
                itemsContainer.innerHTML = items.map(item => `
                    <div class="grid grid-cols-12 gap-4 p-4 text-sm items-start">
                        <div class="col-span-5">
                            <p class="font-medium text-gray-900">${item.item_name || 'Item'}</p>
                            <p class="text-gray-500 text-xs mt-0.5">${item.description || ''}</p>
                        </div>
                        <div class="col-span-2 text-center text-gray-700">${item.quantity || 0}</div>
                        <div class="col-span-2 text-right text-gray-700">${formatCurrency(item.rate)}</div>
                        <div class="col-span-3 text-right font-medium text-gray-900">${formatCurrency(item.amount)}</div>
                    </div>
                `).join('');
            }

            // Totals
            document.getElementById('view-subtotal').textContent = formatCurrency(po.sub_total || po.subtotal);
            document.getElementById('view-tax-percent').textContent = po.tax_percentage || 0;
            document.getElementById('view-tax').textContent = formatCurrency(po.tax);
            document.getElementById('view-roundoff').textContent = formatCurrency(po.round_off);
            document.getElementById('view-total').textContent = formatCurrency(po.total || po.grand_total);

            // Footer
            if (po.terms_and_condition) {
                document.getElementById('view-terms-box').classList.remove('hidden');
                document.getElementById('view-terms').textContent = po.terms_and_condition;
            }
            if (po.notes) {
                document.getElementById('view-notes-box').classList.remove('hidden');
                document.getElementById('view-notes').textContent = po.notes;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Invoice System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f9fafb;
        }

        .form-container {
            max-width: 960px;
            margin: 2rem auto;
        }

        .form-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: white;
        }

        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
            width: 100%;
            font-size: 0.875rem;
        }

        .input-field:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }

        .btn {
            padding: 0.625rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn-small {
            padding: .25rem .5rem;
            font-size: .75rem;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;

        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-link {
            color: #4f46e5;
            font-weight: 500;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .item-table-header {
            background-color: #4338ca;
            color: white;
        }

        .item-row {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* A4 Preview Styles */
        .invoice-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            max-width: 210mm;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 2rem auto;
            box-sizing: border-box;
            /* Flexbox for bottom alignment */
            display: flex;
            flex-direction: column;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .status {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
            font-weight: 700;
            background-color: #e6f7f0;
            color: #0b875b;
            border-radius: 9999px;
            text-transform: uppercase;
            border: 2px solid #0b875b;
        }

        .logo-preview-container {
            border: 2px dashed #cbd5e0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            width: 200px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-preview-container img {
            max-width: 150px;
            max-height: 70px;
            object-fit: contain;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }


        .totals table {
            width: 100%;
        }

        .total-row td {
            font-size: 1.25rem;
            font-weight: 700;
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        /* --- ALIGNMENT FIXES --- */
        .pdf-preview-content {
            flex-grow: 1;
            /* Pushes footer down */
        }

        .pdf-preview-footer {
            margin-top: auto;
            /* Sticks to bottom */
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .pdf-footer-left {
            flex-basis: 60%;
            padding-right: 2rem;
        }

        .pdf-footer-right {
            text-align: right;
        }

        .signature-area {
            display: inline-block;
            text-align: center;
        }

        .signature-area .signature-space {
            height: 4rem;
            /* Space for a physical signature */
        }

        .signature-area .signature-line {
            border-top: 1px solid #374151;
            width: 220px;
            padding-top: 0.5rem;
        }

        /* --- END ALIGNMENT FIXES --- */

        /* Fixed bottom button container */
        .bottom-button-container {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem 0;
            border-top: 2px solid #e5e7eb;
            margin-top: 2rem;
            z-index: 10;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
        }

        .invoice-container {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding: 40px;
            background-color: white;
            border: 1px solid #e5e7eb;
            max-width: 800px;
            margin: 2rem auto;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
        }

        .logo-container img {
            max-width: 150px;
            max-height: 70px;
            object-fit: contain;
        }

        .invoice-details {
            text-align: right;
        }

        .invoice-details h1 {
            color: #374151;
            margin-bottom: 8px;
        }

        .invoice-details p {
            margin: 0;
            font-size: 14px;
            color: #4b5563;
        }

        .address-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }

        .address-section h2 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .address-section p {
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .items-table thead {
            border-bottom: 2px solid #d1d5db;
        }

        .items-table th {
            text-align: left;
            padding: 8px 4px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #6b7280;
        }

        .items-table th:nth-child(2),
        .items-table th:nth-child(3),
        .items-table th:nth-child(4) {
            text-align: right;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }

        .items-table td {
            padding: 12px 4px;
            font-size: 14px;
        }

        .items-table td:nth-child(2),
        .items-table td:nth-child(3),
        .items-table td:nth-child(4) {
            text-align: right;
        }

        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .totals-table {
            width: 100%;
            max-width: 300px;
        }

        .totals-table div {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .totals-table .total-amount {
            font-weight: bold;
            font-size: 16px;
            color: #111827;
            border-top: 2px solid #d1d5db;
            margin-top: 8px;
            padding-top: 12px;
        }

        .separator {
            border-top: 1px solid #e5e7eb;
            margin-bottom: 20px;
            display: none;
            /* Hidden by default, can be enabled if needed */
        }

        .invoice-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .notes-terms {
            max-width: 60%;
        }

        .signature-section {
            text-align: center;
            width: 200px;
        }

        .signature-image-space {
            height: 60px;
            margin-bottom: 8px;
        }

        .signature-image-space img {
            max-height: 100%;
            max-width: 100%;
            margin: 0 auto;
            object-fit: contain;
        }

        .signature-line {
            border-top: 1px solid #6b7280;
            padding-top: 4px;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .invoice-container {
                width: 210mm !important;
                min-height: 297mm !important;
                margin: 0 !important;
                box-shadow: none !important;
                page-break-after: always;
            }

            .action-buttons {
                display: none !important;
            }

            .status {
                margin-top: 1.2rem !important;
            }
        }

        @media (max-width: 767px) {
            .invoice-container {
                width: 100%;
                max-width: 100%;
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            #main-content {
                margin-top: 64px;
                /* height of the fixed header */
            }
        }
    </style>
</head>

<body>
    <div class="flex">
        <header
            class="bg-gray-800 text-white flex items-center justify-between p-4 md:hidden fixed top-0 left-0 w-full z-50 shadow-md">
            <div class="flex items-center space-x-3">
                <button id="menu-toggle" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <span class="text-xl font-bold">QSI</span>
            </div>
        </header>


        <div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-40"></div>

        <aside id="sidebar"
            class="w-64 bg-gray-800 text-white h-screen fixed md:h-screen fixed md:sticky top-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col shadow-lg">

            <div class="p-6 text-2xl font-bold border-b border-gray-700">
                <i class=" mr-2 text-indigo-400"></i> QSI
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="../dashboard_with_login.html"
                    class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-chart-pie mr-3"></i>Dashboard
                </a>
                <div>
                    <button id="documents-dropdown-btn"
                        class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                        <span class="flex items-center"><i class="fas fa-file-invoice mr-3"></i>Sales Documents</span>
                        <i id="dropdown-icon"
                            class="fas fa-chevron-down transform transition-transform duration-200"></i>
                    </button>
                    <div id="documents-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
                        <a href="../quotation/home_quotation.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Quotation</a>
                        <a href="../saleorder/home_sales_order.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Sales
                            Order</a>
                        <a href="home_invoice.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Invoice</a>
                        <a href="../credit_note.html"
                            class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Credit
                            note</a>
                    </div>
                    <div>
                        <button id="purchases-dropdown-btn"
                            class="w-full flex justify-between items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-left">
                            <span class="flex items-center"><i class="fas fa-shopping-cart mr-3"></i>Purchases</span>
                            <i id="purchases-dropdown-icon"
                                class="fas fa-chevron-down transform transition-transform duration-200"></i>
                        </button>
                        <div id="purchases-dropdown-content" class="pl-8 pt-2 space-y-1 hidden">
                            <a href="../parchase/vendor/vendors_leads.html"
                                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Vendors
                                Leads</a>
                            
                            <a href="../parchase/parchase_order/home_purchase_orders.html"
                                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Purchase
                                Orders</a>
                            <a href="../parchase/debit notes/debit_notes.html"
                                class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 text-sm">Debit
                                Notes</a>
                        </div>
                    </div>
                </div>
                <a href="../manage-clients.html"
                    class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-users mr-3"></i>Manage Clients
                </a>
                <a href="../settings.html"
                    class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-cog mr-3"></i>Settings
                </a>
            </nav>
        </aside>

        <div id="main-content" class="flex-1 overflow-y-auto">
            <div class="w-full max-w-5xl mx-auto p-6">
                <div id="create-invoice-page">
                    <main class="form-container">
                        <form id="invoice-form">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold text-gray-800">Create Invoice</h1>
                                <div class="flex items-center space-x-2">
                                    <button type="button" id="save-continue-btn"
                                        class="btn btn-primary flex items-center">
                                        Save & Continue
                                        <span id="save-btn-loading" class="loading hidden ml-2"></span>
                                    </button>
                                </div>
                            </div>

                            <div id="alert-container"></div>

                            <div class="form-section space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                            <label for="invoice-prefix" class="text-gray-600 text-sm">Prefix in Inv
                                                no.</label>
                                            <input type="text" id="invoice-prefix" class="input-field col-span-2"
                                                value="INV" />
                                        </div>

                                        

                                        <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                            <label for="invoice-date" class="text-gray-600 text-sm">Invoice Date</label>
                                            <input type="date" id="invoice-date" class="input-field col-span-2"
                                                readonly />

                                            <label for="due-date" class="text-gray-600 text-sm mt-2 block">Due
                                                Date</label>
                                            <input type="date" id="due-date" class="input-field col-span-2" required />

                                        </div>
                                    </div>
                                    <div id="logo-uploader"
                                        class="border-2 border-dashed rounded-lg flex flex-col items-center justify-center p-4 text-center cursor-pointer hover:bg-gray-50 relative">
                                        <div id="logo-preview-container" class="hidden absolute inset-0 p-2">
                                            <img id="logo-preview" src="" alt="Business Logo Preview"
                                                class="object-contain w-full h-full" />
                                        </div>
                                        <div id="logo-placeholder">
                                            <i class="fas fa-image text-gray-400 text-2xl mb-2"></i>
                                            <span class="text-indigo-600 font-semibold">Add Business Logo</span>
                                        </div>
                                        <input type="file" id="logo-input"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                            accept="image/png, image/jpeg" />
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="border rounded-lg p-4 space-y-2">
                                        <h3 class="font-semibold text-gray-700">
                                            From <span class="text-gray-400 text-sm">(Your Details)</span>
                                        </h3>
                                        <div>
                                            <label for="businessName" class="text-sm font-medium text-gray-600">Business
                                                Name</label>
                                            <input type="text" id="businessName" class="input-field" required
                                                readonly />
                                        </div>

                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label for="business_city"
                                                    class="text-sm font-medium text-gray-600">City</label>
                                                <input type="text" id="business_city" class="input-field" required
                                                    readonly />
                                            </div>
                                            <div>
                                                <label for="business_country"
                                                    class="text-sm font-medium text-gray-600">Country</label>
                                                <input type="text" id="business_country" class="input-field" required
                                                    readonly />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="border rounded-lg p-4">
                                        <h3 class="font-semibold text-gray-700 mb-2">
                                            Billed To <span class="text-gray-400 text-sm">(Client's Details)</span>
                                        </h3>

                                        <select id="billed-to-select" class="input-field w-full mb-2" required>
                                            <option value="">Select Client</option>
                                        </select>

                                        <button type="button" id="add-new-client-btn"
                                            class="w-full text-center text-indigo-600 font-semibold py-2 border-2 border-dashed rounded-lg hover:bg-indigo-50 text-sm">
                                            + Add New Client
                                        </button>
                                    </div>
                                </div>



                                <div class="col-span-2 p-4 rounded-lg border shadow-sm">
                                    <div
                                        class="item-table-header grid grid-cols-12 gap-2 p-3 rounded-t-lg text-sm border-b">
                                        <h4 class="col-span-4 font-semibold">Item</h4>
                                        <h4 class="col-span-2 font-semibold text-center">Quantity</h4>
                                        <h4 class="col-span-2 font-semibold text-center">Rate</h4>
                                        <h4 class="col-span-3 font-semibold text-right">Amount</h4>
                                        <h4 class="col-span-1 text-center">--</h4>
                                    </div>

                                    <div id="items-container" class="space-y-2 py-2"></div>

                                    <div class="pt-2">
                                        <button type="button" id="add-item-btn" class="btn-link">
                                            <i class="fas fa-plus mr-1"></i> Add New Line
                                        </button>
                                    </div>
                                </div>

                                <div class="w-full flex justify-end mt-4">
                                    <div class="w-80 p-4 rounded-lg border bg-white shadow-sm space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Subtotal</span>
                                            <span class="font-semibold text-gray-800" id="sub_total">₹0.00</span>
                                        </div>

                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600 flex items-center">
                                                Tax (
                                                <input type="number" id="tax-percentage" min="0" max="100"
                                                    class="w-16 mx-1 border rounded text-right text-sm px-2 py-1"
                                                    value="0" placeholder="0" />%)
                                            </span>
                                            <span class="font-semibold text-gray-800" id="tax">₹0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">Round Off</span>
                                            <span class="font-semibold text-gray-800" id="round_off">₹0.00</span>
                                        </div>
                                        <div
                                            class="flex justify-between items-center border-t-2 border-black pt-2 mt-2">
                                            <span class="font-bold text-lg text-gray-800">Total (INR)</span>
                                            <span class="font-bold text-lg text-gray-800" id="total">₹0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col md:flex-row gap-6 mt-6">
                                    <div class="flex-1 space-y-4">
                                        <div class="w-full overflow-x-auto">

                                            <div class="mb-2">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" id="recurring-invoice"
                                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                                    <span class="text-sm text-gray-700 font-medium">Set as Recurring
                                                        Invoice</span>
                                                </label>
                                            </div>
                                            <div class="mb-2">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" id="show-bank-details"
                                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                                    <span class="text-sm text-gray-700 font-medium">Show bank details
                                                        with UPI QR code in invoice PDF</span>
                                                </label>
                                            </div>

                                            <div class="flex flex-nowrap gap-2 mb-4 whitespace-nowrap">
                                                <button type="button"
                                                    class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                    data-target="terms">+ Terms & Conditions</button>
                                                <button type="button"
                                                    class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                    data-target="notes">+ Notes</button>
                                                <button type="button"
                                                    class="toggle-btn px-3 py-1 bg-gray-100 rounded hover:bg-gray-200"
                                                    data-target="signature-box">+ Authorised Signatory</button>
                                            </div>
                                        </div>

                                        <div id="terms" class="hidden mt-2">
                                            <label class="block text-sm font-medium text-gray-700">Terms &
                                                Conditions</label>
                                            <textarea id="terms-input"
                                                class="w-full border rounded p-2 mt-1">THANK YOU!</textarea>
                                        </div>
                                        <div id="notes" class="hidden mt-2">
                                            <label class="block text-sm font-medium text-gray-700">Notes</label>
                                            <textarea id="notes-input"
                                                class="w-full border rounded p-2 mt-1">Thanks For Business With Us</textarea>
                                        </div>
                                        <div id="signature-box" class="hidden mt-2">
                                            <div class="flex items-center gap-4 mb-3 border-b pb-3">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="radio" name="signatory_type" value="text"
                                                        class="form-radio" checked>
                                                    <span class="text-sm font-medium">Enter Name</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="radio" name="signatory_type" value="image"
                                                        class="form-radio">
                                                    <span class="text-sm font-medium">Upload Signature</span>
                                                </label>
                                            </div>

                                            <div id="signatory-text-container" class="space-y-2">
                                                <select id="signatory-select" class="input-field">
                                                    <option value="">Select Signatory</option>
                                                    <option value="add_new">-- Add New Signatory --</option>
                                                </select>
                                                <div id="add-signatory-container" class="hidden flex gap-2 items-center">
                                                    <input id="new-signatory-input" class="input-field flex-grow"
                                                        placeholder="Enter New Signatory Name">
                                                    <button type="button" id="save-signatory-btn"
                                                        class="btn btn-primary btn-small">Save</button>
                                                    <button type="button" id="cancel-add-signatory-btn"
                                                        class="btn btn-secondary btn-small">Cancel</button>
                                                </div>
                                            </div>

                                            <div id="signatory-image-container" class="hidden space-y-2">
                                                <input type="file" id="signatory-image-input" class="input-field"
                                                    accept="image/png, image/jpeg">
                                                <div id="signatory-image-preview"
                                                    class="mt-2 border border-dashed rounded-lg p-2 h-24 flex items-center justify-center bg-gray-50 text-gray-400">
                                                    <span>Signature Preview</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </main>
                </div>

                <div id="preview-invoice-page" class="hidden">
                    <div class="invoice-container">
                        <header class="invoice-header">
                            <div class="logo-container">
                                <img id="businessLogoPreview" src="" alt="Business Logo" />
                                <span id="preview-business-name" class="font-bold text-lg"></span>
                            </div>
                            <div class="invoice-details">
                                <h1 class="text-4xl font-bold text-gray-800 uppercase">Invoice</h1>
                                <p><strong>Invoice No:</strong> <span id="preview-inv-no"></span></p>
                                <p><strong>Date:</strong> <span id="preview-inv-date"></span></p>
                                <p><strong>Due Date:</strong> <span id="preview-due-date"></span></p>
                            </div>
                        </header>

                        <section class="address-section">
                            <div class="from-address">
                                <h2 class="font-semibold text-gray-600">From:</h2>
                                <p id="preview-from-details" class="text-gray-800"></p>
                            </div>
                            <div class="to-address">
                                <h2 class="font-semibold text-gray-600">To:</h2>
                                <p id="preview-to-details" class="text-gray-800"></p>
                            </div>
                        </section>

                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="preview-items-tbody">
                            </tbody>
                        </table>

                        <section class="totals-section">
                            <div class="totals-table">
                                <div>
                                    <span>Sub Total</span>
                                    <span id="preview-subtotal"></span>
                                </div>
                                <div>
                                    <span>Tax (<span id="preview-tax-rate"></span>%)</span>
                                    <span id="preview-tax"></span>
                                </div>
                                <div>
                                    <span>Round Off</span>
                                    <span id="preview-round-off"></span>
                                </div>
                                <div class="total-amount">
                                    <span>Total Amount</span>
                                    <span id="preview-total"></span>
                                </div>
                            </div>
                        </section>

                        <div class="separator"></div>

                        <footer class="invoice-footer">
                            <div class="notes-terms">
                                <div id="preview-bank-details-block" class="hidden mb-4">
                                    <h3 class="font-semibold mb-2 text-gray-700">Bank Details</h3>
                                    <p class="text-sm text-gray-700" style="line-height: 1.6;">
                                        <strong>Bank:</strong> <span id="preview-bank-name"></span><br>
                                        <strong>A/c Name:</strong> <span id="preview-bank-acc-name"></span><br>
                                        <strong>A/c No:</strong> <span id="preview-bank-acc-no"></span><br>
                                        <strong>IFSC:</strong> <span id="preview-bank-ifsc"></span>
                                    </p>
                                    <div id="preview-upi-qr-code" class="mt-2" style="max-width: 100px;">
                                    </div>
                                </div>

                                <div id="preview-notes-block" class="hidden">
                                    <h3 class="font-semibold mb-1">Notes</h3>
                                    <p id="preview-notes" class="text-sm text-gray-700 whitespace-pre-wrap"></p>
                                </div>
                                <div id="preview-terms-block" class="hidden mt-4">
                                    <h3 class="font-semibold mb-1">Terms and Conditions</h3>
                                    <p id="preview-terms" class="text-sm text-gray-700 whitespace-pre-wrap"></p>
                                </div>
                            </div>
                            <div id="preview-signature-area" class="signature-section hidden">
                                <div class="signature-image-space">
                                </div>
                                <div class="signature-line">
                                    Authorized Signitary
                                </div>
                                <p id="preview-signatory-name" class="font-semibold"></p>
                            </div>
                        </footer>
                    </div>

                    <div class="bottom-button-container">
                        <div class="action-buttons">
                            <button id="edit-btn" class="btn btn-secondary">Edit</button>
                            <button id="download-pdf-btn" class="btn btn-primary">Download as PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="client-modal"
        class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/40 backdrop-blur-sm">
        <div id="client-modal-backdrop" class="absolute inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm"></div>
        <div id="client-modal-panel" class="relative w-full max-w-2xl mx-4">
            <div class="bg-white rounded-lg p-6 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Create New Client</h2>
                    <button id="client-modal-close" class="text-gray-500 hover:text-gray-800"><i
                            class="fas fa-times fa-lg"></i></button>
                </div>
                <form id="client-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600">Business
                                Name*</label>
                            <input name="client_name" type="text" required class="input-field mt-1"
                                placeholder="Business Name (Required)">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Client
                                Industry</label>
                            <select name="client_industry" class="input-field mt-1">
                                <option value="">-Select an Industry-</option>
                                <option value="Technology">Technology</option>
                                <option value="Finance">Finance</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Retail">Retail</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Client Type</label>
                            <select name="client_type" class="input-field mt-1">
                                <option value="customer">Customer</option>
                                <option value="supplier">Supplier</option>
                                <option value="partner">Partner</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Select
                                Country*</label>
                            <select name="country" required class="input-field mt-1">
                                <option>India</option>
                                <option>United States</option>
                                <option>United Kingdom</option>
                                <option>Canada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">State /
                                Province</label>
                            <select name="state" class="input-field mt-1">
                                <option>Select State / Province</option>
                                <option>California</option>
                                <option>New York</option>
                                <option>Tamil Nadu</option>
                                <option>Ontario</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">City/Town</label>
                            <input name="city" type="text" class="input-field mt-1" placeholder="City/Town Name">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Postal Code / Zip
                                Code</label>
                            <input name="pincode" type="text" class="input-field mt-1"
                                placeholder="Postal Code / Zip Code">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600">GSTIN (Optional)</label>
                        <input name="gstin" type="text" class="input-field mt-1" placeholder="12AABCU9603R1ZV">
                    </div>
                    <div class="border-t pt-4 flex justify-end space-x-3">
                        <button type="button" id="client-modal-cancel" class="btn-secondary btn">Cancel</button>
                        <button type="submit" class="btn-primary btn">Save Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="prefix-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/40 backdrop-blur-sm">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md mx-4">
            <div class="bg-white rounded-lg p-6 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Change Prefix?</h2>
                    <button id="prefix-modal-close" class="text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <p class="text-gray-700 mb-2">You're changing the invoice prefix from <strong
                            id="old-prefix-text"></strong> to <strong id="new-prefix-text"></strong>.</p>
                    <p class="text-gray-600 text-sm">Do you want to apply this change?</p>
                </div>
                <div class="flex gap-3 justify-end">
                    <button id="prefix-once-btn" class="btn btn-secondary">Once</button>
                    <button id="prefix-always-btn" class="btn btn-primary">Always</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function () {
        const API_BASE_URL = "http://Aixains-Mac-mini.local:8000/api";
        
        // --- 1. Fixed URL Typo Here ---
        const INVOICE_API_URL = `${API_BASE_URL}/invoic`; 
        // ------------------------------
        
        const CLIENT_API_URL = `${API_BASE_URL}/clients`;
        const COMPANY_API_URL = `${API_BASE_URL}/companies`;
        const SALES_ORDER_API_URL = `${API_BASE_URL}/sales-order`;
        const BANK_API_URL = `${API_BASE_URL}/banks`;
        const SIGNATORY_STORAGE_KEY = 'qsi_saved_signatories';
        const SIGNATURE_IMAGE_STORAGE_KEY = 'qsi_saved_signature_image';
        const PREFIX_STORAGE_KEY = 'qsi_invoice_prefix';
        const PREFIX_COUNTERS_KEY = 'qsi_invoice_prefix_counters';
        let COMPANY_ID = null;

        // Prefix management variables
        let originalPrefix = 'INV';
        let currentPrefix = 'INV';
        let prefixChangeMode = null; 

        const invoiceForm = document.getElementById("invoice-form");
        const itemsContainer = document.getElementById("items-container");
        const addItemBtn = document.getElementById("add-item-btn");
        const taxPercentageInput = document.getElementById("tax-percentage");
        const billedToSelect = document.getElementById("billed-to-select");
        const saveBtnLoading = document.getElementById("save-btn-loading");
        const saveContinueBtn = document.getElementById("save-continue-btn");
        const previewPage = document.getElementById("preview-invoice-page");
        const createPage = document.getElementById("create-invoice-page");
        const alertContainer = document.getElementById("alert-container");
        const invoicePrefixInput = document.getElementById("invoice-prefix");

        const logoInput = document.getElementById("logo-input");
        const logoPreview = document.getElementById("logo-preview");
        const logoPreviewContainer = document.getElementById("logo-preview-container");
        const logoPlaceholder = document.getElementById("logo-placeholder");
        const businessLogoPreview = document.getElementById("businessLogoPreview");
        const editBtn = document.getElementById("edit-btn");
        const downloadPdfBtn = document.getElementById("download-pdf-btn");
        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        const menuBackdrop = document.getElementById("menu-backdrop");

        // Prefix modal elements
        const prefixModal = document.getElementById("prefix-modal");
        const prefixModalClose = document.getElementById("prefix-modal-close");
        const prefixOnceBtn = document.getElementById("prefix-once-btn");
        const prefixAlwaysBtn = document.getElementById("prefix-always-btn");
        const oldPrefixText = document.getElementById("old-prefix-text");
        const newPrefixText = document.getElementById("new-prefix-text");

        if (menuToggle && sidebar && menuBackdrop) {
            menuToggle.addEventListener("click", () => {
                sidebar.classList.toggle("-translate-x-full");
                menuBackdrop.classList.toggle("hidden");
            });

            menuBackdrop.addEventListener("click", () => {
                sidebar.classList.add("-translate-x-full");
                menuBackdrop.classList.add("hidden");
            });
        }

        function escapeHtml(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function (m) {
                return ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[m];
            });
        }

        function setLoading(isLoading) {
            if (saveContinueBtn) {
                saveContinueBtn.disabled = isLoading;
            }
            if (saveBtnLoading) {
                saveBtnLoading.classList.toggle("hidden", !isLoading);
            }
        }

        function showAlert(message, type = "success", duration = 5000) {
            if (!alertContainer) return;
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        // ===== AUTH FUNCTIONS =====
        function getAuthHeaders() {
            const token = localStorage.getItem("token");
            if (token) {
                return { 'Authorization': `Bearer ${token}` };
            }
            return null;
        }

        async function safeFetch(url, opts = {}) {
            const headers = Object.assign({}, opts.headers || {});
            const authHeaders = getAuthHeaders();

            if (!authHeaders) {
                alert("Authentication token not found. Please log in.");
                window.location.href = '../../index.html';
                throw new Error("Authentication token not found.");
            }
            Object.assign(headers, authHeaders);

            if (opts.body && !(opts.body instanceof FormData) && !headers["Content-Type"]) {
                headers["Content-Type"] = "application/json";
            }

            const finalOpts = Object.assign({}, opts, { headers });

            try {
                const res = await fetch(url, finalOpts);
                const text = await res.text();
                let data;
                try { data = text ? JSON.parse(text) : null; } catch (e) { data = text; }

                if (!res.ok) {
                    if (res.status === 401) {
                        alert("Session expired or invalid. Please log in again.");
                        localStorage.removeItem('token');
                        localStorage.removeItem('userId');
                        window.location.href = '../../index.html';
                        throw new Error("Session expired");
                    }
                    const errMsg = (data && data.message) || (typeof data === "string" ? data : res.statusText) || "Request failed";
                    throw new Error(errMsg);
                }
                return data;
            } catch (err) {
                if (err.message !== 'Authentication token not found' && err.message !== 'Session expired') {
                    throw err;
                }
                throw new Error("Authentication required");
            }
        }

        function loadSavedPrefix() {
            const savedPrefix = localStorage.getItem(PREFIX_STORAGE_KEY);
            if (savedPrefix) {
                originalPrefix = savedPrefix;
                currentPrefix = savedPrefix;
                if (invoicePrefixInput) {
                    invoicePrefixInput.value = savedPrefix;
                }
            }
        }

        function getPrefixCounters() {
            const stored = localStorage.getItem(PREFIX_COUNTERS_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function setPrefixCounter(prefix, count) {
            const counters = getPrefixCounters();
            counters[prefix] = count;
            localStorage.setItem(PREFIX_COUNTERS_KEY, JSON.stringify(counters));
        }

        function getNextInvoiceNumber(prefix) {
            const counters = getPrefixCounters();
            const currentCount = counters[prefix] || 0;
            const nextCount = currentCount + 1;
            setPrefixCounter(prefix, nextCount);
            return `${prefix}${String(nextCount).padStart(4, '0')}`;
        }

        function openPrefixModal(oldPrefix, newPrefix) {
            if (oldPrefixText) oldPrefixText.textContent = oldPrefix;
            if (newPrefixText) newPrefixText.textContent = newPrefix;
            prefixModal?.classList.remove('hidden');
        }

        function closePrefixModal() {
            prefixModal?.classList.add('hidden');
        }

        function handlePrefixChange(mode) {
            const newPrefix = invoicePrefixInput.value.trim().toUpperCase();

            if (mode === 'always') {
                localStorage.setItem(PREFIX_STORAGE_KEY, newPrefix);
                originalPrefix = newPrefix;
                showAlert(`Prefix changed to "${newPrefix}" for all future invoices.`, 'success', 3000);
            } else if (mode === 'once') {
                showAlert(`Using prefix "${newPrefix}" for this invoice only.`, 'success', 3000);
            }

            currentPrefix = newPrefix;
            prefixChangeMode = mode;
            closePrefixModal();
        }

        if (invoicePrefixInput) {
            invoicePrefixInput.addEventListener('blur', function () {
                const newValue = this.value.trim().toUpperCase();
                this.value = newValue;

                if (newValue && newValue !== originalPrefix && newValue !== currentPrefix) {
                    openPrefixModal(originalPrefix, newValue);
                }
            });

            invoicePrefixInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            });
        }

        prefixModalClose?.addEventListener('click', () => {
            invoicePrefixInput.value = currentPrefix;
            closePrefixModal();
        });

        prefixOnceBtn?.addEventListener('click', () => {
            handlePrefixChange('once');
        });

        prefixAlwaysBtn?.addEventListener('click', () => {
            handlePrefixChange('always');
        });

        prefixModal?.addEventListener('click', (e) => {
            if (e.target === prefixModal) {
                invoicePrefixInput.value = currentPrefix;
                closePrefixModal();
            }
        });

        function loadSignatories() {
            const selectEl = document.getElementById('signatory-select');
            const saved = JSON.parse(localStorage.getItem(SIGNATORY_STORAGE_KEY)) || [];

            while (selectEl.options.length > 2) {
                selectEl.remove(1);
            }

            saved.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                selectEl.insertBefore(opt, selectEl.options[selectEl.options.length - 1]);
            });
        }

        function loadSignatureImage() {
            const signatoryImagePreview = document.getElementById('signatory-image-preview');
            const dataUrl = localStorage.getItem(SIGNATURE_IMAGE_STORAGE_KEY);
            if (dataUrl) {
                signatoryImagePreview.innerHTML = `<img src="${dataUrl}" class="max-h-full max-w-full object-contain">`;
            } else {
                signatoryImagePreview.innerHTML = '<span>Signature Preview</span>';
            }
        }

        async function loadCompany() {
            try {
                const companies = await safeFetch(COMPANY_API_URL, { method: "GET" });
                if (Array.isArray(companies) && companies.length > 0) {
                    const company = companies[0];
                    COMPANY_ID = company._id || company.id || null;
                    const bn = document.getElementById("businessName");
                    const bc = document.getElementById("business_city");
                    const bco = document.getElementById("business_country");
                    if (bn) bn.value = company.company_name || "";
                    if (bc) bc.value = company.address?.city || "";
                    if (bco) bco.value = company.address?.country || "";
                    if (company.logo) {
                        if (businessLogoPreview) businessLogoPreview.src = company.logo;
                        if (logoPreview) logoPreview.src = company.logo;
                        if (logoPreviewContainer) logoPreviewContainer.classList.remove("hidden");
                        if (logoPlaceholder) logoPlaceholder.classList.add("hidden");
                    }
                } else {
                    console.warn("No company found.");
                    showAlert("No company found. Please create a company.", "error", 7000);
                }
            } catch (err) {
                console.error("Error loading companies:", err);
                showAlert("Could not load company. Check server.", "error", 6000);
            }
        }

        async function loadClients() {
            try {
                const clients = await safeFetch(CLIENT_API_URL, { method: "GET" });
                if (!billedToSelect) return;
                billedToSelect.innerHTML = '<option value="">Select Client</option>';
                (clients || []).forEach((client) => {
                    const opt = document.createElement("option");
                    opt.value = client._id || client.id || "";
                    opt.textContent = client.client_name || client.name || opt.value;
                    billedToSelect.appendChild(opt);
                });
            } catch (err) {
                console.error("Error loading clients:", err);
                showAlert("Could not load clients.", "error", 4000);
            }
        }

        async function fetchBankDetails() {
            try {
                const banks = await safeFetch(BANK_API_URL, { method: "GET" });
                return Array.isArray(banks) ? banks : [];
            } catch (err) {
                console.error("Error loading bank details:", err);
                showAlert("Could not load bank details.", "error", 4000);
                return [];
            }
        }

        function createItemRow() {
            const row = document.createElement("div");
            row.className = "item-row space-y-2 p-2 border rounded";
            row.innerHTML = `
                <div class="grid grid-cols-12 gap-2 items-center">
                    <input class="col-span-4 item-name input-field" placeholder="Item Name" required>
                    <input type="number" class="col-span-2 quantity input-field text-right" placeholder="0" min="0" required>
                    <input type="text" class="col-span-2 rate input-field text-right" placeholder="0" required>
                    <span class="col-span-3 amount text-right">₹0.00</span>
                    <button type="button" class="col-span-1 text-red-500 hover:text-red-700 delete-item-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <textarea class="description input-field col-span-12" rows="2" placeholder="Item description"></textarea>
            `;

            const qtyEl = row.querySelector(".quantity");
            const rateEl = row.querySelector(".rate");
            const deleteBtn = row.querySelector(".delete-item-btn");

            const onChange = () => updateRowAmount(row);
            qtyEl?.addEventListener("input", onChange);
            rateEl?.addEventListener("input", onChange);

            deleteBtn?.addEventListener("click", () => {
                row.remove();
                updateTotals();
            });

            itemsContainer.appendChild(row);
            updateRowAmount(row);
        }

        function updateRowAmount(row) {
            try {
                const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                const rate = parseFloat(row.querySelector(".rate").value) || 0;
                const amt = qty * rate;
                row.querySelector(".amount").textContent = `₹${amt.toFixed(2)}`;
                updateTotals();
            } catch (e) { console.error(e); }
        }

        function updateTotals() {
            let subtotal = 0;
            document.querySelectorAll(".item-row").forEach((row) => {
                const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                const rate = parseFloat(row.querySelector(".rate").value) || 0;
                subtotal += qty * rate;
            });

            const taxP = parseFloat(taxPercentageInput?.value) || 0;
            const tax = subtotal * (taxP / 100);
            const totalBeforeRound = subtotal + tax;

            const totalRounded = Math.round(totalBeforeRound);
            const roundOff = totalRounded - totalBeforeRound;

            const sEl = document.getElementById("sub_total");
            const taxEl = document.getElementById("tax");
            const roundOffEl = document.getElementById("round_off");
            const totalEl = document.getElementById("total");

            if (sEl) sEl.textContent = `₹${subtotal.toFixed(2)}`;
            if (taxEl) taxEl.textContent = `₹${tax.toFixed(2)}`;
            if (roundOffEl) roundOffEl.textContent = `₹${roundOff.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `₹${totalRounded.toFixed(0)}`;
        }

        // ===== 2. INVOICE DATA COLLECTION =====
        function collectInvoiceData() {
            const items = [...document.querySelectorAll(".item-row")].map((row) => {
                const qty = parseFloat(row.querySelector(".quantity").value) || 0;
                const rate = parseFloat(row.querySelector(".rate").value) || 0;
                return {
                    item_name: (row.querySelector(".item-name").value || "").trim(),
                    description: (row.querySelector(".description").value || "").trim(),
                    quantity: qty,
                    rate: rate,
                    amount: +(qty * rate).toFixed(2),
                };
            });

            const subTotal = items.reduce((s, it) => s + it.amount, 0);
            const taxP = parseFloat(taxPercentageInput?.value) || 0;
            const tax = +(subTotal * (taxP / 100));
            const totalBeforeRound = +(subTotal + tax);
            const totalRounded = Math.round(totalBeforeRound);
            const roundOff = totalRounded - totalBeforeRound;

            const signatoryType = document.querySelector('input[name="signatory_type"]:checked').value;
            let signatoryName = null;
            let signatoryImage = null;

            if (signatoryType === 'text') {
                const selectEl = document.getElementById('signatory-select');
                if (selectEl && selectEl.value && selectEl.value !== 'add_new') {
                    signatoryName = selectEl.value;
                }
            } else {
                signatoryImage = localStorage.getItem(SIGNATURE_IMAGE_STORAGE_KEY);
            }

            // --- CAPTURE RECURRING CHECKBOX ---
            const isRecurring = document.getElementById('recurring-invoice')?.checked || false;
            // ----------------------------------

            const prefixInputVal = document.getElementById("invoice-prefix").value.trim().toUpperCase();
            const finalPrefix = prefixInputVal || currentPrefix;
            
            // Note: invoiceNumber is calculated on backend usually, but can be sent if needed
            const invoiceNumber = getNextInvoiceNumber(finalPrefix);
            
            return {
                prefix: finalPrefix,
                invoice_number: invoiceNumber,
                date: document.getElementById("invoice-date")?.value || new Date().toISOString().slice(0, 10),
                due_date: document.getElementById("due-date")?.value || "",
                items,
                sub_total: +subTotal.toFixed(2),
                tax: +tax.toFixed(2),
                round_off: +roundOff.toFixed(2),
                total: totalRounded,
                tax_percentage: taxP,
                from_company_id: COMPANY_ID,
                to_client_id: billedToSelect?.value || "",
                terms_and_condition: (document.querySelector("#terms textarea")?.value || "").trim(),
                notes: (document.querySelector("#notes textarea")?.value || "").trim(),
                signatory: signatoryName,
                signatory_image: signatoryImage,
                
                // --- SEND RECURRING FLAG TO BACKEND ---
                is_recurring: isRecurring,
                // --------------------------------------
                
                payment_details_id: null 
            };
        }

        async function submitInvoice(data) {
            // We send to /api/invoice. 
            // The backend detects 'is_recurring: true' and saves to BOTH collections automatically.
            return await safeFetch(INVOICE_API_URL, {
                method: "POST",
                body: JSON.stringify(data),
            });
        }

        invoiceForm?.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Validation
            const rows = document.querySelectorAll('.item-row');
            const messages = [];
            let isValid = true;
            let firstInvalidEl = null;

            document.querySelectorAll('.error-text').forEach(el => el.remove());

            if (!billedToSelect?.value) {
                messages.push("⚠️ Please select a client before saving.");
                isValid = false;
            }

            if (!rows.length) {
                messages.push("⚠️ Please add at least one item.");
                isValid = false;
            }

            rows.forEach((row, index) => {
                const nameEl = row.querySelector('.item-name');
                const qtyEl = row.querySelector('.quantity');
                const rateEl = row.querySelector('.rate');

                const nameVal = nameEl?.value.trim() || '';
                const qtyVal = qtyEl?.value.trim() || '';
                const rateVal = rateEl?.value.trim() || '';

                const addInlineError = (el, msg) => {
                    if (!el) return;
                    const small = document.createElement('small');
                    small.className = 'error-text text-red-500 text-xs block mt-1';
                    small.textContent = msg;
                    el.insertAdjacentElement('afterend', small);
                };

                if (!nameVal) {
                    addInlineError(nameEl, "Required");
                    messages.push(`Item ${index + 1}: Missing item name.`);
                    if (!firstInvalidEl) firstInvalidEl = nameEl;
                    isValid = false;
                }

                if (!qtyVal) {
                    addInlineError(qtyEl, "Required");
                    messages.push(`Item ${index + 1}: Missing quantity.`);
                    if (!firstInvalidEl) firstInvalidEl = qtyEl;
                    isValid = false;
                } else if (!/^\d+(\.\d+)?$/.test(qtyVal)) {
                    addInlineError(qtyEl, "Invalid format");
                    messages.push(`Item ${index + 1}: Invalid quantity format.`);
                    if (!firstInvalidEl) firstInvalidEl = qtyEl;
                    isValid = false;
                }

                if (!rateVal) {
                    addInlineError(rateEl, "Required");
                    messages.push(`Item ${index + 1}: Missing rate.`);
                    if (!firstInvalidEl) firstInvalidEl = rateEl;
                    isValid = false;
                } else if (!/^\d+(\.\d+)?$/.test(rateVal)) {
                    addInlineError(rateEl, "Invalid format");
                    messages.push(`Item ${index + 1}: Invalid rate format.`);
                    if (!firstInvalidEl) firstInvalidEl = rateEl;
                    isValid = false;
                }
            });

            if (!isValid) {
                showAlert(messages.join("\n"), "error", 6000);
                if (firstInvalidEl) firstInvalidEl.focus();
                return;
            }

            try {
                setLoading(true);
                const dataFromForm = collectInvoiceData();

                // Get bank details ID
                const showBankDetails = document.getElementById('show-bank-details')?.checked;
                
                try {
                    const banks = await fetchBankDetails();
                    if (banks && banks.length > 0) {
                        const bankWithUpi = banks.find(b => b.upi_id) || banks[0];
                        dataFromForm.payment_details_id = bankWithUpi._id || bankWithUpi.id;
                    } else {
                        showAlert("Please add a bank account in Settings before creating invoices.", "error", 6000);
                        setLoading(false);
                        return;
                    }
                } catch (err) {
                    console.error("Failed to get bank details:", err);
                    showAlert("Unable to retrieve bank details. Please check your settings.", "error", 6000);
                    setLoading(false);
                    return;
                }

                console.log("Submitting invoice data:", dataFromForm);

                const serverResponse = await submitInvoice(dataFromForm);

                let savedDoc = serverResponse.document;
                if (!savedDoc) {
                    if (serverResponse.invoice_no) {
                        savedDoc = serverResponse;
                    } else {
                        throw new Error("Server did not return a saved document.");
                    }
                }

                console.log("Server response:", savedDoc);

                const isRecurring = document.getElementById("recurring-invoice")?.checked || false;

                if (isRecurring) {
                    console.log("✅ Recurring invoice template created!");
                }

                // Populate preview
                document.getElementById("preview-inv-no").textContent = savedDoc.invoice_no || "N/A";
                document.getElementById("preview-inv-date").textContent = new Date(savedDoc.date).toLocaleDateString('en-GB');
                document.getElementById("preview-due-date").textContent = new Date(savedDoc.due_date).toLocaleDateString('en-GB');

                const fromAddress = [
                    savedDoc.from?.company_name || '',
                    `${savedDoc.from?.address?.street || ''},${savedDoc.from?.address?.city || ''}, ${savedDoc.from?.address?.state || ''} ${savedDoc.from?.address?.postalCode || ''}`
                ].filter(line => line.trim() !== '').join('\n');

                document.getElementById("preview-from-details").textContent = fromAddress;

                const toAddress = [
                    savedDoc.to?.client_name || '',
                    `${savedDoc.to?.address?.city || ''}, ${savedDoc.to?.address?.state || ''} ${savedDoc.to?.address?.pincode || ''}`
                ].filter(line => line.trim() !== '').join('\n');

                document.getElementById("preview-to-details").textContent = toAddress;

                const tbody = document.getElementById("preview-items-tbody");
                if (tbody) {
                    tbody.innerHTML = "";
                    (savedDoc.items || []).forEach((item) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${escapeHtml(item.item_name)}</td>
                            <td class="text-center">${item.quantity}</td>
                            <td class="text-right">₹${item.rate.toFixed(2)}</td>
                            <td class="text-right">₹${item.amount.toFixed(2)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                document.getElementById("preview-subtotal").textContent = `₹${savedDoc.sub_total.toFixed(2)}`;
                document.getElementById("preview-tax-rate").textContent = savedDoc.tax_percentage;
                document.getElementById("preview-tax").textContent = `₹${savedDoc.tax.toFixed(2)}`;
                document.getElementById("preview-round-off").textContent = `₹${(savedDoc.round_off || 0).toFixed(2)}`;
                document.getElementById("preview-total").textContent = `₹${Math.round(savedDoc.total)}`;

                document.getElementById("preview-terms").textContent = savedDoc.terms_and_condition;
                document.getElementById("preview-terms-block")?.classList.toggle("hidden", !savedDoc.terms_and_condition);

                document.getElementById("preview-notes").textContent = savedDoc.notes;
                document.getElementById("preview-notes-block")?.classList.toggle("hidden", !savedDoc.notes);

                const previewSignatureArea = document.getElementById("preview-signature-area");
                const signatureImageSpace = previewSignatureArea.querySelector(".signature-image-space");
                const previewSignatoryName = document.getElementById("preview-signatory-name");
                
                signatureImageSpace.innerHTML = '';
                previewSignatoryName.textContent = '';
                previewSignatureArea.classList.add("hidden");

                const hasSignatureImage = !!dataFromForm.signatory_image;
                const hasSignatoryName = !!dataFromForm.signatory;

                if (hasSignatureImage || hasSignatoryName) {
                    if (hasSignatureImage) {
                        signatureImageSpace.innerHTML = `<img src="${dataFromForm.signatory_image}" alt="Signature">`;
                    }
                    if (hasSignatoryName) {
                        previewSignatoryName.textContent = dataFromForm.signatory;
                    }
                    previewSignatureArea.classList.remove("hidden");
                }

                const bankBlock = document.getElementById('preview-bank-details-block');
                const qrBlock = document.getElementById('preview-upi-qr-code');

                bankBlock.classList.add('hidden');
                qrBlock.innerHTML = '';

                if (showBankDetails) {
                    try {
                        const banks = await fetchBankDetails();
                        if (banks && banks.length > 0) {
                            const bankWithUpi = banks.find(b => b.upi_id);

                            if (bankWithUpi) {
                                document.getElementById('preview-bank-name').textContent = bankWithUpi.bank_name || 'N/A';
                                document.getElementById('preview-bank-acc-name').textContent = bankWithUpi.account_holder || 'N/A';
                                document.getElementById('preview-bank-acc-no').textContent = bankWithUpi.account_number || 'N/A';
                                document.getElementById('preview-bank-ifsc').textContent = bankWithUpi.ifsc_code || 'N/A';

                                const upiId = bankWithUpi.upi_id;
                                const totalAmount = savedDoc.total;
                                const companyName = savedDoc.from?.company_name || 'Payment';
                                const upiString = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(companyName)}&am=${totalAmount.toFixed(2)}&cu=INR`;

                                if (typeof qrcode !== 'undefined') {
                                    const typeNumber = 4;
                                    const errorCorrectionLevel = 'L';
                                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                                    qr.addData(upiString);
                                    qr.make();
                                    qrBlock.innerHTML = qr.createImgTag(3, 4);
                                } else {
                                    console.error("qrcode library is not loaded.");
                                    qrBlock.innerHTML = '<span class="text-xs text-red-500">QR Lib Error</span>';
                                }

                                bankBlock.classList.remove('hidden');
                            }
                        }
                    } catch (bankErr) {
                        console.error("Failed to fetch or display bank details:", bankErr);
                    }
                }

                createPage?.classList.add("hidden");
                previewPage?.classList.remove("hidden");

                let successMsg = "Invoice saved successfully!";
                if (isRecurring) {
                    const nextDate = new Date();
                    nextDate.setMonth(nextDate.getMonth() + 1);
            successMsg += ` 🔄 Recurring invoice set up! Next invoice will be generated on ${nextDate.toLocaleDateString('en-GB')}.`;
        }
        showAlert(successMsg, "success", 6000);

        // Reset prefix to original if mode was 'once'
        if (prefixChangeMode === 'once') {
            currentPrefix = originalPrefix;
            if (invoicePrefixInput) {
                invoicePrefixInput.value = originalPrefix;
            }
            prefixChangeMode = null;
        }

    } catch (err) {
        console.error("Save error:", err);
        const msg = err?.message || "Failed to save invoice";
        showAlert(`Error: ${msg}`, "error", 6000);
    } finally {
        setLoading(false);
    }
});


            editBtn?.addEventListener("click", () => {
                previewPage?.classList.add("hidden");
                createPage?.classList.remove("hidden");
            });

            downloadPdfBtn?.addEventListener("click", async (e) => {
                e.preventDefault();
                try {
                    const element = document.querySelector("#preview-invoice-page .invoice-container");
                    if (!element) throw new Error("Preview section not found");

                    const actionButtons = document.querySelector(".bottom-button-container");
                    if (actionButtons) actionButtons.style.display = "none";

                    const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF("p", "mm", "a4");
                    const imgData = canvas.toDataURL("image/png");
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pageWidth;
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
                    let clientName = document.getElementById("preview-to-details")?.textContent || "Client";
                    clientName = clientName.replace(/[^a-zA-Z0-9-_ ]/g, "").replace(/\s+/g, "_");
                    const filename = `${clientName}-invoice.pdf`;
                    pdf.save(filename);

                    if (actionButtons) actionButtons.style.display = "block";
                } catch (err) {
                    console.error(err);
                    showAlert("Error exporting PDF: " + (err.message || err), "error", 6000);
                }
            });

            const addNewClientBtn = document.getElementById("add-new-client-btn");
            const clientModal = document.getElementById("client-modal");
            const clientModalClose = document.getElementById("client-modal-close");
            const clientModalCancel = document.getElementById("client-modal-cancel");
            const clientForm = document.getElementById("client-form");

            function openClientModal() {
                clientModal?.classList.remove("hidden");
            }
            function closeClientModal() {
                clientModal?.classList.add("hidden");
                clientForm?.reset();
            }

            addNewClientBtn?.addEventListener("click", openClientModal);
            clientModalClose?.addEventListener("click", closeClientModal);
            clientModalCancel?.addEventListener("click", closeClientModal);
            clientModal?.addEventListener("click", (e) => {
                if (e.target === clientModal) closeClientModal();
            });

            clientForm?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const form = e.target;
                const clientName = form.querySelector('[name="client_name"]')?.value?.trim();
                if (!clientName) {
                    showAlert("Business Name is required", "error", 3000);
                    return;
                }
                const newClient = {
                    client_name: clientName,
                    client_industry: form.querySelector('[name="client_industry"]')?.value,
                    gst_in: form.querySelector('[name="gstin"]')?.value?.trim(),
                    client_type: form.querySelector('[name="client_type"]')?.value,
                    address: {
                        "city/town": form.querySelector('[name="city"]')?.value?.trim(),
                        state: form.querySelector('[name="state"]')?.value,
                        country: form.querySelector('[name="country"]')?.value,
                        pincode: form.querySelector('[name="pincode"]')?.value?.trim(),
                    },
                };
                try {
                    const data = await safeFetch(`${API_BASE_URL}/clients`, {
                        method: "POST",
                        body: JSON.stringify(newClient),
                    });
                    const option = document.createElement("option");
                    option.value = data.client?._id || data.client?.id || data.client_name || newClient.client_name;
                    option.textContent = data.client?.client_name || data.client_name || newClient.client_name;
                    billedToSelect.appendChild(option);
                    billedToSelect.value = option.value;
                    closeClientModal();
                    showAlert("Client saved.", "success", 3000);
                } catch (err) {
                    console.warn("Could not save client to server, adding locally:", err);
                    const option = document.createElement("option");
                    option.value = newClient.client_name;
                    option.textContent = newClient.client_name;
                    billedToSelect.appendChild(option);
                    billedToSelect.value = newClient.client_name;
                    closeClientModal();
                    showAlert("Client added locally.", "error", 4000);
                }
            });

            // --- Signatory Management Listeners ---
            const signatoryTypeRadios = document.querySelectorAll('input[name="signatory_type"]');
            const signatoryTextContainer = document.getElementById('signatory-text-container');
            const signatoryImageContainer = document.getElementById('signatory-image-container');
            const signatoryImageInput = document.getElementById('signatory-image-input');
            const signatorySelect = document.getElementById('signatory-select');
            const addSignatoryContainer = document.getElementById('add-signatory-container');
            const newSignatoryInput = document.getElementById('new-signatory-input');
            const saveSignatoryBtn = document.getElementById('save-signatory-btn');
            const cancelSignatoryBtn = document.getElementById('cancel-add-signatory-btn');

            signatoryTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isText = e.target.value === 'text';
                    signatoryTextContainer.classList.toggle('hidden', !isText);
                    signatoryImageContainer.classList.toggle('hidden', isText);
                });
            });

            signatoryImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    localStorage.setItem(SIGNATURE_IMAGE_STORAGE_KEY, dataUrl);
                    loadSignatureImage();
                };
                reader.readAsDataURL(file);
            });

            signatorySelect.addEventListener('change', () => {
                if (signatorySelect.value === 'add_new') {
                    addSignatoryContainer.classList.remove('hidden');
                    newSignatoryInput.focus();
                } else {
                    addSignatoryContainer.classList.add('hidden');
                }
            });

            cancelSignatoryBtn.addEventListener('click', () => {
                addSignatoryContainer.classList.add('hidden');
                newSignatoryInput.value = '';
                signatorySelect.value = ''; // Reset dropdown
            });

            saveSignatoryBtn.addEventListener('click', () => {
                const newName = newSignatoryInput.value.trim();
                if (newName) {
                    let saved = JSON.parse(localStorage.getItem(SIGNATORY_STORAGE_KEY)) || [];
                    if (!saved.includes(newName)) {
                        saved.push(newName);
                        localStorage.setItem(SIGNATORY_STORAGE_KEY, JSON.stringify(saved));
                    }
                    loadSignatories();
                    signatorySelect.value = newName;
                    addSignatoryContainer.classList.add('hidden');
                    newSignatoryInput.value = '';
                }
            });

            document.querySelectorAll(".toggle-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const targetId = btn.dataset.target;
                    const targetEl = document.getElementById(targetId);
                    if (!targetEl) return;
                    const isNowHidden = targetEl.classList.toggle("hidden");
                    if (isNowHidden) {
                        btn.innerHTML = btn.innerHTML.replace("-", "+");
                    } else {
                        btn.innerHTML = btn.innerHTML.replace("+", "-");
                    }
                });
            });

            const dropdownBtn = document.getElementById("documents-dropdown-btn");
            const dropdownContent = document.getElementById("documents-dropdown-content");
            const dropdownIcon = document.getElementById("dropdown-icon");
            dropdownBtn?.addEventListener("click", () => {
                dropdownContent?.classList.toggle("hidden");
                dropdownIcon?.classList.toggle("rotate-180");
            });
            document.getElementById('purchases-dropdown-btn').addEventListener('click', () => {
                document.getElementById('purchases-dropdown-content').classList.toggle('hidden');
                document.getElementById('purchases-dropdown-icon').classList.toggle('rotate-180');
            });

            addItemBtn?.addEventListener("click", createItemRow);
            taxPercentageInput?.addEventListener("input", updateTotals);

            (function init() {
                const dateInput = document.getElementById("invoice-date");
                if (dateInput) dateInput.value = new Date().toISOString().slice(0, 10);
                const dueInput = document.getElementById("due-date");
                if (dueInput) {
                    const due = new Date();
                    due.setDate(due.getDate() + 30); // Default due date = 7 days after invoice date
                    dueInput.value = due.toISOString().slice(0, 10);
                }

                const timeInput = document.getElementById("invoice-time");
                if (timeInput) timeInput.value = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

                createItemRow();

                loadCompany();
                loadClients();
                loadSignatories();
                loadSignatureImage();
                loadSavedPrefix();
            })();

            if (saveContinueBtn) {
                saveContinueBtn.addEventListener("click", async () => {
                    // simulate form submit
                    invoiceForm?.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
                });
            }
            window.INV_updateTotals = updateTotals;
            window.INV_createItemRow = createItemRow;
            window.INV_collectInvoiceData = collectInvoiceData;

        })();
    </script>
    <script>
        (async function populateFromSalesOrderIfRequested() {
            const API_BASE_URL = "http://Aixains-Mac-mini.local:8000/api";

            function getQueryParam(name) {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            }

            // Helper function to get auth headers
            function getAuthHeaders() {
                const token = localStorage.getItem('token');
                if (token) {
                    return { 'Authorization': `Bearer ${token}` };
                }
                return null;
            }

            // Create our own fetch wrapper (same logic as safeFetch in the page)
            async function fetchWithAuth(url, opts = {}) {
                opts.headers = opts.headers || {};
                const authHeaders = getAuthHeaders();

                if (!authHeaders) {
                    alert("Authentication token not found. Please log in.");
                    window.location.href = '../../index.html';
                    throw new Error("Authentication token not found.");
                }

                opts.headers = { ...opts.headers, ...authHeaders };

                if (opts.body && typeof opts.body === 'string' && !opts.headers['Content-Type']) {
                    opts.headers['Content-Type'] = 'application/json';
                }

                const response = await fetch(url, opts);

                if (!response.ok) {
                    if (response.status === 401) {
                        alert("Authentication error or session expired. Please log in again.");
                        localStorage.removeItem('token');
                        localStorage.removeItem('userId');
                        window.location.href = '../../index.html';
                        throw new Error("Session expired");
                    }
                    const errorText = await response.text().catch(() => response.statusText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const contentType = response.headers.get('content-type') || '';
                return contentType.includes('application/json') ? response.json() : response.text();
            }

            async function fetchSalesOrderById(soId) {
                const url = `${API_BASE_URL}/sales-order/${encodeURIComponent(soId)}`;
                console.log('Fetching Sales Order from:', url);

                try {
                    const json = await fetchWithAuth(url, { method: 'GET' });
                    console.log('Raw API Response:', json);

                    // Handle different response structures
                    if (Array.isArray(json) && json.length) return json[0];
                    if (json && json.sales_order) return json.sales_order;
                    if (json && json._id) return json;

                    return json;
                } catch (err) {
                    console.error('Fetch error:', err);
                    throw err;
                }
            }

            function setClientInDropdown(clientData) {
                const billedSelect = document.getElementById('billed-to-select');
                if (!billedSelect) {
                    console.warn('Client dropdown not found');
                    return;
                }

                let clientId = clientData?._id || clientData?.id;
                let clientName = clientData?.client_name || clientData?.name;

                console.log('Setting client:', { clientId, clientName });

                if (!clientId || !clientName) {
                    console.warn('Missing client ID or name');
                    return;
                }

                // Check if option exists
                let existingOption = Array.from(billedSelect.options).find(opt =>
                    opt.value === clientId || opt.textContent === clientName
                );

                if (!existingOption) {
                    const newOption = document.createElement('option');
                    newOption.value = clientId;
                    newOption.textContent = clientName;
                    billedSelect.appendChild(newOption);
                    console.log('Created new option for client');
                }

                billedSelect.value = clientId;
                console.log('Client selected in dropdown');
            }

            function populateItemRow(row, itemData) {
                const nameEl = row.querySelector('.item-name');
                const qtyEl = row.querySelector('.quantity');
                const rateEl = row.querySelector('.rate');
                const descEl = row.querySelector('.description');
                const amtEl = row.querySelector('.amount');

                if (nameEl) nameEl.value = itemData.item_name || itemData.name || '';
                if (qtyEl) qtyEl.value = itemData.quantity || 1;
                if (rateEl) rateEl.value = itemData.rate || itemData.unit_price || 0;
                if (descEl) descEl.value = itemData.description || '';

                const qty = parseFloat(qtyEl?.value || 0);
                const rate = parseFloat(rateEl?.value || 0);
                const amount = qty * rate;

                if (amtEl) amtEl.textContent = `₹${amount.toFixed(2)}`;

                console.log('Populated item:', itemData.item_name, '- Qty:', qty, 'Rate:', rate, 'Amount:', amount);
            }

            // Wait for page functions to be available
            function waitForPageReady() {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const maxAttempts = 20; // 2 seconds max

                    const checkReady = setInterval(() => {
                        attempts++;

                        // Check if required elements and functions exist
                        const itemsContainer = document.getElementById('items-container');
                        const billedSelect = document.getElementById('billed-to-select');
                        const hasCreateItemRow = typeof window.INV_createItemRow === 'function' ||
                            typeof createItemRow === 'function';

                        if (itemsContainer && billedSelect && hasCreateItemRow) {
                            clearInterval(checkReady);
                            console.log('✅ Page ready for auto-fill');
                            resolve(true);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkReady);
                            console.warn('⚠️ Page readiness timeout');
                            resolve(false);
                        }
                    }, 100);
                });
            }

            // ===== MAIN EXECUTION =====
            const soId = getQueryParam('fromSalesOrder');

            if (!soId) {
                console.log('No fromSalesOrder parameter found');
                return;
            }

            console.log('🔄 Converting Sales Order to Invoice, ID:', soId);

            try {
                // Wait for page to be ready
                const isReady = await waitForPageReady();
                if (!isReady) {
                    throw new Error('Page initialization timeout');
                }

                // Fetch the sales order
                const salesOrder = await fetchSalesOrderById(soId);

                if (!salesOrder) {
                    throw new Error('Sales Order not found or empty response');
                }

                console.log('✅ Sales Order loaded:', salesOrder);

                // 1. SET CLIENT
                if (salesOrder.to) {
                    setClientInDropdown(salesOrder.to);
                } else if (salesOrder.to_client_id) {
                    const billedSelect = document.getElementById('billed-to-select');
                    if (billedSelect) billedSelect.value = salesOrder.to_client_id;
                }

                // 2. CLEAR EXISTING ITEMS
                const itemsContainer = document.getElementById('items-container');
                if (itemsContainer) {
                    itemsContainer.innerHTML = '';
                    console.log('Cleared existing items');
                }

                // 3. ADD ITEMS FROM SALES ORDER
                const items = salesOrder.items || salesOrder.line_items || [];
                console.log(`Adding ${items.length} items...`);

                items.forEach((item, index) => {
                    // Create a new row
                    if (typeof window.INV_createItemRow === 'function') {
                        window.INV_createItemRow();
                    } else if (typeof createItemRow === 'function') {
                        createItemRow();
                    }

                    // Get the last added row
                    const rows = document.querySelectorAll('.item-row');
                    const newRow = rows[rows.length - 1];

                    if (newRow) {
                        populateItemRow(newRow, item);
                    }
                });

                // 4. SET TAX PERCENTAGE
                const taxEl = document.getElementById('tax-percentage');
                if (taxEl) {
                    const taxPercent = salesOrder.tax_percentage || salesOrder.tax_rate || 0;
                    taxEl.value = taxPercent;
                    console.log('Tax percentage set to:', taxPercent);
                }

                // 5. UPDATE TOTALS
                if (typeof window.INV_updateTotals === 'function') {
                    window.INV_updateTotals();
                } else if (typeof updateTotals === 'function') {
                    updateTotals();
                }
                console.log('Totals updated');

                // 6. SET TERMS & CONDITIONS
                if (salesOrder.terms_and_condition || salesOrder.terms) {
                    const termsInput = document.getElementById('terms-input');
                    const termsSection = document.getElementById('terms');

                    if (termsInput) {
                        termsInput.value = salesOrder.terms_and_condition || salesOrder.terms;
                        if (termsSection) termsSection.classList.remove('hidden');
                    }
                }

                // 7. SET NOTES
                if (salesOrder.notes || salesOrder.note) {
                    const notesInput = document.getElementById('notes-input');
                    const notesSection = document.getElementById('notes');

                    if (notesInput) {
                        notesInput.value = salesOrder.notes || salesOrder.note;
                        if (notesSection) notesSection.classList.remove('hidden');
                    }
                }

                // 8. SET SIGNATURE
                if (salesOrder.signatory) {
                    const signatorySelect = document.getElementById('signatory-select');
                    const signatureSection = document.getElementById('signature-box');

                    if (signatorySelect && signatureSection) {
                        let optExists = Array.from(signatorySelect.options).find(opt =>
                            opt.value === salesOrder.signatory
                        );

                        if (optExists) {
                            signatorySelect.value = salesOrder.signatory;
                            signatureSection.classList.remove('hidden');
                        }
                    }
                }

                console.log('✅ Sales Order successfully converted to Invoice!');

                // Show success message
                const alertContainer = document.getElementById('alert-container');
                if (alertContainer) {
                    alertContainer.innerHTML = '<div class="alert alert-success">✅ Sales Order data loaded successfully! Review and save as invoice.</div>';
                    setTimeout(() => { alertContainer.innerHTML = ''; }, 5000);
                }

                // Log final state
                console.log('📊 Final Invoice State:', {
                    client: document.getElementById('billed-to-select')?.value,
                    itemCount: document.querySelectorAll('.item-row').length,
                    tax: document.getElementById('tax-percentage')?.value,
                    subtotal: document.getElementById('sub_total')?.textContent,
                    total: document.getElementById('total')?.textContent
                });

            } catch (err) {
                console.error('❌ Error loading Sales Order:', err);

                const alertContainer = document.getElementById('alert-container');
                if (alertContainer) {
                    alertContainer.innerHTML = `<div class="alert alert-error">❌ Error: ${err.message}</div>`;
                }
            }
        })();
    </script>
</body>

</html>